var rt=class{constructor(){this.events=[],this.activePencil=null,this.activeFingers={}}did(t,s,i){return this.events.find(o=>o.type===t&&o.state===s&&(i==null||o.id===i))}didAll(t,s,i){return this.events.filter(o=>o.type===t&&o.state===s&&(i==null||o.id===i))}didLast(t,s,i){return this.events.findLast(o=>o.type===t&&o.state===s&&(i==null||o.id===i))}},I=new rt;window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([s,i])=>{i.forEach(o=>{I.events.push({type:o.type==="pencil"?"pencil":"finger",state:e,id:s,position:{x:o.x,y:o.y},timestamp:o.timestamp}),o.type==="pencil"?I.activePencil=e!=="ended"?{x:o.x,y:o.y}:null:e!=="ended"?I.activeFingers[s]={x:o.x,y:o.y}:delete I.activeFingers[s]})})};var ht=null;function lt(){ht(I),I.events=[],window.requestAnimationFrame(lt)}function G(e){ht=e,window.requestAnimationFrame(lt)}var $t=Math.PI*2,dt=e=>Number.EPSILON>Math.abs(e);var at=(e,t)=>(p=1/t,Math.round(e*p)/p);var n=(e=0,t=0)=>({x:e,y:t}),h=n;n.clone=e=>n(e.x,e.y);n.fromRectXY=e=>n(e.x,e.y);n.fromRectWH=e=>n(e.w,e.h);n.fromRectRB=e=>n(e.x+e.w,e.y+e.h);n.of=e=>n(e,e);n.random=(e=1)=>n.Smul(e,n.complement(n.Smul(2,n(Math.random(),Math.random()))));n.toA=e=>[e.x,e.y];n.polar=(e,t)=>n(t*Math.cos(e),t*Math.sin(e));n.x=Object.freeze(n(1));n.y=Object.freeze(n(0,1));n.zero=Object.freeze(n());n.map=(e,t)=>n(e(t.x),e(t.y));n.map2=(e,t,s)=>n(e(t.x,s.x),e(t.y,s.y));n.reduce=(e,t)=>e(t.x,t.y);n.cross=(e,t)=>e.x*t.y-e.y*t.x;n.project=(e,t)=>n.mulS(t,n.dot(e,t)/n.len2(t));n.reject=(e,t)=>n.sub(e,n.project(e,t));n.scalarProjection=(e,t,s)=>{let i=n.sub(e,t),o=n.normalize(n.sub(s,t)),r=n.mulS(o,n.dot(i,o));return n.add(t,r)};n.add=(e,t)=>n(e.x+t.x,e.y+t.y);n.div=(e,t)=>n(e.x/t.x,e.y/t.y);n.mul=(e,t)=>n(e.x*t.x,e.y*t.y);n.sub=(e,t)=>n(e.x-t.x,e.y-t.y);n.addS=(e,t)=>n.add(e,n.of(t));n.divS=(e,t)=>n.div(e,n.of(t));n.mulS=(e,t)=>n.mul(e,n.of(t));n.subS=(e,t)=>n.sub(e,n.of(t));n.Sadd=(e,t)=>n.add(n.of(e),t);n.Sdiv=(e,t)=>n.div(n.of(e),t);n.Smul=(e,t)=>n.mul(n.of(e),t);n.Ssub=(e,t)=>n.sub(n.of(e),t);n.dist=(e,t)=>n.len(n.sub(e,t));n.dist2=(e,t)=>n.len2(n.sub(e,t));n.dot=(e,t)=>e.x*t.x+e.y*t.y;n.equal=(e,t)=>dt(n.dist2(e,t));n.len2=e=>n.dot(e,e);n.len=e=>Math.sqrt(n.dot(e,e));n.ceil=e=>n.map(Math.ceil,e);n.floor=e=>n.map(Math.floor,e);n.round=e=>n.map(Math.round,e);n.roundTo=(e,t)=>n.map2(at,e,n.of(t));n.complement=e=>n.Ssub(1,e);n.half=e=>n.divS(e,2);n.normalize=e=>n.divS(e,n.len(e));n.recip=e=>n.Sdiv(1,e);n.renormalize=(e,t,s,i,o)=>n.add(n.mul(n.div(n.sub(e,t),n.sub(s,t)),n.sub(o,i)),i);n.avg=(e,t)=>n.half(n.add(e,t));n.lerp=(e,t,s)=>n.add(e,n.Smul(s,n.sub(t,e)));n.max=(e,t)=>n.map2(Math.max,e,t);n.min=(e,t)=>n.map2(Math.min,e,t);n.abs=e=>n.map(Math.abs,e);n.invert=e=>n(-e.x,-e.y);n.invertX=e=>n(-e.x,e.y);n.invertY=e=>n(e.x,-e.y);n.rotate90CW=e=>n(e.y,-e.x);n.rotate90CCW=e=>n(-e.y,e.x);n.rotate=(e,t)=>n(e.x*Math.cos(t)-e.y*Math.sin(t),e.x*Math.sin(t)+e.y*Math.cos(t));n.rotateAround=(e,t,s)=>{let i=n.sub(e,t),o=n.rotate(i,s);return n.add(o,t)};n.angle=e=>Math.atan2(e.y,e.x);n.angleBetween=(e,t)=>{let s=n.dot(e,t),i=n.len(e),o=n.len(t);return Math.acos(s/(i*o))*180/Math.PI};n.angleBetweenClockwise=(e,t)=>{let s=n.dot(e,t),i=n.cross(e,t),r=Math.atan2(s,i)*(180/Math.PI);return r<0&&(r=360+r),r};n.update=(e,t)=>{e.x=t.x,e.y=t.y};var Lt=0;function S(){return Lt++}var N=class{constructor(t,s,i,o){this.id=S(),this.a=s,this.b=i,this.c=o,this.dirty=!0,this.selected=!1,this.radius=h.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let r={d:this.path,"stroke-width":1,stroke:"black",fill:"none"};this.elements={normal:t.addElement("path",r),selected:t.addElement("path",{...r,"stroke-width":7,stroke:"none"})}}updatePath(){this.path=`M ${this.a.position.x} ${this.a.position.y} A ${this.radius}  ${this.radius} ${this.xAxisRotation} ${this.isLargeArc} ${this.clockwise} ${this.b.position.x} ${this.b.position.y}`}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty||this.c.dirty){this.radius=h.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let s={d:this.path};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},ct=N;var U=class{constructor(t,s,i){this.id=S(),this.a=s,this.b=i,this.dirty=!0,this.selected=!1;let o={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y,"stroke-width":1,stroke:"black"};this.elements={normal:t.addElement("line",o),selected:t.addElement("line",{...o,"stroke-width":7,stroke:"none"})}}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty){let s={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},pt=U;var q=class{constructor(t=document.body){this.root=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.updateElement(this.root,{xmlns:"http://www.w3.org/2000/svg",width:window.innerWidth,height:window.innerHeight}),t.appendChild(this.root)}addElement(t,s){let i=document.createElementNS("http://www.w3.org/2000/svg",t);return this.updateElement(i,s),this.root.appendChild(i),i}updateElement(t,s){Object.entries(s).forEach(([i,o])=>t.setAttribute(i,o))}},ft=q;function v(e){return e.map((s,i)=>`${i===0?"M":"L"} ${s.x} ${s.y}`).join(" ")}var z=class{constructor(t,s){this.id=S(),this.points=s,this.dirty=!0,this.selected=!1;let i=v(this.points);this.elements={normal:t.addElement("path",{d:i,stroke:"darkgrey","stroke-width":2,fill:"none"}),selected:t.addElement("path",{d:i,"stroke-width":7,stroke:"none",fill:"none"})}}getFirstPoint(){return this.points[0]}getLastPoint(){return this.points[this.points.length-1]}move(t){this.dirty=!0,this.position=t}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(!this.dirty)return;let s=v(this.points);t.updateElement(this.elements.normal,{d:s}),t.updateElement(this.elements.selected,{d:s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}},ut=z;var C=class{constructor(t,s){this.id=S(),this.position=s,this.dirty=!0,this.selected=!1,this.elements={normal:t.addElement("circle",{cx:0,cy:0,r:3,fill:"black"}),selected:t.addElement("circle",{cx:0,cy:0,r:7,fill:"none"})}}setPosition(t){this.dirty=!0,this.position=t}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}remove(){this.elements.normal.remove(),this.elements.selected.remove()}render(t){this.dirty&&(t.updateElement(this.elements.normal,{transform:`translate(${this.position.x} ${this.position.y})`}),t.updateElement(this.elements.selected,{transform:`translate(${this.position.x} ${this.position.y})`,fill:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1)}},gt=C;var B=class{constructor(t,s){this.id=S(),this.firstPosition=s,this.position=s,this.morphVector=h(0,0),this.angle=0,this.dirty=!0,this.selected=!1,this.elements={normal:t.addElement("circle",{cx:0,cy:0,r:30,fill:"none",stroke:"grey"}),rotationLine:t.addElement("line",{x1:0,y1:0,x2:0,y2:0,stroke:"grey"})}}setPosition(t){this.dirty=!0,this.position=t,this.morphVector=h.sub(this.position,this.firstPosition)}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}remove(){this.elements.normal.remove()}render(t){if(!this.dirty)return;t.updateElement(this.elements.normal,{transform:`translate(${this.position.x} ${this.position.y})`});let s=h.add(this.position,h.polar(this.angle,60));t.updateElement(this.elements.rotationLine,{x1:this.position.x,y1:this.position.y,x2:s.x,y2:s.y}),this.dirty=!1}},mt=B;var H=class{constructor(){this.strokes=[],this.connections=[],this.loops=[],this.elements=[],this.loop_elements=[]}addStroke(t){let s=[t.getFirstPoint(),t.getLastPoint()];for(let a of this.strokes){for(let c of s){let u=yt(c,a.points);u.dist<20&&this.connections.push({type:"point",position:c,a:t,b:a,...u})}let f=[a.getFirstPoint(),a.getLastPoint()];for(let c of f){let u=yt(c,t.points);u.dist<20&&this.connections.push({type:"point",position:c,a,b:t,...u})}}console.log("-- search");let i=[t],o=new Set;o.add(t);let r=new Map,l=null,d=null;t:for(;i.length>0;){let a=i.shift(),f=this.connections.filter(c=>c.a===a&&r.get(a)!==c.b).map(c=>c.b);for(let c of f){if(o.has(c)){console.log("found loop by meeting in the middle"),l=c,d=a;break t}o.add(c),r.set(c,a),i.push(c)}}if(l!==null){let a=l,f=[l];for(;a!=t;)a=r.get(a),f.push(a);for(a=d,f.unshift(d);a!=t;)a=r.get(a),f.unshift(a);let c=[];for(let u=0;u<f.length-1;u++){let g=f[u],m=f[u+1],x=this.connections.find(P=>P.a==g&&P.b==m);c.push(x.position)}this.loops.push({strokes:f,points:c})}this.strokes.push(t),this.dirty=!0}render(t){!this.dirty||(this.dirty=!1)}},xt=H;function yt(e,t){let s=h.dist(e,t[0]),i=0;for(let o=0;o<t.length;o++){let r=h.dist(e,t[o]);r<s&&(s=r,i=o)}return{dist:s,index:i}}var _=class{constructor(t){this.svg=t,this.points=[],this.morphPoints=[],this.lineSegments=[],this.freehandStrokes=[],this.strokeGraph=new xt}addPoint(t){let s=new gt(this.svg,t);return this.points.push(s),s}addLineSegment(t,s){let i=new pt(this.svg,t,s);return this.lineSegments.push(i),i}addArcSegment(t,s,i){let o=new ct(this.svg,t,s,i);return this.lineSegments.push(o),o}addMorphPoint(t){let s=new mt(this.svg,t);return this.morphPoints.push(s),s}addFreehandStroke(t){let s=new ut(this.svg,t);return this.freehandStrokes.push(s),this.strokeGraph.addStroke(s),s}findPointNear(t,s=20){let i=null,o=s;for(let r of this.points){let l=h.dist(r.position,t);l<o&&(o=l,i=r)}return i}findMorphPointNear(t,s=20){let i=null,o=s;for(let r of this.morphPoints){let l=h.dist(r.position,t);l<o&&(o=l,i=r)}return i}findFreehandStrokeNear(t,s=20){let i=null,o=s;for(let r of this.freehandStrokes)for(let l of r.points){let d=h.dist(l,t);d<o&&(o=d,i=r)}return i}mergePoint(t){let s=new Set(this.points.filter(i=>i!==t&&h.dist(i.position,t.position)===0));if(s.size!==0){for(let i of this.lineSegments)s.has(i.a)&&(i.a=t),s.has(i.b)&&(i.b=t),s.has(i.c)&&(i.c=t);for(let i of s)i.remove();this.points=this.points.filter(i=>!s.has(i))}}pointsReachableFrom(t){let s=new Set(t);for(;;){let i=s.size;for(let o of this.lineSegments)s.has(o.a)&&s.add(o.b),s.has(o.b)&&s.add(o.a);if(s.size===i)break}return s}updateMorphs(){if(!(this.morphPoints.length<2)){for(let t=0;t<this.morphPoints.length;t++){let s=this.morphPoints[t],i=0,o=0;if(t<this.morphPoints.length-1){let r=h.angle(h.sub(this.morphPoints[t+1].firstPosition,this.morphPoints[t].firstPosition));i+=h.angle(h.sub(this.morphPoints[t+1].position,this.morphPoints[t].position))-r,o+=1}if(t>0){let r=h.angle(h.sub(this.morphPoints[t-1].firstPosition,this.morphPoints[t].firstPosition));i+=h.angle(h.sub(this.morphPoints[t-1].position,this.morphPoints[t].position))-r,o+=1}o==2&&(i=i/2),this.morphPoints[t].angle=i,this.morphPoints[t].dirty=!0}this.freehandStrokes.forEach(t=>t.applyMorphs(this.morphPoints))}}render(t){let s=i=>i.render(t);this.lineSegments.forEach(s),this.freehandStrokes.forEach(s),this.points.forEach(s),this.morphPoints.forEach(s),this.strokeGraph.render(t)}},Pt=_;var ge=Math.PI/180,me=180/Math.PI;var W=class{constructor(t){this.page=t,this.activeSnaps=[],this.snapSvgElementById=new Map,this.dirty=!1}snapPositions(t){let s=[],i=new Map,o=this.page.points.filter(d=>!t.has(d)),r=Array.from(t.keys()),l=this.page.pointsReachableFrom(r);for(let[d,a]of t){if(s.some(u=>u.snapPoint===d)){i.set(d,a);continue}let f=[];for(let u of o){let g=h.sub(u.position,a);if(h.len(g)<10){f.push(g),s.push(new bt(d,u));break}}if(f.length===0){for(let u of l){if(u===d)continue;let g=u.position.x-a.x;if(Math.abs(g)<10){let m=h(g,0);f.push(m),s.push(new Z(d,u));break}}for(let u of l){if(u===d)continue;let g=u.position.y-a.y;if(Math.abs(g)<10){let m=h(0,g);f.push(m),s.push(new Z(d,u));break}}}let c=f.reduce((u,g)=>h.add(u,g),a);i.set(d,c)}return this.setActiveSnaps(s),i}setActiveSnaps(t){this.activeSnaps=t,this.dirty=!0;let s=new Set(t.map(i=>i.id));for(let[i,o]of this.snapSvgElementById)s.has(i)||(o.remove(),this.snapSvgElementById.delete(i))}clear(){this.setActiveSnaps([])}render(t){if(!!this.dirty){for(let s of this.activeSnaps){let i=s.id,{shapeType:o,shapeData:r}=s.getShape(),l=this.snapSvgElementById.get(i);l==null?(l=t.addElement(o,{...r,fill:"none",stroke:"rgb(180, 134, 255)"}),this.snapSvgElementById.set(i,l)):t.updateElement(l,r)}this.dirty=!1}}},St=W,Q=class{constructor(t,s){this.point=t,this.snapPoint=s,this.id=`${t.id}.${s.id}.${this.constructor.name}`}getShape(){throw new Error("subclass responsibility!")}},bt=class extends Q{constructor(t,s){super(t,s)}getShape(){return{shapeType:"circle",shapeData:{cx:this.point.position.x,cy:this.point.position.y,r:7}}}},Z=class extends Q{constructor(t,s){super(t,s)}getShape(){return{shapeType:"line",shapeData:{x1:this.point.position.x,y1:this.point.position.y,x2:this.snapPoint.position.x,y2:this.snapPoint.position.y}}}};var J=class{constructor(t){this.selected=0,this.dirty=!1,this.buttons=[t.addElement("circle",{cx:30,cy:30,r:20,fill:"black"}),t.addElement("circle",{cx:30,cy:80,r:20,fill:"lightgrey"}),t.addElement("circle",{cx:30,cy:130,r:20,fill:"lightgrey"})]}update(t){let s=t.did("finger","began");if(!s)return;let i=[30,80,130].findIndex(o=>h.dist(h(30,o),s.position)<20);i!==-1&&(this.selected=i,this.dirty=!0)}render(t){this.dirty&&(console.log("update"),this.buttons.forEach((s,i)=>t.updateElement(s,{fill:this.selected===i?"black":"lightgrey"})),this.dirty=!1)}},Mt=J;function E(e,t,s,i,o=!0){return{center:e,radius:t,startAngle:s,endAngle:i,clockwise:o}}var M=E;E.len=e=>{let{radius:t,startAngle:s,endAngle:i}=e;return t*Math.abs(i-s)};E.distToPointCircle=(e,t)=>{let s=h.dist(e.center,t);return Math.abs(s-e.radius)};E.spreadPointsAlong=(e,t)=>{let s=[],o=E.directedInnerAngle(e)/(t-1);for(let r=0;r<t;r++){let l=e.startAngle+o*r,d=h(e.radius*Math.cos(l),e.radius*Math.sin(l));s.push(h.add(e.center,d))}return s};E.directedInnerAngle=e=>{let t=e.endAngle-e.startAngle;return e.clockwise&&t<0?2*Math.PI-Math.abs(t):!e.clockwise&&t>0?-2*Math.PI+Math.abs(t):t};E.points=e=>{console.log(e);let t=h.add(e.center,h.polar(e.startAngle,e.radius)),s=h.add(e.center,h.polar(e.endAngle,e.radius));return{start:t,end:s}};var y=(e,t)=>({a:e,b:t}),A=y;y.len=e=>h.dist(e.a,e.b);y.directionVec=e=>h.normalize(h.sub(e.b,e.a));y.intersect=(e,t)=>{let{a:s,b:i}=e,{a:o,b:r}=t,l=i.x-s.x,d=i.y-s.y,a=r.x-o.x,f=r.y-o.y,c=l*f-d*a;if(c===0)return null;let u=s.x-o.x,g=s.y-o.y,m=(u*f-g*a)/c,x=(l*g-d*u)/c;if(m>=0&&m<=1&&x>=0&&x<=1){let P=s.x+m*l,F=s.y+m*d;return{x:P,y:F}}return null};y.intersectAnywhere=(e,t)=>{let{a:s,b:i}=e,{a:o,b:r}=t,l=i.x-s.x,d=i.y-s.y,a=r.x-o.x,f=r.y-o.y,c=l*f-d*a;if(c===0)return null;let u=s.x-o.x,g=s.y-o.y,m=(u*f-g*a)/c,x=(l*g-d*u)/c,P=s.x+m*l,F=s.y+m*d;return{x:P,y:F}};y.getYforX=(e,t)=>{let{a:s,b:i}=e,{x:o,y:r}=s,{x:l,y:d}=i;return(d-r)/(l-o)*(t-o)+r};y.getXforY=(e,t)=>{let{a:s,b:i}=e,{x:o,y:r}=s,{x:l,y:d}=i,a=(d-r)/(l-o);return(t-r)/a+o};y.distToPoint=(e,t)=>h.dist(t,y.closestPoint(e,t));y.closestPoint=(e,t,s=!0)=>{let{a:i,b:o}=e,r=h.sub(o,i),l=h.sub(t,i),d=h.dot(l,r)/h.dot(r,r);return s&&d<=0?i:s&&d>=1?o:h.add(i,h.mulS(r,d))};y.spreadPointsAlong=(e,t)=>{let s=y.len(e)/t,i=h.mulS(y.directionVec(e),s),o=[];for(let r=0;r<t;r++)o.push(h.add(e.a,h.mulS(i,r)));return o};var D={},O=D;D.line=e=>{if(e.length===0)return null;let t=A(h.clone(e[0]),h.clone(e[e.length-1])),s=0;for(let o=1;o<e.length-1;o++)s+=A.distToPoint(t,e[o]);let i=A.len(t);return{type:"line",line:t,fitness:i===0?1:s/i,length:i}};D.arc=e=>{if(e.length<3)return null;let t=D.innerTriangle(e),[s,i,o]=t;if(!i)return null;let{x:r,y:l}=s,{x:d,y:a}=i,{x:f,y:c}=o,u=2*(r*(a-c)+d*(c-l)+f*(l-a)),g=((r*r+l*l)*(a-c)+(d*d+a*a)*(c-l)+(f*f+c*c)*(l-a))/u,m=((r*r+l*l)*(f-d)+(d*d+a*a)*(r-f)+(f*f+c*c)*(d-r))/u,x=Math.sqrt((r-g)*(r-g)+(l-m)*(l-m)),P=Math.atan2(l-m,r-g),F=Math.atan2(c-m,f-g),T=h.sub(s,i),R=h.sub(i,o),b=h.cross(T,R)>0,j=M(h(g,m),x,P,F,b),V=M.len(j),$=0;for(let X of e)$+=M.distToPointCircle(j,X);return{type:"arc",arc:j,fitness:$/V,length:V}};D.innerTriangle=e=>{let t=e[0],s=e[e.length-1],i=-1,o=-1;for(let r=0;r<e.length;r++){let l=e[r],d=A.distToPoint(A(t,s),l);d>i&&(i=d,o=r)}return[t,e[o],s]};D.circle=e=>{if(e.length<3)return null;let t=e.length,s=0,i=0,o=0,r=0,l=0,d=0,a=0,f=0,c=0;for(let Y of e){let{x:w,y:k}=Y;s+=w,i+=k,o+=w*w,r+=k*k,l+=w*k,d+=w*w*w,a+=k*k*k,f+=w*k*k,c+=w*w*k}let u=t*o-s*s,g=t*l-s*i,m=t*d+t*f-(o+r)*s,x=t*r-i*i,P=t*c+t*a-(o+r)*i,F=(P*g-m*x)/(u*x-g*g),T=(P*u-m*g)/(g*g-x*u),R=-(F*s+T*i+o+r)/t,b=h(-F/2,-T/2),j=Math.sqrt(b.x*b.x+b.y*b.y-R),V=Math.atan2(e[0].y-b.y,e[0].x-b.x),$=Math.atan2(e[e.length-1].y-b.y,e[e.length-1].x-b.x),X=h.sub(e[0],e[1]),jt=h.sub(e[1],e[2]),It=h.cross(X,jt)>0,nt={center:b,radius:j,startAngle:V,endAngle:$,clockwise:It},ot=0;for(let Y of e)ot+=M.distToPointCircle(nt,Y);let Dt=2*Math.PI*j;return{type:"circle",circle:nt,fitness:ot/Dt}};var K=class{constructor(t,s){this.page=t,this.snaps=s,this.element=null,this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.speed=0,this.maxSpeed=0,this.previousPosition=null,this.mode="unknown",this.fit=null,this.fixedStroke=null}update(t){let s=t.did("pencil","began");if(s&&(this.inputPoints=[s.position],this.renderPoints=[h.clone(s.position)],this.speed=0,this.maxSpeed=0,this.previousPosition=s.position,this.mode="unknown",this.dirty=!0),t.didAll("pencil","moved").forEach(r=>{let l=h.dist(this.previousPosition,r.position),d=.05;if(this.speed=d*l+(1-d)*this.speed,this.maxSpeed=Math.max(this.maxSpeed,this.speed),this.previousPosition=r.position,this.mode!=="fixed")this.inputPoints.push(r.position),this.renderPoints.push(h.clone(r.position)),this.mode==="guess"&&this.doFit();else{let a=r.position,f=new Map;f.set(this.fixedStroke.a,this.fixedStroke.a.position),f.set(this.fixedStroke.b,a);let c=this.snaps.snapPositions(f);this.fixedStroke.a.setPosition(c.get(this.fixedStroke.a)),this.fixedStroke.b.setPosition(c.get(this.fixedStroke.b))}this.mode==="unknown"&&this.inputPoints.length>100&&(this.mode="guess"),this.mode!=="fixed"&&this.inputPoints.length>10&&this.speed<Math.min(1,this.maxSpeed)&&(this.doFit(),this.createStroke(),this.clearGuess(),this.mode="fixed"),this.dirty=!0}),t.did("pencil","ended")&&(this.mode!=="fixed"&&(this.doFit(),this.createStroke(),this.clearGuess()),this.page.mergePoint(this.fixedStroke.a),this.page.mergePoint(this.fixedStroke.b),this.fixedStroke=null,this.mode="unknown",this.snaps.clear()),this.idealPoints&&this.renderPoints.length===this.idealPoints.length)for(let r=0;r<this.idealPoints.length;r++)this.renderPoints[r]=h.lerp(this.idealPoints[r],this.renderPoints[r],.8)}doFit(){let t=O.line(this.inputPoints),s=O.arc(this.inputPoints),i=O.circle(this.inputPoints);this.fit=t,s!=null&&Math.abs(M.directedInnerAngle(s.arc))>.4*Math.PI&&(t==null||s.fitness<t.fitness)&&(this.fit=s,i!=null&&Math.abs(M.directedInnerAngle(s.arc))>1.5*Math.PI&&i.circle.radius<500&&i.fitness<s.fitness&&(this.fit=i)),this.fit!=null&&this.updateIdeal()}createStroke(){if(this.fit.type==="line"){let t=this.page.addPoint(this.fit.line.a),s=this.page.addPoint(this.fit.line.b),i=this.page.addLineSegment(t,s);this.fixedStroke=i}else if(this.fit.type==="arc"){let{start:t,end:s}=M.points(this.fit.arc),i=this.page.addPoint(t),o=this.page.addPoint(s),r=this.page.addPoint(this.fit.arc.center),l=this.page.addArcSegment(i,o,r);this.fixedStroke=l}}clearGuess(){this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.element.remove(),this.element=null}updateIdeal(){this.fit.type==="line"?this.idealPoints=A.spreadPointsAlong(this.fit.line,this.inputPoints.length):this.fit.type==="arc"?this.idealPoints=M.spreadPointsAlong(this.fit.arc,this.inputPoints.length):this.fit.type==="circle"&&(this.idealPoints=M.spreadPointsAlong(this.fit.circle,this.inputPoints.length))}render(t){if(!!this.dirty){if(this.renderPoints){this.element||(this.element=t.addElement("path",{d:"",stroke:"black",fill:"none"}));let s=v(this.renderPoints);t.updateElement(this.element,{d:s})}this.dirty=!1}}},wt=K;var tt=class{constructor(t,s){this.page=t,this.points=null,this.element=s.addElement("path",{d:"",stroke:"darkgrey","stroke-width":2,fill:"none"}),this.dirty=!1}update(t){let s=t.did("pencil","began");if(s!=null&&this.startStroke(s.position),this.points==null)return;t.didAll("pencil","moved").forEach(r=>this.extendStroke(r.position)),t.did("pencil","ended")!=null&&this.endStroke()}startStroke(t){this.points=[t],this.dirty=!0}extendStroke(t){this.points.push(t),this.dirty=!0}endStroke(){this.page.addFreehandStroke(this.points),this.points=null,this.dirty=!0}render(t){if(!this.dirty)return;let s=this.points==null?"":v(this.points);t.updateElement(this.element,{d:s}),this.dirty=!1}},kt=tt;var et=class{constructor(t,s){this.page=t,this.svg=s,this.points=[],this.element=null}update(t){let s=t.did("pencil","began");s&&(this.points=[s.position]);let i=t.did("pencil","moved");i&&this.points.push(i.position);let o=t.did("pencil","ended")}render(t){}},vt=et;function L(e){return e}L.isPointInside=(e,t)=>{let s=t.x,i=t.y,o=!1;for(let r=0,l=e.length-1;r<e.length;l=r++){let d=e[r].x,a=e[r].y,f=e[l].x,c=e[l].y;a>i!=c>i&&s<(f-d)*(i-a)/(c-a)+d&&(o=!o)}return o};var st=class{constructor(t){this.page=t,this.strokes=new Set,this.finger=null,this.fingerMoved=null,this.holding=null,this.lastFingerDown=0,this.downPositions=new Map,this.selectPolygon=null,this.dirty=!1,this.polygon=null}update(t){let s=t.did("finger","began");if(s){setTimeout(o=>{this.finger&&!this.holding&&(!this.fingerMoved||h.dist(this.finger.position,this.fingerMoved.position)<20)&&(console.log("hold"),this.selectPolygon=[this.finger.position],this.dirty=!0)},500),this.lastFingerDown=s.timestamp,this.finger=s;let i=this.page.findFreehandStrokeNear(s.position);if(i)if(i==this.holding){let o=this.page.strokeGraph.loops.find(r=>r.strokes.find(l=>l==i));o&&o.strokes.forEach(r=>this.select(r))}else this.holding=i,this.select(i);else{this.holding=null;let o=this.page.strokeGraph.loops.find(r=>L.isPointInside(r.points,s.position));if(o){o.strokes.forEach(r=>this.select(r)),this.holding=o.strokes[0];for(let r of this.page.freehandStrokes)for(let l of r.points)if(L.isPointInside(o.points,l)){this.select(r);continue}}}}if(this.finger){let i=t.did("finger","moved",this.finger.id);if(i)if(this.fingerMoved=i,this.selectPolygon){let r=this.selectPolygon[this.selectPolygon.length-1];if(h.dist(r,i.position)>5){this.selectPolygon.push(i.position),this.dirty=!0,this.clearSelection();for(let l of this.page.freehandStrokes)for(let d of l.points)if(L.isPointInside(this.selectPolygon,d)){this.select(l),this.holding=l;continue}}}else{let r=h.sub(i.position,this.finger.position);for(let l of this.strokes){let d=this.downPositions.get(l);for(let a=0;a<l.points.length;a++)l.points[a]=h.add(d[a],r),l.dirty=!0}}let o=t.did("finger","ended",this.finger.id);o&&!this.holding&&(this.clearSelection(),this.finger=null,this.fingerMoved=null),o&&(this.selectPolygon=null,this.dirty=!0)}}select(t){this.strokes.add(t),t.select(),this.downPositions.set(t,t.points.map(s=>({...s})))}clearSelection(){for(let t of this.strokes)t.deselect();this.strokes=new Set,this.downPositions=new Map}render(t){if(!!this.dirty){if(!this.selectPolygon&&this.polygon&&(this.polygon.remove(),this.polygon=null),this.selectPolygon){let s=v(this.selectPolygon);this.polygon?t.updateElement(this.polygon,{d:s}):this.polygon=t.addElement("path",{d:s,stroke:"pink","stroke-width":2,fill:"rgba(255, 0, 0, 0.05)"})}this.dirty=!1}}},Ft=st;var it=class{constructor(){this.svg=new ft,this.page=new Pt(this.svg),this.snaps=new St(this.page),this.selection=new Ft(this.page),this.toolPicker=new Mt(this.svg),this.tools=[new kt(this.page,this.svg),new wt(this.page,this.snaps),new vt(this.page)]}update(t){this.toolPicker.update(t),this.tools[this.toolPicker.selected].update(t),this.selection.update(t)}render(){this.toolPicker.render(this.svg),this.tools[this.toolPicker.selected].render(this.svg),this.snaps.render(this.svg),this.page.render(this.svg),this.selection.render(this.svg)}},At=it;var Et=new At;G(e=>{Et.update(e),Et.render()});
//# sourceMappingURL=main.js.map
