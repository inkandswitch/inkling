var _={pencil:[],touches:{}};window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([s,o])=>{o.forEach(n=>{n.type==="pencil"?_.pencil.push({type:e,x:n.x,y:n.y}):(_.touches[s]||(_.touches[s]=[]),_.touches[s].push({type:e,x:n.x,y:n.y,timestamp:n.timestamp}))})})};var R=null;function T(){R(_),_.pencil=[],_.touches={},window.requestAnimationFrame(T)}var z=e=>{R=e,window.requestAnimationFrame(T)};var D=class{constructor(t,s){this.canvas=document.createElement("canvas"),t.appendChild(this.canvas);let o=window.devicePixelRatio,n=t.getBoundingClientRect();this.canvas.width=n.width*o,this.canvas.height=n.height*o,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(o,o),this.callback=s,s(this.ctx)}render(){this.callback(this.ctx)}},V=D;var K=Math.PI*2,q=e=>Number.EPSILON>Math.abs(e);var C=(e,t)=>(p=1/t,Math.round(e*p)/p);var r=(e=0,t=0)=>({x:e,y:t}),a=r;r.clone=e=>r(e.x,e.y);r.fromRectXY=e=>r(e.x,e.y);r.fromRectWH=e=>r(e.w,e.h);r.fromRectRB=e=>r(e.x+e.w,e.y+e.h);r.of=e=>r(e,e);r.random=(e=1)=>r.Smul(e,r.complement(r.Smul(2,r(Math.random(),Math.random()))));r.toA=e=>[e.x,e.y];r.polar=(e,t)=>{let s=e*Math.PI/180;return r(t*Math.cos(s),t*Math.sin(s))};r.x=Object.freeze(r(1));r.y=Object.freeze(r(0,1));r.zero=Object.freeze(r());r.map=(e,t)=>r(e(t.x),e(t.y));r.map2=(e,t,s)=>r(e(t.x,s.x),e(t.y,s.y));r.reduce=(e,t)=>e(t.x,t.y);r.cross=(e,t)=>e.x*t.y-e.y*t.x;r.project=(e,t)=>r.mulS(t,r.dot(e,t)/r.len2(t));r.reject=(e,t)=>r.sub(e,r.project(e,t));r.scalarProjection=(e,t,s)=>{let o=r.sub(e,t),n=r.normalize(r.sub(s,t)),i=r.mulS(n,r.dot(o,n));return r.add(t,i)};r.add=(e,t)=>r(e.x+t.x,e.y+t.y);r.div=(e,t)=>r(e.x/t.x,e.y/t.y);r.mul=(e,t)=>r(e.x*t.x,e.y*t.y);r.sub=(e,t)=>r(e.x-t.x,e.y-t.y);r.addS=(e,t)=>r.add(e,r.of(t));r.divS=(e,t)=>r.div(e,r.of(t));r.mulS=(e,t)=>r.mul(e,r.of(t));r.subS=(e,t)=>r.sub(e,r.of(t));r.Sadd=(e,t)=>r.add(r.of(e),t);r.Sdiv=(e,t)=>r.div(r.of(e),t);r.Smul=(e,t)=>r.mul(r.of(e),t);r.Ssub=(e,t)=>r.sub(r.of(e),t);r.dist=(e,t)=>r.len(r.sub(e,t));r.dist2=(e,t)=>r.len2(r.sub(e,t));r.dot=(e,t)=>e.x*t.x+e.y*t.y;r.equal=(e,t)=>q(r.dist2(e,t));r.len2=e=>r.dot(e,e);r.len=e=>Math.sqrt(r.dot(e,e));r.ceil=e=>r.map(Math.ceil,e);r.floor=e=>r.map(Math.floor,e);r.round=e=>r.map(Math.round,e);r.roundTo=(e,t)=>r.map2(C,e,r.of(t));r.complement=e=>r.Ssub(1,e);r.half=e=>r.divS(e,2);r.normalize=e=>r.divS(e,r.len(e));r.recip=e=>r.Sdiv(1,e);r.renormalize=(e,t,s,o,n)=>r.add(r.mul(r.div(r.sub(e,t),r.sub(s,t)),r.sub(n,o)),o);r.avg=(e,t)=>r.half(r.add(e,t));r.lerp=(e,t,s)=>r.add(e,r.Smul(s,r.sub(t,e)));r.max=(e,t)=>r.map2(Math.max,e,t);r.min=(e,t)=>r.map2(Math.min,e,t);r.abs=e=>r.map(Math.abs,e);r.invert=e=>r(-e.x,-e.y);r.invertX=e=>r(-e.x,e.y);r.invertY=e=>r(e.x,-e.y);r.rotate90CW=e=>r(e.y,-e.x);r.rotate90CCW=e=>r(-e.y,e.x);r.rotateAround=(e,t,s)=>{let o=s*Math.PI/180,n=r.sub(e,t),i=r(n.x*Math.cos(o)-n.y*Math.sin(o),n.x*Math.sin(o)+n.y*Math.cos(o));return r.add(i,t)};r.angle=e=>{var t=Math.atan2(e.y,e.x),s=t*180/Math.PI;return s<0&&(s+=360),s};r.angleBetween=(e,t)=>{let s=r.dot(e,t),o=r.len(e),n=r.len(t);return Math.acos(s/(o*n))*180/Math.PI};r.angleBetweenClockwise=(e,t)=>{let s=r.dot(e,t),o=r.cross(e,t),i=Math.atan2(s,o)*(180/Math.PI);return i<0&&(i=360+i),i};r.update=(e,t)=>{e.x=t.x,e.y=t.y};var g=(e,t)=>({a:e,b:t}),x=g;g.len=e=>a.dist(e.a,e.b);g.intersect=(e,t)=>{let{a:s,b:o}=e,{a:n,b:i}=t,l=o.x-s.x,h=o.y-s.y,f=i.x-n.x,c=i.y-n.y,d=l*c-h*f;if(d===0)return null;let u=s.x-n.x,b=s.y-n.y,m=(u*c-b*f)/d,j=(l*b-h*u)/d;if(m>=0&&m<=1&&j>=0&&j<=1){let v=s.x+m*l,M=s.y+m*h;return{x:v,y:M}}return null};g.intersectAnywhere=(e,t)=>{let{a:s,b:o}=e,{a:n,b:i}=t,l=o.x-s.x,h=o.y-s.y,f=i.x-n.x,c=i.y-n.y,d=l*c-h*f;if(d===0)return null;let u=s.x-n.x,b=s.y-n.y,m=(u*c-b*f)/d,j=(l*b-h*u)/d,v=s.x+m*l,M=s.y+m*h;return{x:v,y:M}};g.getYforX=(e,t)=>{let{a:s,b:o}=e,{x:n,y:i}=s,{x:l,y:h}=o;return(h-i)/(l-n)*(t-n)+i};g.getXforY=(e,t)=>{let{a:s,b:o}=e,{x:n,y:i}=s,{x:l,y:h}=o,f=(h-i)/(l-n);return(t-i)/f+n};g.distToPoint=(e,t)=>{let{a:s,b:o}=e,n=a.sub(o,s),i=a.sub(t,s),l=a.dot(i,n)/a.dot(n,n);if(l<=0)return a.len(i);if(l>=1)return a.dist(t,o);{let h=a.add(s,a.mulS(n,l));return a.dist(t,h)}};var P=class{constructor(t){this.page=t,this.a=null,this.b=null}pen_down(t){this.a=t,this.b=a.clone(t)}pen_move(t){this.b=t}pen_up(t){let s=x(this.a,this.b);this.page.add_line(s),this.a=null,this.b=null}render(t){!this.a||(t.lineWidth=1,t.strokeStyle="#000000",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.stroke())}},L=P;var w={filming_mode:!0};var N=0,W=w.filming_mode?4:3,S=class{constructor(t){this.id=N++,this.pos=t||a()}render(t,s="#000000"){t.fillStyle=s,t.beginPath(),t.ellipse(this.pos.x,this.pos.y,W,W,0,0,Math.PI*2),t.fill()}},y=S;var Z=w.filming_mode?3:1,H=0,E=class{constructor(t,s){this.id=H++,this.a=t,this.b=s}render(t,s="#000000"){t.lineWidth=Z,t.strokeStyle=s,t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.stroke()}},k=E;var A=class{constructor(t){this.root=t[0].a.pos,this.default_translate=a.sub(t[t.length-1].b.pos,this.root),this.translate=this.default_translate,this.rotate=0,this.baked_translate=a(0,0),this.baked_rotate=0,this.pattern=t.map(s=>({a:s.a.pos,b:s.b.pos})),this.first=t,this.repetitions=1,this.repetiton_rotation=1,this.repetiton_rotation_acc=0,this.transform(a(0,0),0)}transform(t,s){this.translate=a.add(this.baked_translate,a.add(this.default_translate,t)),this.rotate=this.baked_rotate+s,this.update()}update(){this.copies=[],this.repetitions=Math.round(this.repetiton_rotation);let t=this.translate,s=this.rotate;for(let o=0;o<this.repetitions;o++){let n={points:[],strokes:[]};this.pattern.forEach(h=>{let f=new y(a.add(h.a,t));n.points.push(f);let c=new y(a.add(h.b,t));n.points.push(c);let d=new k(f,c);n.strokes.push(d)});let i=n.strokes[0].a.pos;n.points.forEach(h=>{a.update(h.pos,a.rotateAround(h.pos,i,s))});let l=t;t=a.add(t,this.translate),t=a.rotateAround(t,l,s),s+=this.rotate,this.copies.push(n)}}bake(){this.baked_translate=this.translate,this.baked_rotate=this.rotate}update_repetitions(t){this.repetiton_rotation_acc=t*.05}render(t){this.repetiton_rotation+=this.repetiton_rotation_acc,this.repetiton_rotation_acc*=.9,this.repetitions!=Math.round(this.repetiton_rotation)&&this.update(),t.lineWidth=1,this.copies.forEach((o,n)=>{o.strokes.forEach(i=>{i.render(t,n==0?"#F81ED5":"#000000")}),o.points.forEach(i=>{i.render(t,n==0?"#F81ED5":"#000000")})}),t.fillStyle="#00000044",t.save(),t.translate(40,40),t.rotate(this.repetiton_rotation),t.beginPath(),t.ellipse(0,0,80,80,0,0,Math.PI*2),t.fill();let s=Math.PI*2/16;for(let o=0;o<16;o++)t.beginPath(),t.ellipse(Math.sin(s*o)*70,Math.cos(s*o)*70,5,5,0,0,Math.PI*2),t.fill();t.restore(),t.fillStyle="#000000",t.font="30px Arial",t.fillText(this.repetitions+1,40,60)}},B=A;var I=class{constructor(){this.points=[],this.strokes=[],this.repeater=null,this.selection={points:{},strokes:{}},this.last_tap_time=null,this.transform={finger_a:null,finger_b:null,empty_space:!1,dragging:!1,finger_a_down:null,finger_b_down:null,finger_a_move:null,finger_b_move:null,points_down:{}},this.repeater_interaction=null,this.repeater_old_rotation=0}touch_down(t,s,o){if(this.repeater&&a.dist(a(40,40),t)<80&&(this.repeater_interaction=t,this.repeater_old_rotation=this.repeater.repetiton_rotation),a.dist(a(10,10),t)<50){let n=Object.keys(this.selection.strokes).sort().map(i=>this.selection.strokes[i]);this.repeater=new B(n),this.selection={points:{},strokes:{}};return}if(this.transform.finger_a==null){this.empty_space=!0,this.last_tap_time=o;let n=this.find_point_near(t);if(n)this.selection.points[n.id]=n,this.empty_space=!1;else{let i=this.find_stroke_near(t);i&&(this.selection.strokes[i.id]=i,this.selection.points[i.a.id]=i.a,this.selection.points[i.b.id]=i.b,this.empty_space=!1)}this.transform.dragging=!0,this.transform.finger_a=s,this.transform.finger_a_down=t,this.transform.finger_a_move=t,this.transform.points_down={},Object.keys(this.selection.points).forEach(i=>{this.transform.points_down[i]=a.clone(this.selection.points[i].pos)})}else this.transform.finger_b=s,this.transform.finger_b_down=t,this.transform.finger_b_move=t,this.transform.finger_a_down=this.transform.finger_a_move,this.transform.points_down={},Object.keys(this.selection.points).forEach(n=>{this.transform.points_down[n]=a.clone(this.selection.points[n].pos)})}touch_move(t,s,o){if(this.repeater_interaction){let n=t.y-this.repeater_interaction.y;this.repeater_interaction=t,this.repeater.update_repetitions(n);return}if(!!this.transform.dragging){if(this.transform.finger_b){s==this.transform.finger_a&&(this.transform.finger_a_move=t),s==this.transform.finger_b&&(this.transform.finger_b_move=t);let n=a.mulS(a.add(this.transform.finger_a_down,this.transform.finger_b_down),.5),i=a.mulS(a.add(this.transform.finger_a_move,this.transform.finger_b_move),.5),l=a.sub(i,n),h=a.angle(a.sub(this.transform.finger_a_down,this.transform.finger_b_down)),c=a.angle(a.sub(this.transform.finger_a_move,this.transform.finger_b_move))-h;if(this.repeater)this.repeater.transform(l,c);else{let d=a(0,0);Object.keys(this.selection.points).forEach(u=>{this.selection.points[u].pos=a.add(this.transform.points_down[u],l),d=a.add(d,this.selection.points[u].pos)}),d=a.divS(d,Object.keys(this.selection.points).length),Object.keys(this.selection.points).forEach(u=>{this.selection.points[u].pos=a.rotateAround(this.selection.points[u].pos,d,c)})}}else if(s==this.transform.finger_a){this.finger_a_moved=t;let n=a.sub(t,this.transform.finger_a_down);this.repeater?this.repeater.transform(n,0):Object.keys(this.selection.points).forEach(i=>{this.selection.points[i].pos=a.add(this.transform.points_down[i],n)})}}}touch_up(t,s,o){if(this.repeater&&this.repeater.bake(),this.transform.dragging=!1,this.repeater_interaction=null,this.transform.finger_a==s&&(this.transform.finger_a=null),this.transform.finger_b==s&&(this.transform.finger_b=null),console.log(this.transform.finger_a),o-this.last_tap_time<.2){if(this.empty_space){this.repeater&&(this.repeater.copies.forEach(n=>{n.points.forEach(i=>{this.points.push(i)}),n.strokes.forEach(i=>{this.strokes.push(i)})}),this.repeater=null),this.selection={points:{},strokes:{}},this.last_tap_time=null;return}}else!this.empty_space&&(Object.keys(this.selection.points).length==1||Object.keys(this.selection.strokes).length==1)&&(this.selection={points:{},strokes:{}})}find_point_near(t){return this.points.find(s=>a.dist(s.pos,t)<20)}find_stroke_near(t){return this.strokes.find(s=>x.distToPoint(x(s.a.pos,s.b.pos),t)<20)}add_line(t){let s=new y(t.a),o=new y(t.b);this.points.push(s),this.points.push(o),this.strokes.push(new k(s,o))}render(t){this.repeater||(t.beginPath(),t.ellipse(30,30,20,20,0,0,Math.PI*2),t.stroke()),this.strokes.forEach(s=>{s.render(t,this.selection.strokes[s.id]?"#F81ED5":this.repeater?"#AAAAAA":"#000000")}),this.points.forEach(s=>{s.render(t,this.selection.points[s.id]?"#F81ED5":this.repeater?"#AAAAAA":"#000000")}),this.repeater&&this.repeater.render(t)}},F=I;var O=class{constructor(){this.page=new F,this.draw_tool=new L(this.page)}update(t){t.pencil.forEach(s=>{let o=a(s.x,s.y);s.type==="began"?this.draw_tool.pen_down(o):s.type==="moved"?this.draw_tool.pen_move(o):s.type==="ended"&&this.draw_tool.pen_up(o)}),Object.entries(t.touches).forEach(([s,o])=>{o.forEach(n=>{let i=a(n.x,n.y);n.type==="began"?this.page.touch_down(i,s,n.timestamp):n.type==="moved"?this.page.touch_move(i,s,n.timestamp):n.type==="ended"&&this.page.touch_up(i,s,n.timestamp)})})}render(t){this.draw_tool.render(t),this.page.render(t)}},X=O;var Y=new X;console.log("hello world");var Q=new V(document.body,e=>{e.clearRect(0,0,window.innerWidth,window.innerHeight),Y.render(e)});z(e=>{Y.update(e),Q.render()});
//# sourceMappingURL=main.js.map
