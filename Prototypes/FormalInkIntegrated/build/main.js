var ot=class{constructor(){this.events=[],this.activePencil=null,this.activeFingers={}}did(t,s,i){return this.events.find(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}didAll(t,s,i){return this.events.filter(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}didLast(t,s,i){return this.events.findLast(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}},j=new ot;window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([s,i])=>{i.forEach(n=>{j.events.push({type:n.type==="pencil"?"pencil":"finger",state:e,id:s,position:{x:n.x,y:n.y},timestamp:n.timestamp}),n.type==="pencil"?j.activePencil=e!=="ended"?{x:n.x,y:n.y}:null:e!=="ended"?j.activeFingers[s]={x:n.x,y:n.y}:delete j.activeFingers[s]})})};var rt=null;function at(){rt(j),j.events=[],window.requestAnimationFrame(at)}function q(e){rt=e,window.requestAnimationFrame(at)}var Lt=Math.PI*2,ht=e=>Number.EPSILON>Math.abs(e);var ct=(e,t)=>(p=1/t,Math.round(e*p)/p);var o=(e=0,t=0)=>({x:e,y:t}),c=o;o.clone=e=>o(e.x,e.y);o.fromRectXY=e=>o(e.x,e.y);o.fromRectWH=e=>o(e.w,e.h);o.fromRectRB=e=>o(e.x+e.w,e.y+e.h);o.of=e=>o(e,e);o.random=(e=1)=>o.Smul(e,o.complement(o.Smul(2,o(Math.random(),Math.random()))));o.toA=e=>[e.x,e.y];o.polar=(e,t)=>o(t*Math.cos(e),t*Math.sin(e));o.x=Object.freeze(o(1));o.y=Object.freeze(o(0,1));o.zero=Object.freeze(o());o.map=(e,t)=>o(e(t.x),e(t.y));o.map2=(e,t,s)=>o(e(t.x,s.x),e(t.y,s.y));o.reduce=(e,t)=>e(t.x,t.y);o.cross=(e,t)=>e.x*t.y-e.y*t.x;o.project=(e,t)=>o.mulS(t,o.dot(e,t)/o.len2(t));o.reject=(e,t)=>o.sub(e,o.project(e,t));o.scalarProjection=(e,t,s)=>{let i=o.sub(e,t),n=o.normalize(o.sub(s,t)),r=o.mulS(n,o.dot(i,n));return o.add(t,r)};o.add=(e,t)=>o(e.x+t.x,e.y+t.y);o.div=(e,t)=>o(e.x/t.x,e.y/t.y);o.mul=(e,t)=>o(e.x*t.x,e.y*t.y);o.sub=(e,t)=>o(e.x-t.x,e.y-t.y);o.addS=(e,t)=>o.add(e,o.of(t));o.divS=(e,t)=>o.div(e,o.of(t));o.mulS=(e,t)=>o.mul(e,o.of(t));o.subS=(e,t)=>o.sub(e,o.of(t));o.Sadd=(e,t)=>o.add(o.of(e),t);o.Sdiv=(e,t)=>o.div(o.of(e),t);o.Smul=(e,t)=>o.mul(o.of(e),t);o.Ssub=(e,t)=>o.sub(o.of(e),t);o.dist=(e,t)=>o.len(o.sub(e,t));o.dist2=(e,t)=>o.len2(o.sub(e,t));o.dot=(e,t)=>e.x*t.x+e.y*t.y;o.equal=(e,t)=>ht(o.dist2(e,t));o.len2=e=>o.dot(e,e);o.len=e=>Math.sqrt(o.dot(e,e));o.ceil=e=>o.map(Math.ceil,e);o.floor=e=>o.map(Math.floor,e);o.round=e=>o.map(Math.round,e);o.roundTo=(e,t)=>o.map2(ct,e,o.of(t));o.complement=e=>o.Ssub(1,e);o.half=e=>o.divS(e,2);o.normalize=e=>o.divS(e,o.len(e));o.recip=e=>o.Sdiv(1,e);o.renormalize=(e,t,s,i,n)=>o.add(o.mul(o.div(o.sub(e,t),o.sub(s,t)),o.sub(n,i)),i);o.avg=(e,t)=>o.half(o.add(e,t));o.lerp=(e,t,s)=>o.add(e,o.Smul(s,o.sub(t,e)));o.max=(e,t)=>o.map2(Math.max,e,t);o.min=(e,t)=>o.map2(Math.min,e,t);o.abs=e=>o.map(Math.abs,e);o.invert=e=>o(-e.x,-e.y);o.invertX=e=>o(-e.x,e.y);o.invertY=e=>o(e.x,-e.y);o.rotate90CW=e=>o(e.y,-e.x);o.rotate90CCW=e=>o(-e.y,e.x);o.rotateAround=(e,t,s)=>{let i=s*Math.PI/180,n=o.sub(e,t),r=o(n.x*Math.cos(i)-n.y*Math.sin(i),n.x*Math.sin(i)+n.y*Math.cos(i));return o.add(r,t)};o.angle=e=>Math.atan2(e.y,e.x);o.angleBetween=(e,t)=>{let s=o.dot(e,t),i=o.len(e),n=o.len(t);return Math.acos(s/(i*n))*180/Math.PI};o.angleBetweenClockwise=(e,t)=>{let s=o.dot(e,t),i=o.cross(e,t),r=Math.atan2(s,i)*(180/Math.PI);return r<0&&(r=360+r),r};o.update=(e,t)=>{e.x=t.x,e.y=t.y};var Et=0;function v(){return Et++}var B=class{constructor(t,s,i,n){this.id=v(),this.a=s,this.b=i,this.c=n,this.dirty=!0,this.selected=!1,this.radius=c.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let r={d:this.path,"stroke-width":1,stroke:"black",fill:"none"};this.elements={normal:t.addElement("path",r),selected:t.addElement("path",{...r,"stroke-width":7,stroke:"none"})}}updatePath(){this.path=`M ${this.a.position.x} ${this.a.position.y} A ${this.radius}  ${this.radius} ${this.xAxisRotation} ${this.isLargeArc} ${this.clockwise} ${this.b.position.x} ${this.b.position.y}`}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty||this.c.dirty){this.radius=c.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let s={d:this.path};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},lt=B;var C=class{constructor(t,s,i){this.id=v(),this.a=s,this.b=i,this.dirty=!0,this.selected=!1;let n={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y,"stroke-width":1,stroke:"black"};this.elements={normal:t.addElement("line",n),selected:t.addElement("line",{...n,"stroke-width":7,stroke:"none"})}}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty){let s={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},dt=C;var N=class{constructor(t=document.body){this.root=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.updateElement(this.root,{xmlns:"http://www.w3.org/2000/svg",width:window.innerWidth,height:window.innerHeight}),t.appendChild(this.root)}addElement(t,s){let i=document.createElementNS("http://www.w3.org/2000/svg",t);return this.updateElement(i,s),this.root.appendChild(i),i}updateElement(t,s){Object.entries(s).forEach(([i,n])=>t.setAttribute(i,n))}},pt=N;function I(e){return e.map((s,i)=>`${i===0?"M":"L"} ${s.x} ${s.y}`).join(" ")}var U=class{constructor(t,s){this.id=v(),this.points=s,this.dirty=!0,this.selected=!1;let i=I(this.points);this.elements={normal:t.addElement("path",{d:i,stroke:"darkgrey","stroke-width":2,fill:"none"})}}move(t){this.dirty=!0,this.position=t}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){this.dirty&&(this.dirty=!1)}},ft=U;var G=class{constructor(t,s){this.id=v(),this.position=s,this.dirty=!0,this.selected=!1,this.elements={normal:t.addElement("circle",{cx:0,cy:0,r:3,fill:"black"}),selected:t.addElement("circle",{cx:0,cy:0,r:7,fill:"none"})}}setPosition(t){this.dirty=!0,this.position=t}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}remove(){this.elements.normal.remove(),this.elements.selected.remove()}render(t){this.dirty&&(t.updateElement(this.elements.normal,{transform:`translate(${this.position.x} ${this.position.y})`}),t.updateElement(this.elements.selected,{transform:`translate(${this.position.x} ${this.position.y})`,fill:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1)}},ut=G;var H=class{constructor(t){this.svg=t,this.points=[],this.lineSegments=[],this.freehandStrokes=[]}addPoint(t){let s=new ut(this.svg,t);return this.points.push(s),s}addLineSegment(t,s){let i=new dt(this.svg,t,s);return this.lineSegments.push(i),i}addArcSegment(t,s,i){let n=new lt(this.svg,t,s,i);return this.lineSegments.push(n),n}addFreehandStroke(t){let s=new ft(this.svg,t);return this.freehandStrokes.push(s),s}findPointNear(t,s=20){let i=null,n=s;for(let r of this.points){let a=c.dist(r.position,t);a<n&&(n=a,i=r)}return i}mergePoint(t){let s=new Set(this.points.filter(i=>i!==t&&c.dist(i.position,t.position)===0));if(s.size!==0){for(let i of this.lineSegments)s.has(i.a)&&(i.a=t),s.has(i.b)&&(i.b=t),s.has(i.c)&&(i.c=t);for(let i of s)i.remove();this.points=this.points.filter(i=>!s.has(i))}}pointsReachableFrom(t){let s=new Set(t);for(;;){let i=s.size;for(let n of this.lineSegments)s.has(n.a)&&s.add(n.b),s.has(n.b)&&s.add(n.a);if(s.size===i)break}return s}render(t){let s=i=>i.render(t);this.lineSegments.forEach(s),this.freehandStrokes.forEach(s),this.points.forEach(s)}},mt=H;var jt=Math.PI/180,It=180/Math.PI,T=class{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}transform(t,s,i,n,r,a){let{a:h,b:l,c:d,d:u,e:m,f}=this;return this.a=h*t+d*s,this.b=l*t+u*s,this.c=h*i+d*n,this.d=l*i+u*n,this.e=h*r+d*a+m,this.f=l*r+u*a+f,this}rotate(t){let s=Math.cos(t),i=Math.sin(t);return this.transform(s,i,-i,s,0,0),this}rotateDegrees(t){return this.rotate(t*jt),this}scale(t,s){return this.transform(t,0,0,s,0,0),this}skew(t,s){return this.transform(1,s,t,1,0,0),this}translate(t,s){return this.transform(1,0,0,1,t,s),this}flipX(){return this.transform(-1,0,0,1,0,0),this}flipY(){return this.transform(1,0,0,-1,0,0),this}inverse(){let{a:t,b:s,c:i,d:n,e:r,f:a}=this,h=t*n-s*i;return this.a=n/h,this.b=-s/h,this.c=-i/h,this.d=t/h,this.e=(i*a-n*r)/h,this.f=-(t*a-s*r)/h,this}getInverse(){let{a:t,b:s,c:i,d:n,e:r,f:a}=this,h=new T,l=t*n-s*i;return h.a=n/l,h.b=-s/l,h.c=-i/l,h.d=t/l,h.e=(i*a-n*r)/l,h.f=-(t*a-s*r)/l,h}getPosition(){return{x:this.e,y:this.f}}getRotation(){let t=(this.a+this.d)/2,s=(this.a-this.d)/2,i=(this.c+this.b)/2,n=(this.c-this.b)/2,r=Math.atan2(i,s);return-((Math.atan2(n,t)+r)/2)*It}getScale(){let t=(this.a+this.d)/2,s=(this.a-this.d)/2,i=(this.c+this.b)/2,n=(this.c-this.b)/2,r=Math.sqrt(t*t+n*n),a=Math.sqrt(s*s+i*i);return{scaleX:r+a,scaleY:r-a}}transformMatrix(t){let{a:s,b:i,c:n,d:r,e:a,f:h}=this,l=t.a,d=t.b,u=t.c,m=t.d,f=t.e,g=t.f,y=new T;return y.a=s*l+n*d,y.b=i*l+r*d,y.c=s*u+n*m,y.d=i*u+r*m,y.e=s*f+n*g+a,y.f=i*f+r*g+h,y}transformPoint(t){let{x:s,y:i}=t,{a:n,b:r,c:a,d:h,e:l,f:d}=this;return c(s*n+i*a+l,s*r+i*h+d)}transformLine(t){return{a:this.transformPoint(t.a),b:this.transformPoint(t.b)}}fromLine(t,s){let i=c.sub(s,t);return this.translate(t.x,t.y),this.rotate(c.angle(i)),this}},O=T;var W=class{constructor(t,s){this.page=t,this.snaps=s,this.points=new Set,this.origPosition=new Map,this.tappedOn=null,this.firstFinger=null,this.firstFingerMoved=null,this.secondFinger=null,this.secondFingerMoved=null}update(t){let s=t.did("finger","began");if(s)if(this.firstFinger){this.secondFinger=s,this.secondFingerMoved=s;let i=new O,n=c.divS(c.add(this.firstFingerMoved.position,this.secondFinger.position),2),r=this.secondFinger.position;i.fromLine(n,r).inverse();for(let a of this.points)this.origPosition.set(a,i.transformPoint(a.position))}else{this.firstFinger=s,this.firstFingerMoved=s;let i=this.page.findPointNear(s.position);i?(this.selectPoint(i),this.tappedOn=i):this.tappedOn=null;let n=new O,r=s.position;n.translate(r.x,r.y).inverse();for(let a of this.points)this.origPosition.set(a,n.transformPoint(a.position))}if(this.firstFinger){let i=t.didLast("finger","moved",this.firstFinger.id);i&&(this.firstFingerMoved=i,this.transformSelection());let n=t.did("finger","ended",this.firstFinger.id);if(n){n.timestamp-this.firstFinger.timestamp<.2?this.tappedOn==null&&this.clearSelection():this.tappedOn!=null&&this.points.size===1&&this.clearSelection();for(let a of this.points)this.page.mergePoint(a);this.firstFinger=null,this.firstFingerMoved=null,this.secondFinger=null,this.secondFingerMoved=null,this.snaps.clear()}}if(this.secondFinger){let i=t.did("finger","moved",this.secondFinger.id);i&&(this.secondFingerMoved=i,this.transformSelection()),t.did("finger","ended",this.secondFinger.id)&&(this.secondFinger=null,this.secondFingerMoved=null,this.firstFinger=null,this.firstFingerMoved=null)}}selectPoint(t){this.points.add(t),t.select();for(let s of this.page.lineSegments)this.points.has(s.a)&&this.points.has(s.b)?s.select():s.deselect()}clearSelection(){for(let t of this.points)t.deselect();this.points=new Set,this.origPosition=new Map;for(let t of this.page.lineSegments)t.deselect()}transformSelection(){let t=new O;if(this.firstFingerMoved&&this.secondFingerMoved){let n=c.divS(c.add(this.firstFingerMoved.position,this.secondFingerMoved.position),2),r=this.secondFingerMoved.position;t.fromLine(n,r)}else{let n=this.firstFingerMoved.position;t.translate(n.x,n.y)}let s=new Map;for(let n of this.points){let r=this.origPosition.get(n),a=t.transformPoint(r);s.set(n,a)}let i=this.snaps.snapPositions(s);for(let n of this.points)n.setPosition(i.get(n))}},gt=W;var Z=class{constructor(t){this.page=t,this.activeSnaps=[],this.snapSvgElementById=new Map,this.dirty=!1}snapPositions(t){let s=[],i=new Map,n=this.page.points.filter(h=>!t.has(h)),r=Array.from(t.keys()),a=this.page.pointsReachableFrom(r);for(let[h,l]of t){if(s.some(m=>m.snapPoint===h)){i.set(h,l);continue}let d=[];for(let m of n){let f=c.sub(m.position,l);if(c.len(f)<10){d.push(f),s.push(new yt(h,m));break}}if(d.length===0){for(let m of a){if(m===h)continue;let f=m.position.x-l.x;if(Math.abs(f)<10){let g=c(f,0);d.push(g),s.push(new _(h,m));break}}for(let m of a){if(m===h)continue;let f=m.position.y-l.y;if(Math.abs(f)<10){let g=c(0,f);d.push(g),s.push(new _(h,m));break}}}let u=d.reduce((m,f)=>c.add(m,f),l);i.set(h,u)}return this.setActiveSnaps(s),i}setActiveSnaps(t){this.activeSnaps=t,this.dirty=!0;let s=new Set(t.map(i=>i.id));for(let[i,n]of this.snapSvgElementById)s.has(i)||(n.remove(),this.snapSvgElementById.delete(i))}clear(){this.setActiveSnaps([])}render(t){if(!!this.dirty){for(let s of this.activeSnaps){let i=s.id,{shapeType:n,shapeData:r}=s.getShape(),a=this.snapSvgElementById.get(i);a==null?(a=t.addElement(n,{...r,fill:"none",stroke:"rgb(180, 134, 255)"}),this.snapSvgElementById.set(i,a)):t.updateElement(a,r)}this.dirty=!1}}},xt=Z,Q=class{constructor(t,s){this.point=t,this.snapPoint=s,this.id=`${t.id}.${s.id}.${this.constructor.name}`}getShape(){throw new Error("subclass responsibility!")}},yt=class extends Q{constructor(t,s){super(t,s)}getShape(){return{shapeType:"circle",shapeData:{cx:this.point.position.x,cy:this.point.position.y,r:7}}}},_=class extends Q{constructor(t,s){super(t,s)}getShape(){return{shapeType:"line",shapeData:{x1:this.point.position.x,y1:this.point.position.y,x2:this.snapPoint.position.x,y2:this.snapPoint.position.y}}}};var J=class{constructor(t){this.selected=0,this.dirty=!1,this.buttons=[t.addElement("circle",{cx:30,cy:30,r:20,fill:"black"}),t.addElement("circle",{cx:30,cy:80,r:20,fill:"lightgrey"}),t.addElement("circle",{cx:30,cy:130,r:20,fill:"lightgrey"})]}update(t){let s=t.did("finger","began");if(!s)return;let i=[30,80,130].findIndex(n=>c.dist(c(30,n),s.position)<20);i!==-1&&(this.selected=i,this.dirty=!0)}render(t){this.dirty&&(console.log("update"),this.buttons.forEach((s,i)=>t.updateElement(s,{fill:this.selected===i?"black":"lightgrey"})),this.dirty=!1)}},Pt=J;function A(e,t,s,i,n=!0){return{center:e,radius:t,startAngle:s,endAngle:i,clockwise:n}}var b=A;A.len=e=>{let{radius:t,startAngle:s,endAngle:i}=e;return t*Math.abs(i-s)};A.distToPointCircle=(e,t)=>{let s=c.dist(e.center,t);return Math.abs(s-e.radius)};A.spreadPointsAlong=(e,t)=>{let s=[],n=A.directedInnerAngle(e)/(t-1);for(let r=0;r<t;r++){let a=e.startAngle+n*r,h=c(e.radius*Math.cos(a),e.radius*Math.sin(a));s.push(c.add(e.center,h))}return s};A.directedInnerAngle=e=>{let t=e.endAngle-e.startAngle;return e.clockwise&&t<0?2*Math.PI-Math.abs(t):!e.clockwise&&t>0?-2*Math.PI+Math.abs(t):t};A.points=e=>{console.log(e);let t=c.add(e.center,c.polar(e.startAngle,e.radius)),s=c.add(e.center,c.polar(e.endAngle,e.radius));return{start:t,end:s}};var x=(e,t)=>({a:e,b:t}),F=x;x.len=e=>c.dist(e.a,e.b);x.directionVec=e=>c.normalize(c.sub(e.b,e.a));x.intersect=(e,t)=>{let{a:s,b:i}=e,{a:n,b:r}=t,a=i.x-s.x,h=i.y-s.y,l=r.x-n.x,d=r.y-n.y,u=a*d-h*l;if(u===0)return null;let m=s.x-n.x,f=s.y-n.y,g=(m*d-f*l)/u,y=(a*f-h*m)/u;if(g>=0&&g<=1&&y>=0&&y<=1){let M=s.x+g*a,k=s.y+g*h;return{x:M,y:k}}return null};x.intersectAnywhere=(e,t)=>{let{a:s,b:i}=e,{a:n,b:r}=t,a=i.x-s.x,h=i.y-s.y,l=r.x-n.x,d=r.y-n.y,u=a*d-h*l;if(u===0)return null;let m=s.x-n.x,f=s.y-n.y,g=(m*d-f*l)/u,y=(a*f-h*m)/u,M=s.x+g*a,k=s.y+g*h;return{x:M,y:k}};x.getYforX=(e,t)=>{let{a:s,b:i}=e,{x:n,y:r}=s,{x:a,y:h}=i;return(h-r)/(a-n)*(t-n)+r};x.getXforY=(e,t)=>{let{a:s,b:i}=e,{x:n,y:r}=s,{x:a,y:h}=i,l=(h-r)/(a-n);return(t-r)/l+n};x.distToPoint=(e,t)=>c.dist(t,x.closestPoint(e,t));x.closestPoint=(e,t,s=!0)=>{let{a:i,b:n}=e,r=c.sub(n,i),a=c.sub(t,i),h=c.dot(a,r)/c.dot(r,r);return s&&h<=0?i:s&&h>=1?n:c.add(i,c.mulS(r,h))};x.spreadPointsAlong=(e,t)=>{let s=x.len(e)/t,i=c.mulS(x.directionVec(e),s),n=[];for(let r=0;r<t;r++)n.push(c.add(e.a,c.mulS(i,r)));return n};var D={},V=D;D.line=e=>{if(e.length===0)return null;let t=F(c.clone(e[0]),c.clone(e[e.length-1])),s=0;for(let n=1;n<e.length-1;n++)s+=F.distToPoint(t,e[n]);let i=F.len(t);return{type:"line",line:t,fitness:i===0?1:s/i,length:i}};D.arc=e=>{if(e.length<3)return null;let t=D.innerTriangle(e),[s,i,n]=t;if(!i)return null;let{x:r,y:a}=s,{x:h,y:l}=i,{x:d,y:u}=n,m=2*(r*(l-u)+h*(u-a)+d*(a-l)),f=((r*r+a*a)*(l-u)+(h*h+l*l)*(u-a)+(d*d+u*u)*(a-l))/m,g=((r*r+a*a)*(d-h)+(h*h+l*l)*(r-d)+(d*d+u*u)*(h-r))/m,y=Math.sqrt((r-f)*(r-f)+(a-g)*(a-g)),M=Math.atan2(a-g,r-f),k=Math.atan2(u-g,d-f),L=c.sub(s,i),X=c.sub(i,n),P=c.cross(L,X)>0,E=b(c(f,g),y,M,k,P),$=b.len(E),R=0;for(let Y of e)R+=b.distToPointCircle(E,Y);return{type:"arc",arc:E,fitness:R/$,length:$}};D.innerTriangle=e=>{let t=e[0],s=e[e.length-1],i=-1,n=-1;for(let r=0;r<e.length;r++){let a=e[r],h=F.distToPoint(F(t,s),a);h>i&&(i=h,n=r)}return[t,e[n],s]};D.circle=e=>{if(e.length<3)return null;let t=e.length,s=0,i=0,n=0,r=0,a=0,h=0,l=0,d=0,u=0;for(let z of e){let{x:S,y:w}=z;s+=S,i+=w,n+=S*S,r+=w*w,a+=S*w,h+=S*S*S,l+=w*w*w,d+=S*w*w,u+=S*S*w}let m=t*n-s*s,f=t*a-s*i,g=t*h+t*d-(n+r)*s,y=t*r-i*i,M=t*u+t*l-(n+r)*i,k=(M*f-g*y)/(m*y-f*f),L=(M*m-g*f)/(f*f-y*m),X=-(k*s+L*i+n+r)/t,P=c(-k/2,-L/2),E=Math.sqrt(P.x*P.x+P.y*P.y-X),$=Math.atan2(e[0].y-P.y,e[0].x-P.x),R=Math.atan2(e[e.length-1].y-P.y,e[e.length-1].x-P.x),Y=c.sub(e[0],e[1]),kt=c.sub(e[1],e[2]),Ft=c.cross(Y,kt)>0,it={center:P,radius:E,startAngle:$,endAngle:R,clockwise:Ft},nt=0;for(let z of e)nt+=b.distToPointCircle(it,z);let At=2*Math.PI*E;return{type:"circle",circle:it,fitness:nt/At}};var K=class{constructor(t,s){this.page=t,this.snaps=s,this.element=null,this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.speed=0,this.maxSpeed=0,this.previousPosition=null,this.mode="unknown",this.fit=null,this.fixedStroke=null}update(t){let s=t.did("pencil","began");if(s&&(this.inputPoints=[s.position],this.renderPoints=[c.clone(s.position)],this.speed=0,this.maxSpeed=0,this.previousPosition=s.position,this.mode="unknown",this.dirty=!0),t.didAll("pencil","moved").forEach(r=>{let a=c.dist(this.previousPosition,r.position),h=.05;if(this.speed=h*a+(1-h)*this.speed,this.maxSpeed=Math.max(this.maxSpeed,this.speed),this.previousPosition=r.position,this.mode!=="fixed")this.inputPoints.push(r.position),this.renderPoints.push(c.clone(r.position)),this.mode==="guess"&&this.doFit();else{let l=r.position,d=new Map;d.set(this.fixedStroke.a,this.fixedStroke.a.position),d.set(this.fixedStroke.b,l);let u=this.snaps.snapPositions(d);this.fixedStroke.a.setPosition(u.get(this.fixedStroke.a)),this.fixedStroke.b.setPosition(u.get(this.fixedStroke.b))}this.mode==="unknown"&&this.inputPoints.length>100&&(this.mode="guess"),this.mode!=="fixed"&&this.inputPoints.length>10&&this.speed<Math.min(1,this.maxSpeed)&&(this.doFit(),this.createStroke(),this.clearGuess(),this.mode="fixed"),this.dirty=!0}),t.did("pencil","ended")&&(this.mode!=="fixed"&&(this.doFit(),this.createStroke(),this.clearGuess()),this.page.mergePoint(this.fixedStroke.a),this.page.mergePoint(this.fixedStroke.b),this.fixedStroke=null,this.mode="unknown",this.snaps.clear()),this.idealPoints&&this.renderPoints.length===this.idealPoints.length)for(let r=0;r<this.idealPoints.length;r++)this.renderPoints[r]=c.lerp(this.idealPoints[r],this.renderPoints[r],.8)}doFit(){let t=V.line(this.inputPoints),s=V.arc(this.inputPoints),i=V.circle(this.inputPoints);this.fit=t,s!=null&&Math.abs(b.directedInnerAngle(s.arc))>.4*Math.PI&&(t==null||s.fitness<t.fitness)&&(this.fit=s,i!=null&&Math.abs(b.directedInnerAngle(s.arc))>1.5*Math.PI&&i.circle.radius<500&&i.fitness<s.fitness&&(this.fit=i)),this.fit!=null&&this.updateIdeal()}createStroke(){if(this.fit.type==="line"){let t=this.page.addPoint(this.fit.line.a),s=this.page.addPoint(this.fit.line.b),i=this.page.addLineSegment(t,s);this.fixedStroke=i}else if(this.fit.type==="arc"){let{start:t,end:s}=b.points(this.fit.arc),i=this.page.addPoint(t),n=this.page.addPoint(s),r=this.page.addPoint(this.fit.arc.center),a=this.page.addArcSegment(i,n,r);this.fixedStroke=a}}clearGuess(){this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.element.remove(),this.element=null}updateIdeal(){this.fit.type==="line"?this.idealPoints=F.spreadPointsAlong(this.fit.line,this.inputPoints.length):this.fit.type==="arc"?this.idealPoints=b.spreadPointsAlong(this.fit.arc,this.inputPoints.length):this.fit.type==="circle"&&(this.idealPoints=b.spreadPointsAlong(this.fit.circle,this.inputPoints.length))}render(t){if(!!this.dirty){if(this.renderPoints){this.element||(this.element=t.addElement("path",{d:"",stroke:"black",fill:"none"}));let s=I(this.renderPoints);t.updateElement(this.element,{d:s})}this.dirty=!1}}},bt=K;var tt=class{constructor(t){this.page=t,this.points=null,this.element=null}update(t){let s=t.did("pencil","began");s&&(this.points=[s.position],this.dirty=!0),(this.points==null?[]:t.didAll("pencil","moved")).forEach(r=>{this.points.push(r.position),this.dirty=!0}),t.did("pencil","ended")&&(this.page.addFreehandStroke(this.points),this.points=null,this.element.remove(),this.element=null)}render(t){if(!!this.dirty){if(this.points){this.element||(this.element=t.addElement("path",{d:"",stroke:"darkgrey","stroke-width":2,fill:"none"}));let s=I(this.points);t.updateElement(this.element,{d:s})}this.dirty=!1}}},St=tt;var et=class{constructor(t,s){this.page=t,this.svg=s,this.points=[],this.element=null}update(t){let s=t.did("pencil","began");s&&(this.points=[s.position]);let i=t.did("pencil","moved");i&&this.points.push(i.position);let n=t.did("pencil","ended")}render(t){}},wt=et;var st=class{constructor(){this.svg=new pt,this.page=new mt(this.svg),this.snaps=new xt(this.page),this.selection=new gt(this.page,this.snaps),this.toolPicker=new Pt(this.svg),this.tools=[new St(this.page),new bt(this.page,this.snaps),new wt(this.page)]}update(t){this.toolPicker.update(t),this.tools[this.toolPicker.selected].update(t),this.selection.update(t)}render(){this.toolPicker.render(this.svg),this.tools[this.toolPicker.selected].render(this.svg),this.snaps.render(this.svg),this.page.render(this.svg)}},vt=st;var Mt=new vt;q(e=>{Mt.update(e),Mt.render()});
//# sourceMappingURL=main.js.map
