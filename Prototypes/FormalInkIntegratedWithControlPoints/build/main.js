var at=class{constructor(){this.events=[],this.activePencil=null,this.activeFingers={}}did(t,s,i){return this.events.find(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}didAll(t,s,i){return this.events.filter(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}didLast(t,s,i){return this.events.findLast(n=>n.type===t&&n.state===s&&(i==null||n.id===i))}},I=new at;window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([s,i])=>{i.forEach(n=>{I.events.push({type:n.type==="pencil"?"pencil":"finger",state:e,id:s,position:{x:n.x,y:n.y},pressure:n.force,timestamp:n.timestamp}),n.type==="pencil"?I.activePencil=e!=="ended"?{x:n.x,y:n.y}:null:e!=="ended"?I.activeFingers[s]={x:n.x,y:n.y}:delete I.activeFingers[s]})})};var ct=null;function dt(){ct(I),I.events=[],window.requestAnimationFrame(dt)}function U(e){ct=e,window.requestAnimationFrame(dt)}var Yt=Math.PI*2,pt=e=>Number.EPSILON>Math.abs(e);var ft=(e,t)=>(p=1/t,Math.round(e*p)/p);var o=(e=0,t=0)=>({x:e,y:t}),h=o;o.clone=e=>o(e.x,e.y);o.fromRectXY=e=>o(e.x,e.y);o.fromRectWH=e=>o(e.w,e.h);o.fromRectRB=e=>o(e.x+e.w,e.y+e.h);o.of=e=>o(e,e);o.random=(e=1)=>o.Smul(e,o.complement(o.Smul(2,o(Math.random(),Math.random()))));o.toA=e=>[e.x,e.y];o.polar=(e,t)=>o(t*Math.cos(e),t*Math.sin(e));o.x=Object.freeze(o(1));o.y=Object.freeze(o(0,1));o.zero=Object.freeze(o());o.map=(e,t)=>o(e(t.x),e(t.y));o.map2=(e,t,s)=>o(e(t.x,s.x),e(t.y,s.y));o.reduce=(e,t)=>e(t.x,t.y);o.cross=(e,t)=>e.x*t.y-e.y*t.x;o.project=(e,t)=>o.mulS(t,o.dot(e,t)/o.len2(t));o.reject=(e,t)=>o.sub(e,o.project(e,t));o.scalarProjection=(e,t,s)=>{let i=o.sub(e,t),n=o.normalize(o.sub(s,t)),r=o.mulS(n,o.dot(i,n));return o.add(t,r)};o.add=(e,t)=>o(e.x+t.x,e.y+t.y);o.div=(e,t)=>o(e.x/t.x,e.y/t.y);o.mul=(e,t)=>o(e.x*t.x,e.y*t.y);o.sub=(e,t)=>o(e.x-t.x,e.y-t.y);o.addS=(e,t)=>o.add(e,o.of(t));o.divS=(e,t)=>o.div(e,o.of(t));o.mulS=(e,t)=>o.mul(e,o.of(t));o.subS=(e,t)=>o.sub(e,o.of(t));o.Sadd=(e,t)=>o.add(o.of(e),t);o.Sdiv=(e,t)=>o.div(o.of(e),t);o.Smul=(e,t)=>o.mul(o.of(e),t);o.Ssub=(e,t)=>o.sub(o.of(e),t);o.dist=(e,t)=>o.len(o.sub(e,t));o.dist2=(e,t)=>o.len2(o.sub(e,t));o.dot=(e,t)=>e.x*t.x+e.y*t.y;o.equal=(e,t)=>pt(o.dist2(e,t));o.len2=e=>o.dot(e,e);o.len=e=>Math.sqrt(o.dot(e,e));o.ceil=e=>o.map(Math.ceil,e);o.floor=e=>o.map(Math.floor,e);o.round=e=>o.map(Math.round,e);o.roundTo=(e,t)=>o.map2(ft,e,o.of(t));o.complement=e=>o.Ssub(1,e);o.half=e=>o.divS(e,2);o.normalize=e=>o.divS(e,o.len(e));o.recip=e=>o.Sdiv(1,e);o.renormalize=(e,t,s,i,n)=>o.add(o.mul(o.div(o.sub(e,t),o.sub(s,t)),o.sub(n,i)),i);o.avg=(e,t)=>o.half(o.add(e,t));o.lerp=(e,t,s)=>o.add(e,o.Smul(s,o.sub(t,e)));o.max=(e,t)=>o.map2(Math.max,e,t);o.min=(e,t)=>o.map2(Math.min,e,t);o.abs=e=>o.map(Math.abs,e);o.invert=e=>o(-e.x,-e.y);o.invertX=e=>o(-e.x,e.y);o.invertY=e=>o(e.x,-e.y);o.rotate90CW=e=>o(e.y,-e.x);o.rotate90CCW=e=>o(-e.y,e.x);o.rotate=(e,t)=>o(e.x*Math.cos(t)-e.y*Math.sin(t),e.x*Math.sin(t)+e.y*Math.cos(t));o.rotateAround=(e,t,s)=>{let i=o.sub(e,t),n=o.rotate(i,s);return o.add(n,t)};o.angle=e=>Math.atan2(e.y,e.x);o.angleBetween=(e,t)=>{let s=o.dot(e,t),i=o.len(e),n=o.len(t);return Math.acos(s/(i*n))*180/Math.PI};o.angleBetweenClockwise=(e,t)=>{let s=o.dot(e,t),i=o.cross(e,t),r=Math.atan2(s,i)*(180/Math.PI);return r<0&&(r=360+r),r};o.update=(e,t)=>{e.x=t.x,e.y=t.y};var Lt=0;function b(){return Lt++}var q=class{constructor(t,s,i,n){this.id=b(),this.a=s,this.b=i,this.c=n,this.dirty=!0,this.selected=!1,this.radius=h.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let r={d:this.path,"stroke-width":1,stroke:"black",fill:"none"};this.elements={normal:t.addElement("path",r),selected:t.addElement("path",{...r,"stroke-width":7,stroke:"none"})}}updatePath(){this.path=`M ${this.a.position.x} ${this.a.position.y} A ${this.radius}  ${this.radius} ${this.xAxisRotation} ${this.isLargeArc} ${this.clockwise} ${this.b.position.x} ${this.b.position.y}`}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty||this.c.dirty){this.radius=h.dist(this.a.position,this.c.position),this.isLargeArc=0,this.clockwise=1,this.xAxisRotation=0,this.updatePath();let s={d:this.path};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},ut=q;var N=class{constructor(t,s,i){this.id=b(),this.a=s,this.b=i,this.dirty=!0,this.selected=!1;let n={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y,"stroke-width":1,stroke:"black"};this.elements={normal:t.addElement("line",n),selected:t.addElement("line",{...n,"stroke-width":7,stroke:"none"})}}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}render(t){if(this.dirty||this.a.dirty||this.b.dirty){let s={x1:this.a.position.x,y1:this.a.position.y,x2:this.b.position.x,y2:this.b.position.y};t.updateElement(this.elements.normal,s),t.updateElement(this.elements.selected,{...s,stroke:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1}}},gt=N;var{min:Jt,PI:$t}=Math;var te=$t+1e-4;var B=class{constructor(t=document.body){this.root=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.updateElement(this.root,{xmlns:"http://www.w3.org/2000/svg",width:window.innerWidth,height:window.innerHeight}),t.appendChild(this.root)}addElement(t,s){let i=document.createElementNS("http://www.w3.org/2000/svg",t);return this.updateElement(i,s),this.root.appendChild(i),i}updateElement(t,s){Object.entries(s).forEach(([i,n])=>t.setAttribute(i,n))}},mt=B;function j(e){return Ot(e)}function Ot(e){let t=[],s="M";for(let i of e){if(i==null){s="M";continue}t.push(`${s} ${i.x} ${i.y}`),s="L"}return t.filter(i=>i!=null).join(" ")}var G={stroke:"rgba(0, 0, 0, .5)",fill:"none","stroke-width":2},_=class{constructor(t,s,i,n){this.id=b();let[r,l]=Vt(s.filter(d=>d!=null));i.setPosition(r),n.setPosition(l),this.controlPoints=[i,n];let a=h.dist(r,l),c=this.currentAngle();this.pointData=s.map(d=>d==null?d:{lengthMultiplier:h.dist(r,d)/a,angleOffset:h.angle(h.sub(d,r))-c,pressure:d.pressure}),this.element=t.addElement("path",{d:"",...G}),this.dirty=!0}currentAngle(){return h.angle(h.sub(this.controlPoints[1].position,this.controlPoints[0].position))}updatePath(t){let s=h.dist(this.controlPoints[0].position,this.controlPoints[1].position),i=this.currentAngle(),n=this.pointData.map(l=>l==null?null:(({lengthMultiplier:a,angleOffset:c,pressure:d})=>{let f=h.add(this.controlPoints[0].position,h.polar(i+c,s*a));return f.pressure=d,f})(l)),r=j(n);t.updateElement(this.element,{d:r})}onControlPointMove(t){this.dirty=!0}render(t){!this.dirty||(this.updatePath(t),this.dirty=!1)}},yt=_;function Vt(e){let t=-Infinity,s=null,i=null;for(let n of e)for(let r of e){let l=h.dist(n,r);l>t&&(s=n,i=r,t=l)}return[s,i]}var H=class{constructor(t,s){this.id=b(),this.position=s,this.dirty=!0,this.selected=!1,this.elements={normal:t.addElement("circle",{cx:0,cy:0,r:3,fill:"black"}),selected:t.addElement("circle",{cx:0,cy:0,r:7,fill:"none"})}}setPosition(t){this.dirty=!0,this.position=t}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}remove(){this.elements.normal.remove(),this.elements.selected.remove()}render(t){this.dirty&&(t.updateElement(this.elements.normal,{transform:`translate(${this.position.x} ${this.position.y})`}),t.updateElement(this.elements.selected,{transform:`translate(${this.position.x} ${this.position.y})`,fill:this.selected?"rgba(180, 134, 255, 0.42)":"none"}),this.dirty=!1)}},V=H;var W=class extends V{constructor(t,s){super(t,s);this.parent=null,t.updateElement(this.elements.normal,{r:5,fill:"rgba(100, 100, 100, .2)"})}setPosition(t){super.setPosition(t),this.parent?.onControlPointMove(this)}},xt=W;var Z=class{constructor(t,s){this.id=b(),this.firstPosition=s,this.position=s,this.morphVector=h(0,0),this.angle=0,this.dirty=!0,this.selected=!1,this.elements={normal:t.addElement("circle",{cx:0,cy:0,r:30,fill:"none",stroke:"lightgrey"}),ghost:t.addElement("circle",{cx:0,cy:0,r:30,fill:"none",stroke:"lightgrey"}),line:t.addElement("line",{x1:0,y1:0,x2:0,y2:0,stroke:"lightgrey"}),rotationLine:t.addElement("line",{x1:0,y1:0,x2:0,y2:0,stroke:"lightgrey"})}}setPosition(t){this.dirty=!0,this.position=t,this.morphVector=h.sub(this.position,this.firstPosition)}select(){this.dirty=!0,this.selected=!0}deselect(){this.dirty=!0,this.selected=!1}remove(){this.elements.normal.remove()}render(t){if(!this.dirty)return;t.updateElement(this.elements.normal,{transform:`translate(${this.position.x} ${this.position.y})`});let s=h.add(this.position,h.polar(this.angle,60));t.updateElement(this.elements.rotationLine,{x1:this.position.x,y1:this.position.y,x2:s.x,y2:s.y}),t.updateElement(this.elements.ghost,{transform:`translate(${this.firstPosition.x} ${this.firstPosition.y})`}),t.updateElement(this.elements.line,{x1:this.position.x,y1:this.position.y,x2:this.firstPosition.x,y2:this.firstPosition.y}),this.dirty=!1}},Pt=Z;var Q=class{constructor(t){this.svg=t,this.points=[],this.morphPoints=[],this.lineSegments=[],this.freehandStrokes=[]}addPoint(t){let s=new V(this.svg,t);return this.points.push(s),s}addControlPoint(t,s){let i=new xt(this.svg,t,s);return this.points.push(i),i}addLineSegment(t,s){let i=new gt(this.svg,t,s);return this.lineSegments.push(i),i}addArcSegment(t,s,i){let n=new ut(this.svg,t,s,i);return this.lineSegments.push(n),n}addMorphPoint(t){let s=new Pt(this.svg,t);return this.morphPoints.push(s),s}addFreehandStroke(t){let s=this.addControlPoint(t[0]),i=this.addControlPoint(t[t.length-1]),n=new yt(this.svg,t,s,i);return s.parent=n,i.parent=n,this.freehandStrokes.push(n),n}findPointNear(t,s=20){let i=null,n=s;for(let r of this.points){let l=h.dist(r.position,t);l<n&&(n=l,i=r)}return i}findMorphPointNear(t,s=20){let i=null,n=s;for(let r of this.morphPoints){let l=h.dist(r.position,t);l<n&&(n=l,i=r)}return i}mergePoint(t){}pointsReachableFrom(t){let s=new Set(t);for(;;){let i=s.size;for(let n of this.lineSegments)s.has(n.a)&&s.add(n.b),s.has(n.b)&&s.add(n.a);for(let n of this.freehandStrokes)s.has(n.controlPoints[0])&&s.add(n.controlPoints[1]),s.has(n.controlPoints[1])&&s.add(n.controlPoints[0]);if(s.size===i)break}return s}render(t){let s=i=>i.render(t);this.lineSegments.forEach(s),this.freehandStrokes.forEach(s),this.points.forEach(s),this.morphPoints.forEach(s)}},bt=Q;var Rt=Math.PI/180,Ct=180/Math.PI,D=class{constructor(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}reset(){this.a=1,this.b=0,this.c=0,this.d=1,this.e=0,this.f=0}transform(t,s,i,n,r,l){let{a,b:c,c:d,d:f,e:g,f:u}=this;return this.a=a*t+d*s,this.b=c*t+f*s,this.c=a*i+d*n,this.d=c*i+f*n,this.e=a*r+d*l+g,this.f=c*r+f*l+u,this}rotate(t){let s=Math.cos(t),i=Math.sin(t);return this.transform(s,i,-i,s,0,0),this}rotateDegrees(t){return this.rotate(t*Rt),this}scale(t,s){return this.transform(t,0,0,s,0,0),this}skew(t,s){return this.transform(1,s,t,1,0,0),this}translate(t,s){return this.transform(1,0,0,1,t,s),this}flipX(){return this.transform(-1,0,0,1,0,0),this}flipY(){return this.transform(1,0,0,-1,0,0),this}inverse(){let{a:t,b:s,c:i,d:n,e:r,f:l}=this,a=t*n-s*i;return this.a=n/a,this.b=-s/a,this.c=-i/a,this.d=t/a,this.e=(i*l-n*r)/a,this.f=-(t*l-s*r)/a,this}getInverse(){let{a:t,b:s,c:i,d:n,e:r,f:l}=this,a=new D,c=t*n-s*i;return a.a=n/c,a.b=-s/c,a.c=-i/c,a.d=t/c,a.e=(i*l-n*r)/c,a.f=-(t*l-s*r)/c,a}getPosition(){return{x:this.e,y:this.f}}getRotation(){let t=(this.a+this.d)/2,s=(this.a-this.d)/2,i=(this.c+this.b)/2,n=(this.c-this.b)/2,r=Math.atan2(i,s);return-((Math.atan2(n,t)+r)/2)*Ct}getScale(){let t=(this.a+this.d)/2,s=(this.a-this.d)/2,i=(this.c+this.b)/2,n=(this.c-this.b)/2,r=Math.sqrt(t*t+n*n),l=Math.sqrt(s*s+i*i);return{scaleX:r+l,scaleY:r-l}}transformMatrix(t){let{a:s,b:i,c:n,d:r,e:l,f:a}=this,c=t.a,d=t.b,f=t.c,g=t.d,u=t.e,m=t.f,y=new D;return y.a=s*c+n*d,y.b=i*c+r*d,y.c=s*f+n*g,y.d=i*f+r*g,y.e=s*u+n*m+l,y.f=i*u+r*m+a,y}transformPoint(t){let{x:s,y:i}=t,{a:n,b:r,c:l,d:a,e:c,f:d}=this;return h(s*n+i*l+c,s*r+i*a+d)}transformLine(t){return{a:this.transformPoint(t.a),b:this.transformPoint(t.b)}}fromLine(t,s){let i=h.sub(s,t);return this.translate(t.x,t.y),this.rotate(h.angle(i)),this}},R=D;var K=class{constructor(t,s){this.page=t,this.snaps=s,this.points=new Set,this.origPosition=new Map,this.tappedOn=null,this.firstFinger=null,this.firstFingerMoved=null,this.secondFinger=null,this.secondFingerMoved=null}update(t){let s=t.did("finger","began");if(s)if(this.firstFinger){this.secondFinger=s,this.secondFingerMoved=s;let i=new R,n=h.divS(h.add(this.firstFingerMoved.position,this.secondFinger.position),2),r=this.secondFinger.position;i.fromLine(n,r).inverse();for(let l of this.points)this.origPosition.set(l,i.transformPoint(l.position))}else{this.firstFinger=s,this.firstFingerMoved=s;let i=this.page.findPointNear(s.position);i?(this.selectPoint(i),this.tappedOn=i):this.tappedOn=null;let n=new R,r=s.position;n.translate(r.x,r.y).inverse();for(let l of this.points)this.origPosition.set(l,n.transformPoint(l.position))}if(this.firstFinger){let i=t.didLast("finger","moved",this.firstFinger.id);i&&(this.firstFingerMoved=i,this.transformSelection());let n=t.did("finger","ended",this.firstFinger.id);if(n){n.timestamp-this.firstFinger.timestamp<.2?this.tappedOn==null&&this.clearSelection():this.tappedOn!=null&&this.points.size===1&&this.clearSelection();for(let l of this.points)this.page.mergePoint(l);this.firstFinger=null,this.firstFingerMoved=null,this.secondFinger=null,this.secondFingerMoved=null,this.snaps.clear()}}if(this.secondFinger){let i=t.did("finger","moved",this.secondFinger.id);i&&(this.secondFingerMoved=i,this.transformSelection()),t.did("finger","ended",this.secondFinger.id)&&(this.secondFinger=null,this.secondFingerMoved=null,this.firstFinger=null,this.firstFingerMoved=null)}}selectPoint(t){this.points.add(t),t.select();for(let s of this.page.lineSegments)this.points.has(s.a)&&this.points.has(s.b)?s.select():s.deselect()}clearSelection(){for(let t of this.points)t.deselect();this.points=new Set,this.origPosition=new Map;for(let t of this.page.lineSegments)t.deselect()}transformSelection(){let t=new R;if(this.firstFingerMoved&&this.secondFingerMoved){let n=h.divS(h.add(this.firstFingerMoved.position,this.secondFingerMoved.position),2),r=this.secondFingerMoved.position;t.fromLine(n,r)}else{let n=this.firstFingerMoved.position;t.translate(n.x,n.y)}let s=new Map;for(let n of this.points){let r=this.origPosition.get(n),l=t.transformPoint(r);s.set(n,l)}let i=this.snaps.snapPositions(s);for(let n of this.points)n.setPosition(i.get(n))}},St=K;var J=class{constructor(t){this.page=t,this.activeSnaps=[],this.snapSvgElementById=new Map,this.dirty=!1}snapPositions(t){let s=[],i=new Map,n=this.page.points.filter(a=>!t.has(a)),r=Array.from(t.keys()),l=this.page.pointsReachableFrom(r);for(let[a,c]of t){if(s.some(g=>g.snapPoint===a)){i.set(a,c);continue}let d=[];for(let g of n){let u=h.sub(g.position,c);if(h.len(u)<10){d.push(u),s.push(new Mt(a,g));break}}if(d.length===0){for(let g of l){if(g===a)continue;let u=g.position.x-c.x;if(Math.abs(u)<10){let m=h(u,0);d.push(m),s.push(new tt(a,g));break}}for(let g of l){if(g===a)continue;let u=g.position.y-c.y;if(Math.abs(u)<10){let m=h(0,u);d.push(m),s.push(new tt(a,g));break}}}let f=d.reduce((g,u)=>h.add(g,u),c);i.set(a,f)}return this.setActiveSnaps(s),i}setActiveSnaps(t){this.activeSnaps=t,this.dirty=!0;let s=new Set(t.map(i=>i.id));for(let[i,n]of this.snapSvgElementById)s.has(i)||(n.remove(),this.snapSvgElementById.delete(i))}clear(){this.setActiveSnaps([])}render(t){if(!!this.dirty){for(let s of this.activeSnaps){let i=s.id,{shapeType:n,shapeData:r}=s.getShape(),l=this.snapSvgElementById.get(i);l==null?(l=t.addElement(n,{...r,fill:"none",stroke:"rgb(180, 134, 255)"}),this.snapSvgElementById.set(i,l)):t.updateElement(l,r)}this.dirty=!1}}},vt=J,et=class{constructor(t,s){this.point=t,this.snapPoint=s,this.id=`${t.id}.${s.id}.${this.constructor.name}`}getShape(){throw new Error("subclass responsibility!")}},Mt=class extends et{constructor(t,s){super(t,s)}getShape(){return{shapeType:"circle",shapeData:{cx:this.point.position.x,cy:this.point.position.y,r:7}}}},tt=class extends et{constructor(t,s){super(t,s)}getShape(){return{shapeType:"line",shapeData:{x1:this.point.position.x,y1:this.point.position.y,x2:this.snapPoint.position.x,y2:this.snapPoint.position.y}}}};var st=class{constructor(t,s){this.selectedIdx=0,this.tools=s,this.dirty=!1,this.buttons=[t.addElement("circle",{cx:30,cy:30,r:20,fill:"black"}),t.addElement("circle",{cx:30,cy:80,r:20,fill:"lightgrey"}),t.addElement("circle",{cx:30,cy:130,r:20,fill:"lightgrey"})]}get selected(){return this.tools[this.selectedIdx]}update(t){let s=t.did("finger","began");if(s==null)return;let i=[30,80,130].findIndex(n=>h.dist(h(30,n),s.position)<20);i!==-1&&(this.selectedIdx=i,this.dirty=!0)}render(t){this.dirty&&(console.log("update"),this.buttons.forEach((s,i)=>t.updateElement(s,{fill:this.selectedIdx===i?"black":"lightgrey"})),this.dirty=!1)}},wt=st;function A(e,t,s,i,n=!0){return{center:e,radius:t,startAngle:s,endAngle:i,clockwise:n}}var S=A;A.len=e=>{let{radius:t,startAngle:s,endAngle:i}=e;return t*Math.abs(i-s)};A.distToPointCircle=(e,t)=>{let s=h.dist(e.center,t);return Math.abs(s-e.radius)};A.spreadPointsAlong=(e,t)=>{let s=[],n=A.directedInnerAngle(e)/(t-1);for(let r=0;r<t;r++){let l=e.startAngle+n*r,a=h(e.radius*Math.cos(l),e.radius*Math.sin(l));s.push(h.add(e.center,a))}return s};A.directedInnerAngle=e=>{let t=e.endAngle-e.startAngle;return e.clockwise&&t<0?2*Math.PI-Math.abs(t):!e.clockwise&&t>0?-2*Math.PI+Math.abs(t):t};A.points=e=>{console.log(e);let t=h.add(e.center,h.polar(e.startAngle,e.radius)),s=h.add(e.center,h.polar(e.endAngle,e.radius));return{start:t,end:s}};var x=(e,t)=>({a:e,b:t}),k=x;x.len=e=>h.dist(e.a,e.b);x.directionVec=e=>h.normalize(h.sub(e.b,e.a));x.intersect=(e,t)=>{let{a:s,b:i}=e,{a:n,b:r}=t,l=i.x-s.x,a=i.y-s.y,c=r.x-n.x,d=r.y-n.y,f=l*d-a*c;if(f===0)return null;let g=s.x-n.x,u=s.y-n.y,m=(g*d-u*c)/f,y=(l*u-a*g)/f;if(m>=0&&m<=1&&y>=0&&y<=1){let w=s.x+m*l,F=s.y+m*a;return{x:w,y:F}}return null};x.intersectAnywhere=(e,t)=>{let{a:s,b:i}=e,{a:n,b:r}=t,l=i.x-s.x,a=i.y-s.y,c=r.x-n.x,d=r.y-n.y,f=l*d-a*c;if(f===0)return null;let g=s.x-n.x,u=s.y-n.y,m=(g*d-u*c)/f,y=(l*u-a*g)/f,w=s.x+m*l,F=s.y+m*a;return{x:w,y:F}};x.getYforX=(e,t)=>{let{a:s,b:i}=e,{x:n,y:r}=s,{x:l,y:a}=i;return(a-r)/(l-n)*(t-n)+r};x.getXforY=(e,t)=>{let{a:s,b:i}=e,{x:n,y:r}=s,{x:l,y:a}=i,c=(a-r)/(l-n);return(t-r)/c+n};x.distToPoint=(e,t)=>h.dist(t,x.closestPoint(e,t));x.closestPoint=(e,t,s=!0)=>{let{a:i,b:n}=e,r=h.sub(n,i),l=h.sub(t,i),a=h.dot(l,r)/h.dot(r,r);return s&&a<=0?i:s&&a>=1?n:h.add(i,h.mulS(r,a))};x.spreadPointsAlong=(e,t)=>{let s=x.len(e)/t,i=h.mulS(x.directionVec(e),s),n=[];for(let r=0;r<t;r++)n.push(h.add(e.a,h.mulS(i,r)));return n};var T={},C=T;T.line=e=>{if(e.length===0)return null;let t=k(h.clone(e[0]),h.clone(e[e.length-1])),s=0;for(let n=1;n<e.length-1;n++)s+=k.distToPoint(t,e[n]);let i=k.len(t);return{type:"line",line:t,fitness:i===0?1:s/i,length:i}};T.arc=e=>{if(e.length<3)return null;let t=T.innerTriangle(e),[s,i,n]=t;if(!i)return null;let{x:r,y:l}=s,{x:a,y:c}=i,{x:d,y:f}=n,g=2*(r*(c-f)+a*(f-l)+d*(l-c)),u=((r*r+l*l)*(c-f)+(a*a+c*c)*(f-l)+(d*d+f*f)*(l-c))/g,m=((r*r+l*l)*(d-a)+(a*a+c*c)*(r-d)+(d*d+f*f)*(a-r))/g,y=Math.sqrt((r-u)*(r-u)+(l-m)*(l-m)),w=Math.atan2(l-m,r-u),F=Math.atan2(f-m,d-u),L=h.sub(s,i),z=h.sub(i,n),P=h.cross(L,z)>0,E=S(h(u,m),y,w,F,P),$=S.len(E),O=0;for(let X of e)O+=S.distToPointCircle(E,X);return{type:"arc",arc:E,fitness:O/$,length:$}};T.innerTriangle=e=>{let t=e[0],s=e[e.length-1],i=-1,n=-1;for(let r=0;r<e.length;r++){let l=e[r],a=k.distToPoint(k(t,s),l);a>i&&(i=a,n=r)}return[t,e[n],s]};T.circle=e=>{if(e.length<3)return null;let t=e.length,s=0,i=0,n=0,r=0,l=0,a=0,c=0,d=0,f=0;for(let Y of e){let{x:M,y:v}=Y;s+=M,i+=v,n+=M*M,r+=v*v,l+=M*v,a+=M*M*M,c+=v*v*v,d+=M*v*v,f+=M*M*v}let g=t*n-s*s,u=t*l-s*i,m=t*a+t*d-(n+r)*s,y=t*r-i*i,w=t*f+t*c-(n+r)*i,F=(w*u-m*y)/(g*y-u*u),L=(w*g-m*u)/(u*u-y*g),z=-(F*s+L*i+n+r)/t,P=h(-F/2,-L/2),E=Math.sqrt(P.x*P.x+P.y*P.y-z),$=Math.atan2(e[0].y-P.y,e[0].x-P.x),O=Math.atan2(e[e.length-1].y-P.y,e[e.length-1].x-P.x),X=h.sub(e[0],e[1]),jt=h.sub(e[1],e[2]),Dt=h.cross(X,jt)>0,lt={center:P,radius:E,startAngle:$,endAngle:O,clockwise:Dt},ht=0;for(let Y of e)ht+=S.distToPointCircle(lt,Y);let Tt=2*Math.PI*E;return{type:"circle",circle:lt,fitness:ht/Tt}};var it=class{constructor(t,s){this.page=t,this.snaps=s,this.element=null,this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.speed=0,this.maxSpeed=0,this.previousPosition=null,this.mode="unknown",this.fit=null,this.fixedStroke=null}update(t){let s=t.did("pencil","began");if(s&&(this.inputPoints=[s.position],this.renderPoints=[h.clone(s.position)],this.speed=0,this.maxSpeed=0,this.previousPosition=s.position,this.mode="unknown",this.dirty=!0),t.didAll("pencil","moved").forEach(r=>{let l=h.dist(this.previousPosition,r.position),a=.05;if(this.speed=a*l+(1-a)*this.speed,this.maxSpeed=Math.max(this.maxSpeed,this.speed),this.previousPosition=r.position,this.mode!=="fixed")this.inputPoints.push(r.position),this.renderPoints.push(h.clone(r.position)),this.mode==="guess"&&this.doFit();else{let c=r.position,d=new Map;d.set(this.fixedStroke.a,this.fixedStroke.a.position),d.set(this.fixedStroke.b,c);let f=this.snaps.snapPositions(d);this.fixedStroke.a.setPosition(f.get(this.fixedStroke.a)),this.fixedStroke.b.setPosition(f.get(this.fixedStroke.b))}this.mode==="unknown"&&this.inputPoints.length>100&&(this.mode="guess"),this.mode!=="fixed"&&this.inputPoints.length>10&&this.speed<Math.min(1,this.maxSpeed)&&(this.doFit(),this.createStroke(),this.clearGuess(),this.mode="fixed"),this.dirty=!0}),t.did("pencil","ended")&&(this.mode!=="fixed"&&(this.doFit(),this.createStroke(),this.clearGuess()),this.page.mergePoint(this.fixedStroke.a),this.page.mergePoint(this.fixedStroke.b),this.fixedStroke=null,this.mode="unknown",this.snaps.clear()),this.idealPoints&&this.renderPoints.length===this.idealPoints.length)for(let r=0;r<this.idealPoints.length;r++)this.renderPoints[r]=h.lerp(this.idealPoints[r],this.renderPoints[r],.8)}doFit(){let t=C.line(this.inputPoints),s=C.arc(this.inputPoints),i=C.circle(this.inputPoints);this.fit=t,s!=null&&Math.abs(S.directedInnerAngle(s.arc))>.4*Math.PI&&(t==null||s.fitness<t.fitness)&&(this.fit=s,i!=null&&Math.abs(S.directedInnerAngle(s.arc))>1.5*Math.PI&&i.circle.radius<500&&i.fitness<s.fitness&&(this.fit=i)),this.fit!=null&&this.updateIdeal()}createStroke(){if(this.fit.type==="line"){let t=this.page.addPoint(this.fit.line.a),s=this.page.addPoint(this.fit.line.b),i=this.page.addLineSegment(t,s);this.fixedStroke=i}else if(this.fit.type==="arc"){let{start:t,end:s}=S.points(this.fit.arc),i=this.page.addPoint(t),n=this.page.addPoint(s),r=this.page.addPoint(this.fit.arc.center),l=this.page.addArcSegment(i,n,r);this.fixedStroke=l}}clearGuess(){this.inputPoints=null,this.idealPoints=null,this.renderPoints=null,this.element.remove(),this.element=null}updateIdeal(){this.fit.type==="line"?this.idealPoints=k.spreadPointsAlong(this.fit.line,this.inputPoints.length):this.fit.type==="arc"?this.idealPoints=S.spreadPointsAlong(this.fit.arc,this.inputPoints.length):this.fit.type==="circle"&&(this.idealPoints=S.spreadPointsAlong(this.fit.circle,this.inputPoints.length))}render(t){if(!!this.dirty){if(this.renderPoints){this.element||(this.element=t.addElement("path",{d:"",stroke:"black",fill:"none"}));let s=j(this.renderPoints);t.updateElement(this.element,{d:s})}this.dirty=!1}}},Ft=it;var nt=class{constructor(t,s){this.page=t,this.points=null,this.element=s.addElement("path",{d:"",...G}),this.pencilIsDown=!1,this.fingerId=null,this.dirty=!1}update(t){let s=t.did("finger","began");s!=null&&(this.fingerId==null?(console.log(s.id,"down"),this.points==null&&(this.fingerId=s.id)):console.log(s.id,"(down)"));for(let l of t.didAll("finger","ended"))l.id===this.fingerId?(console.log(l.id,"up"),this.fingerId=null):console.log(l.id,"(up)");let i=t.did("pencil","began");if(i!=null&&(this.pencilIsDown=!0,this.points==null?this.startStroke({...i.position,pressure:i.pressure}):(this.extendStroke(null),this.extendStroke({...i.position,pressure:i.pressure}))),this.points==null)return;t.didAll("pencil","moved").forEach(l=>{this.extendStroke({...l.position,pressure:l.pressure})}),t.did("pencil","ended")!=null&&(this.pencilIsDown=!1),this.fingerId==null&&!this.pencilIsDown&&this.endStroke()}startStroke(t){this.points=[t],this.dirty=!0}extendStroke(t){this.points.push(t),this.dirty=!0}endStroke(){this.page.addFreehandStroke(this.points),this.points=null,this.dirty=!0}render(t){if(!!this.dirty){try{let s=this.points==null?"":j(this.points);t.updateElement(this.element,{d:s})}catch(s){throw console.log("offending",this.points),s}this.dirty=!1}}},kt=nt;var ot=class{constructor(t,s){this.page=t,this.svg=s,this.points=[],this.element=null}update(t){let s=t.did("pencil","began");s&&(this.points=[s.position]);let i=t.did("pencil","moved");i&&this.points.push(i.position);let n=t.did("pencil","ended")}render(t){}},At=ot;var rt=class{constructor(){this.svg=new mt,this.page=new bt(this.svg),this.snaps=new vt(this.page),this.selection=new St(this.page,this.snaps),this.tools=[new kt(this.page,this.svg),new Ft(this.page,this.snaps),new At(this.page)],this.toolPicker=new wt(this.svg,this.tools)}update(t){this.toolPicker.update(t),this.toolPicker.selected.update(t),this.selection.update(t)}render(){this.toolPicker.render(this.svg),this.tools[this.toolPicker.selectedIdx].render(this.svg),this.snaps.render(this.svg),this.page.render(this.svg)}},Et=rt;var It=new Et;U(e=>{It.update(e),It.render()});
//# sourceMappingURL=main.js.map
