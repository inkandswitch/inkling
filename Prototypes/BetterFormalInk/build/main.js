var j={pencil:[],touches:{}};window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([i,n])=>{n.forEach(r=>{r.type==="pencil"?j.pencil.push({type:e,x:r.x,y:r.y}):(j.touches[i]||(j.touches[i]=[]),j.touches[i].push({type:e,x:r.x,y:r.y,timestamp:r.timestamp}))})})};var J=null;function K(){J(j),j.pencil=[],j.touches={},window.requestAnimationFrame(K)}var $=e=>{J=e,window.requestAnimationFrame(K)};var tt=class{constructor(t,i){this.canvas=document.createElement("canvas"),t.appendChild(this.canvas);let n=window.devicePixelRatio,r=t.getBoundingClientRect();this.canvas.width=r.width*n,this.canvas.height=r.height*n,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(n,n),this.callback=i,i(this.ctx)}render(){this.callback(this.ctx)}},et=tt;var Pt=Math.PI*2,st=e=>Number.EPSILON>Math.abs(e);var it=(e,t)=>(p=1/t,Math.round(e*p)/p);var s=(e=0,t=0)=>({x:e,y:t}),o=s;s.clone=e=>s(e.x,e.y);s.fromRectXY=e=>s(e.x,e.y);s.fromRectWH=e=>s(e.w,e.h);s.fromRectRB=e=>s(e.x+e.w,e.y+e.h);s.of=e=>s(e,e);s.random=(e=1)=>s.Smul(e,s.complement(s.Smul(2,s(Math.random(),Math.random()))));s.toA=e=>[e.x,e.y];s.polar=(e,t)=>s(t*Math.cos(e),t*Math.sin(e));s.x=Object.freeze(s(1));s.y=Object.freeze(s(0,1));s.zero=Object.freeze(s());s.map=(e,t)=>s(e(t.x),e(t.y));s.map2=(e,t,i)=>s(e(t.x,i.x),e(t.y,i.y));s.reduce=(e,t)=>e(t.x,t.y);s.cross=(e,t)=>e.x*t.y-e.y*t.x;s.project=(e,t)=>s.mulS(t,s.dot(e,t)/s.len2(t));s.reject=(e,t)=>s.sub(e,s.project(e,t));s.scalarProjection=(e,t,i)=>{let n=s.sub(e,t),r=s.normalize(s.sub(i,t)),l=s.mulS(r,s.dot(n,r));return s.add(t,l)};s.add=(e,t)=>s(e.x+t.x,e.y+t.y);s.div=(e,t)=>s(e.x/t.x,e.y/t.y);s.mul=(e,t)=>s(e.x*t.x,e.y*t.y);s.sub=(e,t)=>s(e.x-t.x,e.y-t.y);s.addS=(e,t)=>s.add(e,s.of(t));s.divS=(e,t)=>s.div(e,s.of(t));s.mulS=(e,t)=>s.mul(e,s.of(t));s.subS=(e,t)=>s.sub(e,s.of(t));s.Sadd=(e,t)=>s.add(s.of(e),t);s.Sdiv=(e,t)=>s.div(s.of(e),t);s.Smul=(e,t)=>s.mul(s.of(e),t);s.Ssub=(e,t)=>s.sub(s.of(e),t);s.dist=(e,t)=>s.len(s.sub(e,t));s.dist2=(e,t)=>s.len2(s.sub(e,t));s.dot=(e,t)=>e.x*t.x+e.y*t.y;s.equal=(e,t)=>st(s.dist2(e,t));s.len2=e=>s.dot(e,e);s.len=e=>Math.sqrt(s.dot(e,e));s.ceil=e=>s.map(Math.ceil,e);s.floor=e=>s.map(Math.floor,e);s.round=e=>s.map(Math.round,e);s.roundTo=(e,t)=>s.map2(it,e,s.of(t));s.complement=e=>s.Ssub(1,e);s.half=e=>s.divS(e,2);s.normalize=e=>s.divS(e,s.len(e));s.recip=e=>s.Sdiv(1,e);s.renormalize=(e,t,i,n,r)=>s.add(s.mul(s.div(s.sub(e,t),s.sub(i,t)),s.sub(r,n)),n);s.avg=(e,t)=>s.half(s.add(e,t));s.lerp=(e,t,i)=>s.add(e,s.Smul(i,s.sub(t,e)));s.max=(e,t)=>s.map2(Math.max,e,t);s.min=(e,t)=>s.map2(Math.min,e,t);s.abs=e=>s.map(Math.abs,e);s.invert=e=>s(-e.x,-e.y);s.invertX=e=>s(-e.x,e.y);s.invertY=e=>s(e.x,-e.y);s.rotate90CW=e=>s(e.y,-e.x);s.rotate90CCW=e=>s(-e.y,e.x);s.rotateAround=(e,t,i)=>{let n=i*Math.PI/180,r=s.sub(e,t),l=s(r.x*Math.cos(n)-r.y*Math.sin(n),r.x*Math.sin(n)+r.y*Math.cos(n));return s.add(l,t)};s.angle=e=>Math.atan2(e.y,e.x);s.angleBetween=(e,t)=>{let i=s.dot(e,t),n=s.len(e),r=s.len(t);return Math.acos(i/(n*r))*180/Math.PI};s.angleBetweenClockwise=(e,t)=>{let i=s.dot(e,t),n=s.cross(e,t),l=Math.atan2(i,n)*(180/Math.PI);return l<0&&(l=360+l),l};s.update=(e,t)=>{e.x=t.x,e.y=t.y};var x=(e,t)=>({a:e,b:t}),y=x;x.len=e=>o.dist(e.a,e.b);x.direction_vec=e=>o.normalize(o.sub(e.b,e.a));x.intersect=(e,t)=>{let{a:i,b:n}=e,{a:r,b:l}=t,a=n.x-i.x,h=n.y-i.y,c=l.x-r.x,u=l.y-r.y,d=a*u-h*c;if(d===0)return null;let g=i.x-r.x,f=i.y-r.y,m=(g*u-f*c)/d,w=(a*f-h*g)/d;if(m>=0&&m<=1&&w>=0&&w<=1){let P=i.x+m*a,v=i.y+m*h;return{x:P,y:v}}return null};x.intersectAnywhere=(e,t)=>{let{a:i,b:n}=e,{a:r,b:l}=t,a=n.x-i.x,h=n.y-i.y,c=l.x-r.x,u=l.y-r.y,d=a*u-h*c;if(d===0)return null;let g=i.x-r.x,f=i.y-r.y,m=(g*u-f*c)/d,w=(a*f-h*g)/d,P=i.x+m*a,v=i.y+m*h;return{x:P,y:v}};x.getYforX=(e,t)=>{let{a:i,b:n}=e,{x:r,y:l}=i,{x:a,y:h}=n;return(h-l)/(a-r)*(t-r)+l};x.getXforY=(e,t)=>{let{a:i,b:n}=e,{x:r,y:l}=i,{x:a,y:h}=n,c=(h-l)/(a-r);return(t-l)/c+r};x.distToPoint=(e,t)=>{let{a:i,b:n}=e,r=o.sub(n,i),l=o.sub(t,i),a=o.dot(l,r)/o.dot(r,r);if(a<=0)return o.len(l);if(a>=1)return o.dist(t,n);{let h=o.add(i,o.mulS(r,a));return o.dist(t,h)}};x.spreadPointsAlong=(e,t)=>{let i=x.len(e)/t,n=o.mulS(x.direction_vec(e),i),r=[];for(let l=0;l<t;l++)r.push(o.add(e.a,o.mulS(n,l)));return r};var O=class{constructor(t){this.page=t,this.a=null,this.b=null}pen_down(t){this.a=t,this.b=o.clone(t)}pen_move(t){this.b=t}pen_up(t){let i=y(this.a,this.b);this.page.add_line(i),this.a=null,this.b=null}render(t){!this.a||(t.lineWidth=1,t.strokeStyle="#000000",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.stroke())}},nt=O;var S=(e,t,i,n,r=!0)=>({center:e,radius:t,startAngle:i,endAngle:n,clockwise:r}),_=S;S.len=e=>{let{radius:t,startAngle:i,endAngle:n}=e;return t*Math.abs(n-i)};S.distToPointCircle=(e,t)=>{let i=o.dist(e.center,t);return Math.abs(i-e.radius)};S.spreadPointsAlong=(e,t)=>{let i=[],r=S.directedInnerAngle(e)/(t-1);for(let l=0;l<t;l++){let a=e.startAngle+r*l,h=o(e.radius*Math.cos(a),e.radius*Math.sin(a));i.push(o.add(e.center,h))}return i};S.directedInnerAngle=e=>{let t=e.endAngle-e.startAngle;return e.clockwise&&t<0?2*Math.PI-Math.abs(t):!e.clockwise&&t>0?-2*Math.PI+Math.abs(t):t};S.points=e=>{console.log(e);let t=o.add(e.center,o.polar(e.startAngle,e.radius)),i=o.add(e.center,o.polar(e.endAngle,e.radius));return{start:t,end:i}};var I={},C=I;I.line=e=>{if(e.length<3)return null;let t=0,i=y(o.clone(e[0]),o.clone(e[e.length-1]));for(let r=1;r<e.length-1;r++)t+=y.distToPoint(i,e[r]);let n=y.len(i);return{type:"line",line:i,fitness:t/n,length:n}};I.arc=e=>{if(e.length<3)return null;let t=I.innerTriangle(e),[i,n,r]=t;if(!n)return null;let l=i.x,a=i.y,h=n.x,c=n.y,u=r.x,d=r.y,g=2*(l*(c-d)+h*(d-a)+u*(a-c)),f=((l*l+a*a)*(c-d)+(h*h+c*c)*(d-a)+(u*u+d*d)*(a-c))/g,m=((l*l+a*a)*(u-h)+(h*h+c*c)*(l-u)+(u*u+d*d)*(h-l))/g,w=Math.sqrt((l-f)*(l-f)+(a-m)*(a-m)),P=Math.atan2(a-m,l-f),v=Math.atan2(d-m,u-f),X=o.sub(t[0],t[1]),B=o.sub(t[1],t[2]),b=o.cross(X,B)>0,k=_(o(f,m),w,P,v,b),Y=_.len(k),z=0;return e.forEach(R=>{z+=_.distToPointCircle(k,R)}),{type:"arc",arc:k,fitness:z/Y,length:Y}};I.innerTriangle=e=>{let t=e[0],i=e[e.length-1];var n=-1,r=-1;for(let l=0;l<e.length;l++){let a=e[l],h=y.distToPoint(y(t,i),a);h>n&&(n=h,r=l)}return[t,e[r],i]};I.circle=e=>{if(e.length<3)return null;let t=e.length,i=0,n=0,r=0,l=0,a=0,h=0,c=0,u=0,d=0;for(let D of e){let{x:M,y:A}=D;i+=M,n+=A,r+=M*M,l+=A*A,a+=M*A,h+=M*M*M,c+=A*A*A,u+=M*A*A,d+=M*M*A}let g=t*r-i*i,f=t*a-i*n,m=t*h+t*u-(r+l)*i,w=t*l-n*n,P=t*d+t*c-(r+l)*n,v=(P*f-m*w)/(g*w-f*f),X=(P*g-m*f)/(f*f-w*g),B=-(v*i+X*n+r+l)/t,b=o(-v/2,-X/2),k=Math.sqrt(b.x*b.x+b.y*b.y-B),Y=Math.atan2(e[0].y-b.y,e[0].x-b.x),z=Math.atan2(e[e.length-1].y-b.y,e[e.length-1].x-b.x),R=o.sub(e[0],e[1]),pt=o.sub(e[1],e[2]),ft=o.cross(R,pt)>0,Q={center:b,radius:k,startAngle:Y,endAngle:z,clockwise:ft},U=0;e.forEach(D=>{U+=_.distToPointCircle(Q,D)});let mt=2*Math.PI*k;return{type:"circle",circle:Q,fitness:U/mt}};var V=Math.PI*.5,T=Math.PI*2,L=class{constructor(t){this.page=t,this.input_points=[],this.ideal_points=[],this.render_points=[],this.velocity=0,this.max_velocity=0,this.prev_pos=null,this.state="unknown",this.fit=null,this.snaps={}}pen_down(t){this.input_points=[t],this.render_points=[o.clone(t)],this.velocity=0,this.max_velocity=0,this.prev_pos=t,this.state="unknown",this.snaps={}}pen_move(t){let i=o.dist(this.prev_pos,t),n=.05;if(this.velocity=n*i+(1-n)*this.velocity,this.max_velocity=Math.max(this.max_velocity,this.velocity),this.prev_pos=t,this.state!="fixed"&&o.dist(this.input_points[this.input_points.length-1],t)>1&&(this.input_points.push(t),this.render_points.push(o.clone(t))),this.state=="unknown"&&this.input_points.length>100&&(this.state="guess"),this.state=="guess"&&this.do_fit(),this.state!="fixed"&&this.input_points.length>10&&this.velocity<1&&this.velocity<this.max_velocity&&(this.do_fit(),this.state="fixed"),this.state=="fixed"&&this.fit&&(this.fit.type=="line"&&(this.fit.line.b=t,this.do_snap(),this.update_ideal()),this.fit.type=="arc")){let r=o.sub(t,this.fit.arc.center),l=Math.atan2(r.y,r.x);this.fit.arc.endAngle=l;let a=o.add(this.fit.arc.center,o.polar(this.fit.arc.startAngle,this.fit.arc.radius)),h=o.dist(this.fit.arc.center,t),c=o.add(a,o.mulS(o.normalize(o.sub(this.fit.arc.center,a)),h));this.fit.arc.radius=h,this.fit.arc.center=c,this.do_snap(),this.update_ideal()}}pen_up(t){this.state="fixed",this.snaps={},this.fit&&this.fit.type=="line"&&this.page.add_line(this.fit.line)}do_fit(){let t=C.line(this.input_points),i=C.arc(this.input_points),n=C.circle(this.input_points);this.arc_fit=i,this.line_fit=t,this.circle_fit=n,this.fit=t,i&&Math.abs(_.directedInnerAngle(i.arc))>.4*Math.PI&&i.fitness<t.fitness&&(this.fit=i,Math.abs(_.directedInnerAngle(i.arc))>1.5*Math.PI&&n&&n.circle.radius<500&&n.fitness<i.fitness&&(this.fit=n)),this.fit&&(this.do_snap(),this.update_ideal())}do_snap(){if(this.snaps={},this.fit.type=="line"){let t=this.fit.line;Math.abs(t.a.x-t.b.x)<20&&(t.b.x=t.a.x,this.snaps.v_snap=y(o.add(t.b,o.mulS(o.sub(t.a,t.b),100)),o.add(t.a,o.mulS(o.sub(t.b,t.a),100)))),Math.abs(t.a.y-t.b.y)<20&&(t.b.y=t.a.y,this.snaps.h_snap=y(o.add(t.b,o.mulS(o.sub(t.a,t.b),100)),o.add(t.a,o.mulS(o.sub(t.b,t.a),100))));let i=this.page.find_point_near(t.a,10);i&&(t.a=i.pos);let n=this.page.find_point_near(t.b,10);n&&(t.b=n.pos)}if(this.fit.type=="arc"){let t=this.fit.arc,i=o.add(this.fit.arc.center,o.polar(this.fit.arc.startAngle,this.fit.arc.radius));Math.abs(i.y-t.center.y)<20&&(t.center.y=i.y,t.startAngle=Math.PI*(t.clockwise?-1:0));let n=(Math.round(t.startAngle/V)*V+T)%T;Math.abs(t.startAngle-n)<.1&&(t.startAngle=n);let r=(Math.round(t.endAngle/V)*V+T)%T;Math.abs(t.endAngle-r)<.1&&(t.endAngle=r)}if(this.fit.type=="circle"){let t=this.fit.circle;Math.abs(t.startAngle-t.endAngle)-T<10&&(t.endAngle=t.endAngle+T)}}update_ideal(){this.fit.type=="line"?this.ideal_points=y.spreadPointsAlong(this.fit.line,this.input_points.length):this.fit.type=="arc"?this.ideal_points=_.spreadPointsAlong(this.fit.arc,this.input_points.length):this.fit.type=="circle"&&(this.ideal_points=_.spreadPointsAlong(this.fit.circle,this.input_points.length))}render(t){if(t.strokeStyle="#000000",this.render_points.length==this.ideal_points.length)for(let n=0;n<this.ideal_points.length;n++)this.render_points[n]=o.lerp(this.ideal_points[n],this.render_points[n],.8);if(t.fillText(this.state,100,100),this.fit&&this.fit.type=="arc"){let n=o.add(this.fit.arc.center,o.polar(this.fit.arc.startAngle,this.fit.arc.radius));t.fillRect(n.x,n.y,4,4)}t.strokeStyle="#D2BBF9",Object.keys(this.snaps).forEach(n=>{let r=this.snaps[n];t.beginPath(),t.moveTo(r.a.x,r.a.y),t.lineTo(r.b.x,r.b.y),t.stroke()}),t.strokeStyle="#000000";let i=this.render_points;if(i.length>1){t.beginPath(),t.moveTo(i[0].x,i[0].y);for(let n=1;n<i.length;n++)t.lineTo(i[n].x,i[n].y);t.stroke()}if(this.state!="fixed"&&(t.strokeStyle="#00000022",i=this.input_points,i.length>1)){t.beginPath(),t.moveTo(i[0].x,i[0].y);for(let n=1;n<i.length;n++)t.lineTo(i[n].x,i[n].y);t.stroke()}this.arc_fit&&(t.beginPath(),t.ellipse(this.arc_fit.arc.center.x,this.arc_fit.arc.center.y,2,2,0,0,Math.PI*2),t.fill())}},rt=L;var W=class{constructor(t){this.page=t,this.selection={points:{},strokes:{}}}touch_down(t,i,n){let r=this.page.find_point_near(t);r&&(this.selection.points[r.id]=r)}touch_move(t,i,n){}touch_up(t,i,n){}render(t){Object.keys(this.selection.points).forEach(i=>{let n=this.selection.points[i];t.fillStyle="#D2BBF9",t.beginPath(),t.ellipse(n.pos.x,n.pos.y,8,8,0,0,Math.PI*2),t.fill()})}},ot=W;var q={filming_mode:!1};var yt=0,lt=q.filming_mode?4:3,F=class{constructor(t){this.id=yt++,this.pos=t||o()}render(t,i="#000000"){t.fillStyle=i,t.beginPath(),t.ellipse(this.pos.x,this.pos.y,lt,lt,0,0,Math.PI*2),t.fill()}},E=F;var gt=q.filming_mode?3:1,_t=0,N=class{constructor(t,i){this.id=_t++,this.a=t,this.b=i}render(t,i="#000000"){t.lineWidth=gt,t.strokeStyle=i,t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.stroke()}},at=N;var bt=0,H=class{constructor(t,i,n){this.id=bt++,this.a=t,this.b=i,this.c=n}render(t){t.lineWidth=1,t.strokeStyle="#000000";let i=o.angle(o.sub(this.a.pos,this.c.pos)),n=o.angle(o.sub(this.b.pos,this.c.pos)),r=o.dist(this.a.pos,this.c.pos);t.beginPath(),t.ellipse(this.c.pos.x,this.c.pos.y,r,r,0,i,n),t.stroke()}},ht=H;var Z=class{constructor(){this.points=[],this.strokes=[]}find_point_near(t,i=20){return this.points.find(n=>o.dist(n.pos,t)<i)}find_stroke_near(t){return this.strokes.find(i=>y.distToPoint(y(i.a.pos,i.b.pos),t)<20)}add_line(t){let i=new E(t.a),n=new E(t.b);this.points.push(i),this.points.push(n),this.strokes.push(new at(i,n))}add_arc(t){let{start:i,end:n}=_.points(t);console.log(i,n);let r=new E(i),l=new E(n),a=new E(t.center);this.points.push(r),this.points.push(l),this.points.push(a),this.strokes.push(new ht(r,l,a))}render(t){this.repeater||(t.beginPath(),t.ellipse(30,30,20,20,0,0,Math.PI*2),t.stroke()),this.strokes.forEach(i=>{i.render(t)}),this.points.forEach(i=>{i.render(t)})}},ct=Z;var G=class{constructor(){this.page=new ct,this.draw_tool=new nt(this.page),this.geometry_tool=new rt(this.page),this.selection=new ot(this.page)}update(t){t.pencil.forEach(i=>{let n=o(i.x,i.y);i.type==="began"?this.geometry_tool.pen_down(n):i.type==="moved"?this.geometry_tool.pen_move(n):i.type==="ended"&&this.geometry_tool.pen_up(n)}),Object.entries(t.touches).forEach(([i,n])=>{n.forEach(r=>{let l=o(r.x,r.y);r.type==="began"?this.selection.touch_down(l,i,r.timestamp):r.type==="moved"?this.selection.touch_move(l,i,r.timestamp):r.type==="ended"&&this.selection.touch_up(l,i,r.timestamp)})})}render(t){this.selection.render(t),this.geometry_tool.render(t),this.page.render(t)}},dt=G;var ut=new dt;console.log("hello world");var xt=new et(document.body,e=>{e.clearRect(0,0,window.innerWidth,window.innerHeight),ut.render(e)});$(e=>{ut.update(e),xt.render()});
//# sourceMappingURL=main.js.map
