var Y=Math.PI*2,S=t=>Number.EPSILON>Math.abs(t);var M=(t,e)=>(p=1/e,Math.round(t*p)/p);var s=(t=0,e=0)=>({x:t,y:e}),o=s;s.clone=t=>s(t.x,t.y);s.fromRectXY=t=>s(t.x,t.y);s.fromRectWH=t=>s(t.w,t.h);s.fromRectRB=t=>s(t.x+t.w,t.y+t.h);s.of=t=>s(t,t);s.random=(t=1)=>s.Smul(t,s.complement(s.Smul(2,s(Math.random(),Math.random()))));s.toA=t=>[t.x,t.y];s.polar=(t,e)=>{let n=t*Math.PI/180;return s(e*Math.cos(n),e*Math.sin(n))};s.x=Object.freeze(s(1));s.y=Object.freeze(s(0,1));s.zero=Object.freeze(s());s.map=(t,e)=>s(t(e.x),t(e.y));s.map2=(t,e,n)=>s(t(e.x,n.x),t(e.y,n.y));s.reduce=(t,e)=>t(e.x,e.y);s.cross=(t,e)=>t.x*e.y-t.y*e.x;s.project=(t,e)=>s.mulS(e,s.dot(t,e)/s.len2(e));s.reject=(t,e)=>s.sub(t,s.project(t,e));s.scalarProjection=(t,e,n)=>{let r=s.sub(t,e),i=s.normalize(s.sub(n,e)),a=s.mulS(i,s.dot(r,i));return s.add(e,a)};s.add=(t,e)=>s(t.x+e.x,t.y+e.y);s.div=(t,e)=>s(t.x/e.x,t.y/e.y);s.mul=(t,e)=>s(t.x*e.x,t.y*e.y);s.sub=(t,e)=>s(t.x-e.x,t.y-e.y);s.addS=(t,e)=>s.add(t,s.of(e));s.divS=(t,e)=>s.div(t,s.of(e));s.mulS=(t,e)=>s.mul(t,s.of(e));s.subS=(t,e)=>s.sub(t,s.of(e));s.Sadd=(t,e)=>s.add(s.of(t),e);s.Sdiv=(t,e)=>s.div(s.of(t),e);s.Smul=(t,e)=>s.mul(s.of(t),e);s.Ssub=(t,e)=>s.sub(s.of(t),e);s.dist=(t,e)=>s.len(s.sub(t,e));s.dist2=(t,e)=>s.len2(s.sub(t,e));s.dot=(t,e)=>t.x*e.x+t.y*e.y;s.equal=(t,e)=>S(s.dist2(t,e));s.len2=t=>s.dot(t,t);s.len=t=>Math.sqrt(s.dot(t,t));s.ceil=t=>s.map(Math.ceil,t);s.floor=t=>s.map(Math.floor,t);s.round=t=>s.map(Math.round,t);s.roundTo=(t,e)=>s.map2(M,t,s.of(e));s.complement=t=>s.Ssub(1,t);s.half=t=>s.divS(t,2);s.normalize=t=>s.divS(t,s.len(t));s.recip=t=>s.Sdiv(1,t);s.renormalize=(t,e,n,r,i)=>s.add(s.mul(s.div(s.sub(t,e),s.sub(n,e)),s.sub(i,r)),r);s.avg=(t,e)=>s.half(s.add(t,e));s.lerp=(t,e,n)=>s.add(t,s.Smul(n,s.sub(e,t)));s.max=(t,e)=>s.map2(Math.max,t,e);s.min=(t,e)=>s.map2(Math.min,t,e);s.abs=t=>s.map(Math.abs,t);s.invert=t=>s(-t.x,-t.y);s.invertX=t=>s(-t.x,t.y);s.invertY=t=>s(t.x,-t.y);s.rotate90CW=t=>s(t.y,-t.x);s.rotate90CCW=t=>s(-t.y,t.x);s.angle=t=>{var e=Math.atan2(t.y,t.x),n=e*180/Math.PI;return n<0&&(n+=360),n};s.angleBetween=(t,e)=>{let n=s.dot(t,e),r=s.len(t),i=s.len(e);return Math.acos(n/(r*i))*180/Math.PI};s.angleBetweenClockwise=(t,e)=>{let n=s.dot(t,e),r=s.cross(t,e),a=Math.atan2(n,r)*(180/Math.PI);return a<0&&(a=360+a),a};var m={pencil:[],touches:{}};window.nativeEvent=(t,e)=>{Object.entries(e).forEach(([n,r])=>{r.forEach(i=>{i.type==="pencil"?m.pencil.push({type:t,x:i.x,y:i.y}):(m.touches[n]||(m.touches[n]=[]),m.touches[n].push({type:t,x:i.x,y:i.y}))})})};var P=null;function j(){P(m),m.pencil=[],m.touches={},window.requestAnimationFrame(j)}var E=t=>{P=t,window.requestAnimationFrame(j)};var I=class{constructor(e,n){this.canvas=document.createElement("canvas"),e.appendChild(this.canvas);let r=window.devicePixelRatio,i=e.getBoundingClientRect();this.canvas.width=i.width*r,this.canvas.height=i.height*r,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(r,r),this.callback=n,n(this.ctx)}render(){this.callback(this.ctx)}},T=I;var x=(t,e)=>({a:t,b:e}),y=x;x.len=t=>o.dist(t.a,t.b);x.intersect=(t,e)=>{let{a:n,b:r}=t,{a:i,b:a}=e,l=r.x-n.x,h=r.y-n.y,d=a.x-i.x,u=a.y-i.y,f=l*u-h*d;if(f===0)return null;let b=n.x-i.x,_=n.y-i.y,c=(b*u-_*d)/f,g=(l*_-h*b)/f;if(c>=0&&c<=1&&g>=0&&g<=1){let w=n.x+c*l,k=n.y+c*h;return{x:w,y:k}}return null};x.intersectAnywhere=(t,e)=>{let{a:n,b:r}=t,{a:i,b:a}=e,l=r.x-n.x,h=r.y-n.y,d=a.x-i.x,u=a.y-i.y,f=l*u-h*d;if(f===0)return null;let b=n.x-i.x,_=n.y-i.y,c=(b*u-_*d)/f,g=(l*_-h*b)/f,w=n.x+c*l,k=n.y+c*h;return{x:w,y:k}};x.getYforX=(t,e)=>{let{a:n,b:r}=t,{x:i,y:a}=n,{x:l,y:h}=r;return(h-a)/(l-i)*(e-i)+a};x.getXforY=(t,e)=>{let{a:n,b:r}=t,{x:i,y:a}=n,{x:l,y:h}=r,d=(h-a)/(l-i);return(e-a)/d+i};x.distToPoint=(t,e)=>{let{a:n,b:r}=t,i=o.sub(r,n),a=o.sub(e,n),l=o.dot(a,i)/o.dot(i,i);if(l<=0)return o.len(a);if(l>=1)return o.dist(e,r);{let h=o.add(n,o.mulS(i,l));return o.dist(e,h)}};var z=0,v=class{constructor(e){this.id=z++,this.pos=e||o()}render(e){e.beginPath(),e.ellipse(this.pos.x,this.pos.y,3,3,0,0,Math.PI*2),e.fill()}},R=class{constructor(e,n){this.id=z++,this.a=e,this.b=n}render(e,n){e.lineWidth=1,e.strokeStyle=n?"#F81ED5":"#000000",e.beginPath(),e.moveTo(this.a.pos.x,this.a.pos.y),e.lineTo(this.b.pos.x,this.b.pos.y),e.stroke()}},C=class{constructor(e){this.a=e,this.b=o.clone(e),this.last_b=o.clone(e),this.velocity=0,this.h_snap,this.v_snap,this.ref_line,this.angle_snap,this.angle_offset,this.len_snap,this.point_snap}update(e,n,r){this.b=e;let i=o.dist(this.last_b,this.b);this.last_b=o.clone(this.b),this.velocity=.05*i+(1-.05)*this.velocity,this.h_snap=!1,this.v_snap=!1,Math.abs(this.a.x-this.b.x)<10&&(this.b.x=this.a.x,this.v_snap=!0),Math.abs(this.a.y-this.b.y)<10&&(this.b.y=this.a.y,this.h_snap=!0);let a=[];this.velocity<1.5&&(n.forEach(h=>{let d=y.getXforY(this,h.pos.y),u=y.getYforX(this,h.pos.x);a.push({x:d,y:h.pos.y,snap:h,type:"horizontal"}),a.push({x:h.pos.x,y:u,snap:h,type:"vertical"})}),this.point_snap=!1,a.forEach(h=>{o.dist(e,h)<10&&(this.b.x=h.x,this.b.y=h.y,this.point_snap=h)}));let l=n.find(h=>o.dist(h.pos,e)<10);if(l&&(this.b=l.pos,this.point_snap={snap:l,type:"coincident"}),this.len_snap=!1,this.angle_snap=!1,this.angle_offset=null,r){this.ref_line=r;let h=y.len(y(r.a.pos,r.b.pos)),d=y.len(y(this.a,this.b));Math.abs(h-d)<10&&(this.b=o.add(this.a,o.mulS(o.normalize(o.sub(this.b,this.a)),h)),this.len_snap=!0,d=h);let u=o.sub(this.a,this.b),f=o.sub(r.a.pos,r.b.pos),b=o.angle(f),_=o.angleBetweenClockwise(u,f),c=Math.round(_/90)*90;if(Math.abs(_-c)<10){let g=b+c+90;this.b=o.add(this.a,o.polar(g,d)),this.angle_snap=!0,this.angle_offset=c+90}}}render(e){if(e.lineWidth=1,e.strokeStyle=this.len_snap?"#F81ED5":"#000000",e.beginPath(),e.moveTo(this.a.x,this.a.y),e.lineTo(this.b.x,this.b.y),e.stroke(),this.h_snap||this.v_snap||this.angle_snap){let n=o.add(this.b,o.mulS(o.sub(this.a,this.b),100)),r=o.add(this.a,o.mulS(o.sub(this.b,this.a),100));e.lineWidth=.25,e.strokeStyle="#F81ED5",e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke()}if(this.point_snap){let n=o.add(this.b,o.mulS(o.sub(this.point_snap.snap.pos,this.b),100)),r=o.add(this.point_snap.snap.pos,o.mulS(o.sub(this.b,this.point_snap.snap.pos),100));e.lineWidth=.25,e.strokeStyle="#F81ED5",e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.stroke()}}},D=class{constructor(){this.mode="draw",this.wet_stroke=null,this.ref_line=null,this.points=[],this.lines=[],this.constraints=[]}find_point_near(e){return this.points.find(n=>o.dist(n.pos,e)<10)}find_stroke_near(e){return this.lines.find(n=>y.distToPoint(y(n.a.pos,n.b.pos),e)<20)}begin_stroke(e){let n=this.find_point_near(e);n&&(e=n.pos),this.wet_stroke=new C(e)}update_stroke(e){this.wet_stroke&&this.wet_stroke.update(e,this.points,this.ref_line)}end_stroke(e){let n=this.find_point_near(this.wet_stroke.a);n||(n=new v(this.wet_stroke.a)),this.points.push(n);let r=this.find_point_near(this.wet_stroke.b);r||(r=new v(this.wet_stroke.b)),this.points.push(r);let i=new R(n,r);this.lines.push(i);let a=this.wet_stroke;a.v_snap&&this.constraints.push({type:"vertical",a:n,b:r}),a.h_snap&&this.constraints.push({type:"horizontal",a:n,b:r}),a.point_snap&&a.point_snap.type!="coincident"&&this.constraints.push({type:a.point_snap.type,a:r,b:a.point_snap.snap}),a.len_snap&&this.constraints.push({type:"length",a:i,b:a.ref_line}),a.angle_snap&&this.constraints.push({type:"angle",a:i,b:a.ref_line}),a.angle_snap&&this.constraints.push({type:"angle",a:i,b:a.ref_line,angle:a.angle_offset}),console.log(this.constraints),this.wet_stroke=null}update(e){e.pencil.forEach(n=>{let r=o(n.x,n.y);this.mode=="draw"?(n.type=="began"&&this.begin_stroke(r),n.type=="moved"&&this.update_stroke(r),n.type=="ended"&&this.end_stroke(r)):this.mode=="move"&&(n.type=="began"&&(this.dragging=this.find_point_near(r)),n.type=="moved"&&this.dragging&&(this.dragging.pos=r),n.type=="ended"&&(this.dragging=!1))}),Object.entries(e.touches).forEach(([n,r])=>{r.forEach(i=>{let a=o(i.x,i.y);i.type=="began"&&(this.ref_line==null&&(this.ref_line=this.find_stroke_near(a),this.ref_line_id=n),o.dist(o(40,40),a)<20&&(this.mode=="draw"?this.mode="move":this.mode="draw")),i.type=="ended"&&(this.ref_line=null)})})}render(e){this.lines.forEach(n=>{n.render(e,n==this.ref_line)}),this.points.forEach(n=>{n.render(e)}),this.wet_stroke&&this.wet_stroke.render(e),e.beginPath(),e.ellipse(40,40,20,20,0,0,Math.PI*2),this.mode=="draw"?e.fill():e.stroke(),e.fillText(this.mode,70,40)}},q=D;var A=new q,W=new T(document.body,t=>{t.clearRect(0,0,window.innerWidth,window.innerHeight),A.render(t)});E(t=>{A.update(t),W.render()});
//# sourceMappingURL=main.js.map
