var it=Object.defineProperty;var nt=(e,t,s)=>t in e?it(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var T=(e,t,s)=>(nt(e,typeof t!="symbol"?t+"":t,s),s);var M={pencil:[],touches:{}};window.nativeEvent=(e,t)=>{Object.entries(t).forEach(([s,i])=>{i.forEach(a=>{a.type==="pencil"?M.pencil.push({type:e,x:a.x,y:a.y}):(M.touches[s]||(M.touches[s]=[]),M.touches[s].push({type:e,x:a.x,y:a.y,timestamp:a.timestamp}))})})};var O=null;function q(){O(M),M.pencil=[],M.touches={},window.requestAnimationFrame(q)}var N=e=>{O=e,window.requestAnimationFrame(q)};var H=class{constructor(t,s){this.canvas=document.createElement("canvas"),t.appendChild(this.canvas);let i=window.devicePixelRatio,a=t.getBoundingClientRect();this.canvas.width=a.width*i,this.canvas.height=a.height*i,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(i,i),this.callback=s,s(this.ctx)}render(){this.callback(this.ctx)}},U=H;var at=!0,X=class{constructor(t){this.value=t}toString(){return`var(${this.value})`}},A=class{constructor(t,s,i){this.v=t,this.amount=s,this.constraint=i}toString(){return`${this.v} += ${this.amount} from ${this.constraint}`}curb(t){t.vars.has(this.v)&&(this.amount=0)}isSignificant(t){return Math.abs(this.amount)>t}apply(t){this.v.value+=this.amount*t}draw(t){}},v=class{constructor(t,s,i){this.x=t,this.y=s,i!=null&&(this.color=i)}toString(){return`(${this.x.toFixed(1)}, ${this.y.toFixed(1)})`}contains(t,s){let i=Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2);return Math.pow(s.pointRadius,2)>=i}onClick(t){console.log(""+this);for(let s of relax.things)s.involves!=null&&s.involves(this)&&console.log("* "+s)}plus(t){return new v(this.x+t.x,this.y+t.y)}minus(t){return new v(this.x-t.x,this.y-t.y)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}distanceTo(t){return this.minus(t).magnitude()}scaledBy(t){return new v(this.x*t,this.y*t)}rotatedBy(t){let s=t*Math.PI/180,i=Math.cos(s),a=Math.sin(s);return new v(this.x*i-this.y*a,this.x*a+this.y*i)}rotatedAroundBy(t,s){return t.plus(this.minus(t).rotatedBy(s))}angleWithXAxis(){return Math.atan2(this.y,this.x)*180/Math.PI}angleWithYAxis(){return this.angleWithXAxis()-90}normalized(){return this.scaledBy(1/this.magnitude())}dot(t){return this.x*t.x+this.y*t.y}clone(){return new v(this.x,this.y)}draw(t){let s=t.ctxt.fillStyle;t.ctxt.fillStyle=this.isSelected?"yellow":this.color??"cornflowerblue",t.ctxt.beginPath(),t.ctxt.arc(t.toScreenX(this.x),t.toScreenY(this.y),t.pointRadius,0,2*Math.PI),t.ctxt.closePath(),t.ctxt.fill(),this.selectionIndices&&this.selectionIndices.length>0&&t.drawSelectionIndices(this),t.ctxt.fillStyle=s}},b=class{constructor(t,s,i){this.p=t,this.amount=s,this.constraint=i}toString(){return`${this.p} += ${this.amount} from ${this.constraint}`}curb(t){t.xs.has(this.p)&&(this.amount.x=0),t.ys.has(this.p)&&(this.amount.y=0)}isSignificant(t){return this.amount.magnitude()>t}apply(t){let s=this.amount.scaledBy(t);this.p.x+=s.x,this.p.y+=s.y}draw(t){let s=this.p,i=s.plus(this.amount),a=t.toScreenX(s.x),h=t.toScreenY(s.y),o=t.toScreenX(i.x),l=t.toScreenY(i.y);if(Math.sqrt(Math.pow(a-o,2)+Math.pow(h-l,2))<.5)return;let c=t.ctxt,u=c.strokeStyle;c.strokeStyle="rgba(255,0,0,0.5)",c.beginPath(),c.moveTo(a,h),c.lineTo(o,l);let d=t.pointRadius*.8,y=o-a,x=l-h,f=Math.atan2(x,y);c.lineTo(o-d*Math.cos(f-Math.PI/6),l-d*Math.sin(f-Math.PI/6)),c.moveTo(o,l),c.lineTo(o-d*Math.cos(f+Math.PI/6),l-d*Math.sin(f+Math.PI/6)),c.closePath(),c.stroke(),c.strokeStyle=u}},Y=class{constructor(t,s,i){this.p1=t,this.p2=s,i!=null&&(this.color=i)}toString(){return`Line(${this.p1}, ${this.p2})`}involves(t){return t===this.p1||t===this.p2}draw(t){let s=t.ctxt.lineWidth,i=t.ctxt.strokeStyle;t.ctxt.beginPath(),t.ctxt.moveTo(t.toScreenX(this.p1.x),t.toScreenY(this.p1.y)),t.ctxt.lineWidth=3,t.ctxt.strokeStyle=this.color??"rgba(0,0,0,0.15)",t.ctxt.lineTo(t.toScreenX(this.p2.x),t.toScreenY(this.p2.y)),t.ctxt.closePath(),t.ctxt.stroke(),t.ctxt.lineWidth=s,t.ctxt.strokeStyle=i}},B=class{constructor(){T(this,"rho",.25);T(this,"epsilon",.001);T(this,"things",new Set);T(this,"points",new Set);T(this,"lines",new Set)}add(t){return this.things.add(t),t instanceof v?this.points.add(t):t instanceof Y&&this.lines.add(t),this}find(t){for(let s of this.things)if(t(s))return s;return null}findAll(t){let s=[];for(let i of this.things)t(i)&&s.push(i);return s}remove(t){return this.things.delete(t),t instanceof v?this.points.delete(t):t instanceof Y&&this.lines.delete(t),this}clear(){return this.things.clear(),this.points.clear(),this.lines.clear(),this}propagateKnowns(t){for(;;){let s=!1;for(let i of this.things)if(i.propagateKnowns!=null&&i.propagateKnowns(t)){s=!0;break}if(!s)break}}runOneIteration(){for(let a of this.things)a.beforeTick!=null&&a.beforeTick(this);let t={xs:new Set,ys:new Set,vars:new Set};at&&this.propagateKnowns(t);let s=[];for(let a of this.things){if(a.calculateDeltas==null)continue;let h=a.calculateDeltas(t);for(let o of h)o.curb(t);h.some(o=>o.isSignificant(this.epsilon))&&s.push(...h)}let i;if(s.length>0){for(let a of s)a.apply(this.rho);i=!0}else i=!1;for(let a of this.things)a.afterTick!=null&&(i=a.afterTick(this)||i);return i}iterateForUpToMillis(t,s,i){let a=0,h=Date.now();for(D.nowSeconds=h/1e3;Date.now()-h<t;){s&&s(a+1);let o=this.runOneIteration(h);if(i&&i(a+1),o)a++;else break}return a}},G=B,K=class{constructor(t,s){this.v=t,this.wanted=s}involves(t){return!1}propagateKnowns(t){return t.vars.has(this.v)?!1:(this.v.value=this.wanted,t.vars.add(this.v),!0)}calculateDeltas(t){return[new A(this.v,this.wanted-this.v.value,this)]}toString(){return`FixedVar(${this.v}, ${this.wanted})`}};var W=class{constructor(t,s,i){this.p=t,this.wanted=s,this.pdisablePKsks=i}involves(t){return t===this.p}propagateKnowns(t){if(this.disablePKs)return!1;let s=!1;return t.xs.has(this.p)||(this.p.x=this.wanted.x,t.xs.add(this.p),s=!0),t.ys.has(this.p)||(this.p.y=this.wanted.y,t.ys.add(this.p),s=!0),s}calculateDeltas(t){return[new b(this.p,this.wanted.minus(this.p),this)]}toString(){return`FixedPoint(${this.p}, ${this.wanted})`}drawOver(t){let s=t.ctxt,i=s.fillStyle;s.fillStyle="black",s.beginPath(),s.arc(t.toScreenX(this.wanted.x),t.toScreenY(this.wanted.y),t.pointRadius*.4,0,2*Math.PI),s.closePath(),s.fill(),s.fillStyle=i}},C=class{constructor(t){this.ps=t}involves(t){return this.ps.includes(t)}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.ps.join(", ")})`}},L=class extends C{constructor(...t){super(t)}propagateKnowns(t){let s=this.ps.find(a=>t.ys.has(a))?.y;if(s==null)return!1;let i=!1;for(let a of this.ps)t.ys.has(a)||(a.y=s,t.ys.add(a),i=!0);return i}calculateDeltas(t){let s=this.ps.map(i=>i.y).reduce((i,a)=>i+a)/this.ps.length;return this.ps.map(i=>new b(i,new v(0,s-i.y),this))}drawUnder(t){if(!t.showConstraints)return;let s=t.ctxt,i=this.ps.map(o=>o.y).reduce((o,l)=>o+l)/this.ps.length,a=s.globalAlpha;s.globalAlpha=.125;let h=[5,10];s.setLineDash(h),s.beginPath(),s.moveTo(0,t.toScreenY(i)),s.lineTo(t.canvas.width,t.toScreenY(i)),s.closePath(),s.stroke(),s.globalAlpha=a,s.setLineDash([])}},j=class extends C{constructor(...t){super(t)}propagateKnowns(t){let s=this.ps.find(a=>t.xs.has(a))?.x;if(s==null)return!1;let i=!1;for(let a of this.ps)t.xs.has(a)||(a.x=s,t.xs.add(a),i=!0);return i}calculateDeltas(t){let s=this.ps.map(i=>i.x).reduce((i,a)=>i+a)/this.ps.length;return this.ps.map(i=>new b(i,new v(s-i.x,0),this))}drawUnder(t){if(!t.showConstraints)return;let s=t.ctxt,i=this.ps.map(h=>h.x).reduce((h,o)=>h+o)/this.ps.length,a=s.globalAlpha;s.globalAlpha=.125,s.setLineDash([5,10]),s.beginPath(),s.moveTo(t.toScreenX(i),0),s.lineTo(t.toScreenX(i),t.canvas.height),s.closePath(),s.stroke(),s.globalAlpha=a,s.setLineDash([])}},F=class{constructor(t,s){this.p1=t,this.p2=s}involves(t){return t===this.p1||t===this.p2}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.p1}, ${this.p2})`}};var $=class extends F{constructor(t,s,i){super(t,s);this.length=i}beforeTick(t){delete this.fixedLengthConstraint;for(let s of t.things)s instanceof K&&s.v===this.length&&(this.fixedLengthConstraint=s)}propagateKnowns(t){return!t.vars.has(this.length)&&t.xs.has(this.p1)&&t.ys.has(this.p1)&&t.xs.has(this.p2)&&t.ys.has(this.p2)?(this.length.value=this.p1.distanceTo(this.p2),t.vars.add(this.length),!0):!1}calculateDeltas(t){let s=this.p2.minus(this.p1),a=(s.magnitude()-this.length.value)/3,h=s.normalized();return[new A(this.length,a,this),new b(this.p1,h.scaledBy(a),this),new b(this.p2,h.scaledBy(-a),this)]}toString(){return`Length(${this.p1}, ${this.p2}, ${this.length})`}contains(t,s){if(!s.showConstraints)return!1;let i=this.p1.x-10<t.x&&t.x<this.p2.x+10||this.p2.x-10<t.x&&t.x<this.p1.x+10,a=this.p1.y-10<t.y&&t.y<this.p2.y+10||this.p2.y-10<t.y&&t.y<this.p1.y+10;return i&&a}onClick(t){this.fixedLengthConstraint!=null?t.remove(this.fixedLengthConstraint):t.addThing(new K(this.length,this.length.value))}drawOver(t){if(!t.showConstraints)return;let s=t.ctxt,i=s.lineWidth,a=s.strokeStyle,h=s.fillStyle,o=s.font,l=s.textAlign,c=s.textBaseline;s.lineWidth=1,s.strokeStyle=s.fillStyle="rgba(0,0,255,0.2)",s.beginPath();let u=Math.atan2(this.p2.y-this.p1.y,this.p2.x-this.p1.x),d=20,y=this.p1.x-d*Math.cos(u+Math.PI/2),x=this.p1.y-d*Math.sin(u+Math.PI/2),f=this.p2.x-d*Math.cos(u+Math.PI/2),m=this.p2.y-d*Math.sin(u+Math.PI/2),_=t.toScreenX((y+f)/2-d/2*Math.cos(u+Math.PI/2)),I=t.toScreenY((x+m)/2-d/2*Math.sin(u+Math.PI/2));s.moveTo(t.toScreenX(y+5*Math.cos(u+Math.PI/2)),t.toScreenY(x+5*Math.sin(u+Math.PI/2))),s.lineTo(t.toScreenX(y-5*Math.cos(u+Math.PI/2)),t.toScreenY(x-5*Math.sin(u+Math.PI/2))),s.moveTo(t.toScreenX(y),t.toScreenY(x)),s.lineTo(t.toScreenX(f),t.toScreenY(m)),s.moveTo(t.toScreenX(f+5*Math.cos(u+Math.PI/2)),t.toScreenY(m+5*Math.sin(u+Math.PI/2))),s.lineTo(t.toScreenX(f-5*Math.cos(u+Math.PI/2)),t.toScreenY(m-5*Math.sin(u+Math.PI/2))),s.closePath(),s.stroke(),s.textAlign="center",s.textBaseline="middle",s.font="14pt PT-sans",s.fillStyle=this.fixedLengthConstraint!=null?"rgba(0,0,255,0.4)":"rgba(255,0,0,0.4)",s.fillText(Math.round(this.length.value),_,I),s.lineWidth=i,s.strokeStyle=a,s.fillStyle=h,s.font=o,s.textAlign=l,s.textBaseline=c}},V=class extends F{constructor(t,s,i){super(t,s);this.length=i}propagateKnowns(t){return!1}calculateDeltas(t){let s=this.p2.minus(this.p1),i=s.magnitude();if(i>=this.length)return[];let a=(i-this.length)/2,h=s.normalized();return[new b(this.p1,h.scaledBy(a),this),new b(this.p2,h.scaledBy(-a),this)]}toString(){return`MinLength(${this.p1}, ${this.p2}, ${this.length})`}};var Z=class{constructor(t,s,i,a){this.p1=t,this.p2=s,this.p3=i,this.p4=a}involves(t){return t===this.p1||t===this.p2||t===this.p3||t===this.p4}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.p1}, ${this.p2}, ${this.p3}, ${this.p4})`}},z=class extends Z{constructor(t,s,i,a,h){super(t,s,i,a);this.theta=h}propagateKnowns(t){return!1}calculateDeltas(t){let s=this.p2.minus(this.p1),i=Math.atan2(s.y,s.x),a=this.p1.plus(this.p2).scaledBy(.5),h=this.p4.minus(this.p3),o=Math.atan2(h.y,h.x),l=this.p3.plus(this.p4).scaledBy(.5),c=(i-o+2*Math.PI)%(2*Math.PI),u=(this.theta-c)%(2*Math.PI);return[new b(this.p1,this.p1.rotatedAroundBy(a,u).minus(this.p1),this),new b(this.p2,this.p2.rotatedAroundBy(a,u).minus(this.p2),this),new b(this.p3,this.p3.rotatedAroundBy(l,-u).minus(this.p3),this),new b(this.p4,this.p4.rotatedAroundBy(l,-u).minus(this.p4),this)]}currTheta(){let t=this.p2.minus(this.p1),s=Math.atan2(t.y,t.x),i=this.p4.minus(this.p3),a=Math.atan2(i.y,i.x);return s-a}};var D=class{constructor(t){this.v=t}propagateKnowns(t){return t.vars.has(this.v)?!1:(this.v.value=D.nowSeconds,t.vars.add(this.v),!0)}calculateDeltas(t){let s=D.nowSeconds-this.v.value;return[new A(this.v,s,this)]}};var xt=Math.PI*2,k=e=>Number.EPSILON>Math.abs(e);var Q=(e,t)=>(p=1/t,Math.round(e*p)/p);var n=(e=0,t=0)=>({x:e,y:t}),r=n;n.clone=e=>n(e.x,e.y);n.fromRectXY=e=>n(e.x,e.y);n.fromRectWH=e=>n(e.w,e.h);n.fromRectRB=e=>n(e.x+e.w,e.y+e.h);n.of=e=>n(e,e);n.random=(e=1)=>n.Smul(e,n.complement(n.Smul(2,n(Math.random(),Math.random()))));n.toA=e=>[e.x,e.y];n.polar=(e,t)=>{let s=e*Math.PI/180;return n(t*Math.cos(s),t*Math.sin(s))};n.x=Object.freeze(n(1));n.y=Object.freeze(n(0,1));n.zero=Object.freeze(n());n.map=(e,t)=>n(e(t.x),e(t.y));n.map2=(e,t,s)=>n(e(t.x,s.x),e(t.y,s.y));n.reduce=(e,t)=>e(t.x,t.y);n.cross=(e,t)=>e.x*t.y-e.y*t.x;n.project=(e,t)=>n.mulS(t,n.dot(e,t)/n.len2(t));n.reject=(e,t)=>n.sub(e,n.project(e,t));n.scalarProjection=(e,t,s)=>{let i=n.sub(e,t),a=n.normalize(n.sub(s,t)),h=n.mulS(a,n.dot(i,a));return n.add(t,h)};n.add=(e,t)=>n(e.x+t.x,e.y+t.y);n.div=(e,t)=>n(e.x/t.x,e.y/t.y);n.mul=(e,t)=>n(e.x*t.x,e.y*t.y);n.sub=(e,t)=>n(e.x-t.x,e.y-t.y);n.addS=(e,t)=>n.add(e,n.of(t));n.divS=(e,t)=>n.div(e,n.of(t));n.mulS=(e,t)=>n.mul(e,n.of(t));n.subS=(e,t)=>n.sub(e,n.of(t));n.Sadd=(e,t)=>n.add(n.of(e),t);n.Sdiv=(e,t)=>n.div(n.of(e),t);n.Smul=(e,t)=>n.mul(n.of(e),t);n.Ssub=(e,t)=>n.sub(n.of(e),t);n.dist=(e,t)=>n.len(n.sub(e,t));n.dist2=(e,t)=>n.len2(n.sub(e,t));n.dot=(e,t)=>e.x*t.x+e.y*t.y;n.equal=(e,t)=>k(n.dist2(e,t));n.len2=e=>n.dot(e,e);n.len=e=>Math.sqrt(n.dot(e,e));n.ceil=e=>n.map(Math.ceil,e);n.floor=e=>n.map(Math.floor,e);n.round=e=>n.map(Math.round,e);n.roundTo=(e,t)=>n.map2(Q,e,n.of(t));n.complement=e=>n.Ssub(1,e);n.half=e=>n.divS(e,2);n.normalize=e=>n.divS(e,n.len(e));n.recip=e=>n.Sdiv(1,e);n.renormalize=(e,t,s,i,a)=>n.add(n.mul(n.div(n.sub(e,t),n.sub(s,t)),n.sub(a,i)),i);n.avg=(e,t)=>n.half(n.add(e,t));n.lerp=(e,t,s)=>n.add(e,n.Smul(s,n.sub(t,e)));n.max=(e,t)=>n.map2(Math.max,e,t);n.min=(e,t)=>n.map2(Math.min,e,t);n.abs=e=>n.map(Math.abs,e);n.invert=e=>n(-e.x,-e.y);n.invertX=e=>n(-e.x,e.y);n.invertY=e=>n(e.x,-e.y);n.rotate90CW=e=>n(e.y,-e.x);n.rotate90CCW=e=>n(-e.y,e.x);n.angle=e=>{var t=Math.atan2(e.y,e.x),s=t*180/Math.PI;return s<0&&(s+=360),s};n.angleBetween=(e,t)=>{let s=n.dot(e,t),i=n.len(e),a=n.len(t);return Math.acos(s/(i*a))*180/Math.PI};n.angleBetweenClockwise=(e,t)=>{let s=n.dot(e,t),i=n.cross(e,t),h=Math.atan2(s,i)*(180/Math.PI);return h<0&&(h=360+h),h};var P=(e,t)=>({a:e,b:t}),S=P;P.len=e=>r.dist(e.a,e.b);P.intersect=(e,t)=>{let{a:s,b:i}=e,{a,b:h}=t,o=i.x-s.x,l=i.y-s.y,c=h.x-a.x,u=h.y-a.y,d=o*u-l*c;if(d===0)return null;let y=s.x-a.x,x=s.y-a.y,f=(y*u-x*c)/d,m=(o*x-l*y)/d;if(f>=0&&f<=1&&m>=0&&m<=1){let _=s.x+f*o,I=s.y+f*l;return{x:_,y:I}}return null};P.intersectAnywhere=(e,t)=>{let{a:s,b:i}=e,{a,b:h}=t,o=i.x-s.x,l=i.y-s.y,c=h.x-a.x,u=h.y-a.y,d=o*u-l*c;if(d===0)return null;let y=s.x-a.x,x=s.y-a.y,f=(y*u-x*c)/d,m=(o*x-l*y)/d,_=s.x+f*o,I=s.y+f*l;return{x:_,y:I}};P.getYforX=(e,t)=>{let{a:s,b:i}=e,{x:a,y:h}=s,{x:o,y:l}=i;return(l-h)/(o-a)*(t-a)+h};P.getXforY=(e,t)=>{let{a:s,b:i}=e,{x:a,y:h}=s,{x:o,y:l}=i,c=(l-h)/(o-a);return(t-h)/c+a};P.distToPoint=(e,t)=>{let{a:s,b:i}=e,a=r.sub(i,s),h=r.sub(t,s),o=r.dot(h,a)/r.dot(a,a);if(o<=0)return r.len(h);if(o>=1)return r.dist(t,i);{let l=r.add(s,r.mulS(a,o));return r.dist(t,l)}};var J=0,E=class{constructor(t){this.id=J++,this.pos=t||r()}render(t){t.beginPath(),t.ellipse(this.pos.x,this.pos.y,3,3,0,0,Math.PI*2),t.fill()}};function ht(){let e=document.createElement("input");return e.setAttribute("type","text"),Math.random()>.5&&(e.value="2x"),e.style.setProperty("position","absolute"),e.contentEditable=!0,e.onchange=()=>{e.value=e.value.toLowerCase(),e.blur()},e.setPos=(t,s)=>{let i=e.getBoundingClientRect();e.style.setProperty("left",`${t-i.width/2}px`),e.style.setProperty("top",`${s-i.height/2}px`)},document.body.appendChild(e),e}var R=class{constructor(t,s){this.id=J++,this.a=t,this.b=s,this.input=ht(),this.updateInputPos()}render(t,s){t.lineWidth=1,t.strokeStyle=s?"#F81ED5":"#000000",t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.stroke(),this.updateInputPos()}updateInputPos(){this.input.setPos((this.a.pos.x+this.b.pos.x)/2,(this.a.pos.y+this.b.pos.y)/2)}},tt=class{constructor(t){this.a=t,this.b=r.clone(t),this.last_b=r.clone(t),this.velocity=0,this.h_snap,this.v_snap,this.ref_line,this.angle_snap,this.angle_offset,this.len_snap,this.point_snap}update(t,s,i){this.b=t;let a=r.dist(this.last_b,this.b);this.last_b=r.clone(this.b),this.velocity=.05*a+(1-.05)*this.velocity,this.h_snap=!1,this.v_snap=!1,Math.abs(this.a.x-this.b.x)<10&&(this.b.x=this.a.x,this.v_snap=!0),Math.abs(this.a.y-this.b.y)<10&&(this.b.y=this.a.y,this.h_snap=!0);let h=[];this.velocity<1.5&&(s.forEach(l=>{let c=S.getXforY(this,l.pos.y),u=S.getYforX(this,l.pos.x);h.push({type:"horizontal",x:c,y:l.pos.y,snap:l},{type:"vertical",x:l.pos.x,y:u,snap:l})}),this.point_snap=!1,h.forEach(l=>{r.dist(t,l)<10&&(this.b.x=l.x,this.b.y=l.y,this.point_snap=l)}));let o=s.find(l=>r.dist(l.pos,t)<10);if(o&&(this.b=o.pos,this.point_snap={type:"coincident",snap:o}),this.len_snap=!1,this.angle_snap=!1,this.angle_offset=null,i){this.ref_line=i;let l=S.len(S(i.a.pos,i.b.pos)),c=S.len(S(this.a,this.b));Math.abs(l-c)<10&&(this.b=r.add(this.a,r.mulS(r.normalize(r.sub(this.b,this.a)),l)),this.len_snap=!0,c=l);let u=r.sub(this.a,this.b),d=r.sub(i.a.pos,i.b.pos),y=r.angle(u),x=r.angle(d),f=(y-x+360)%360,m=(Math.round(f/90)*90+360)%360;if(Math.abs(f-m)<10){let _=x+m;this.b=r.add(this.a,r.polar(180+_,c)),this.angle_snap=!0,this.angle_offset=m}}}render(t){if(t.lineWidth=1,t.strokeStyle=this.len_snap?"#F81ED5":"#000000",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.stroke(),this.h_snap||this.v_snap||this.angle_snap){let s=r.add(this.b,r.mulS(r.sub(this.a,this.b),100)),i=r.add(this.a,r.mulS(r.sub(this.b,this.a),100));t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.stroke()}if(this.point_snap){let s=r.add(this.b,r.mulS(r.sub(this.point_snap.snap.pos,this.b),100)),i=r.add(this.point_snap.snap.pos,r.mulS(r.sub(this.b,this.point_snap.snap.pos),100));t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(s.x,s.y),t.lineTo(i.x,i.y),t.stroke()}if(this.ref_line){let s=S.len(S(this.ref_line.a.pos,this.ref_line.b.pos)),i=r.normalize(r.sub(this.b,this.a)),a=r.add(this.a,r.mulS(i,1e4)),h=r.mulS(i,s);t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(a.x,a.y),t.stroke();for(let o=0;o<10;o+=.25){let l=o%1==0?6:3,c=r.mulS(r.rotate90CCW(i),l),u=r.add(this.a,r.mulS(h,o)),d=r.add(u,c),y=r.sub(u,c);t.beginPath(),t.moveTo(d.x,d.y),t.lineTo(y.x,y.y),t.stroke()}}}},st=class{constructor(){this.mode="draw",this.wet_stroke=null,this.ref_line=null,this.points=[],this.lines=[],this.constraints=[],this.___addLine({x:100,y:100},{x:300,y:200}),this.___addLine({x:150,y:150},{x:150,y:400})}find_point_near(t){return this.points.find(s=>r.dist(s.pos,t)<10)}find_stroke_near(t){return this.lines.find(s=>S.distToPoint(S(s.a.pos,s.b.pos),t)<20)}begin_stroke(t){let s=this.find_point_near(t);s&&(t=s.pos),this.wet_stroke=new tt(t)}update_stroke(t){this.wet_stroke&&this.wet_stroke.update(t,this.points,this.ref_line)}___addLine(t,s){let i=new E(t),a=new E(s);this.points.push(i,a);let h=new R(i,a);this.lines.push(h)}end_stroke(t){let s=this.find_point_near(this.wet_stroke.a);s||(s=new E(this.wet_stroke.a)),this.points.push(s);let i=this.find_point_near(this.wet_stroke.b);i||(i=new E(this.wet_stroke.b)),this.points.push(i);let a=new R(s,i);this.lines.push(a),this.constraints.push({type:"minLength",a,b:50});let h=this.wet_stroke;h.v_snap&&this.constraints.push({type:"vertical",a:s,b:i}),h.h_snap&&this.constraints.push({type:"horizontal",a:s,b:i}),h.point_snap&&h.point_snap.type!="coincident"&&this.constraints.push({type:h.point_snap.type,a:i,b:h.point_snap.snap}),h.len_snap&&this.constraints.push({type:"length",a,b:h.ref_line}),h.angle_snap&&!h.v_snap&&!h.h_snap&&this.constraints.push({type:"angle",a,b:h.ref_line,angle:h.angle_offset}),this.wet_stroke=null}update(t){t.pencil.forEach(s=>{let i=r(s.x,s.y);if(this.mode==="draw")s.type==="began"?this.begin_stroke(i):s.type==="moved"?this.update_stroke(i):s.type==="ended"&&this.end_stroke(i);else if(this.mode.startsWith("move")){if(s.type==="began"&&(this.dragging=this.find_point_near(i),this.dragging)){let a=-Infinity;for(let h of this.points){let o=r.dist(this.dragging.pos,h.pos);o>a&&(a=o,this.fixedPoint=h)}}s.type==="moved"&&this.dragging&&(this.dragging.pos=i),s.type==="ended"&&(this.dragging=!1,this.fixedPoint=null)}}),Object.entries(t.touches).forEach(([s,i])=>{i.forEach(a=>{let h=r(a.x,a.y);if(a.type==="began"){let o=this.find_stroke_near(h);this.ref_line===o?this.ref_line=null:(this.ref_line=o,this.finger_down_time=a.timestamp),this.ref_line_id=s,r.dist(r(40,40),h)<20&&this.toggleModes()}a.type=="ended"&&a.timestamp-this.finger_down_time>1&&(this.ref_line=null)})})}toggleModes(){if(this.mode==="draw")this.mode="move";else if(this.mode==="move")this.mode="move-v2";else if(this.mode==="move-v2"){this.mode="scribble";for(let t of document.body.getElementsByTagName("input"))t.placeholder="..."}else{for(let t of document.body.getElementsByTagName("input"))t.placeholder="",t.blur();this.mode="draw"}return document.body.className=this.mode,this.mode}render(t){this.lines.forEach(s=>{s.render(t,s===this.ref_line)}),this.points.forEach(s=>{s.render(t)}),this.wet_stroke&&this.wet_stroke.render(t),t.beginPath(),t.ellipse(40,40,20,20,0,0,Math.PI*2),this.mode==="draw"?t.fill():t.stroke(),t.fillText(this.mode,70,40)}},et=st;var w=new et;window.draw=w;var rt=new U(document.body,e=>{e.clearRect(0,0,window.innerWidth,window.innerHeight),w.render(e)});N(e=>{w.update(e),ot(),rt.render()});function ot(){let e=new G;lt(e);for(let t of w.constraints)pt(e,t);e.iterateForUpToMillis(15)}function lt(e){if(!w.mode.startsWith("move")||!w.dragging)return;function t(s){let i=g(s.pos);s.pos=i,e.add(new W(i,new v(i.x,i.y)))}t(w.dragging),w.mode==="move-v2"&&t(w.fixedPoint)}function pt(e,t){if(t.type==="vertical"&&(t.a.pos=g(t.a.pos),t.b.pos=g(t.b.pos),e.add(new j(t.a.pos,t.b.pos))),t.type==="horizontal"&&(t.a.pos=g(t.a.pos),t.b.pos=g(t.b.pos),e.add(new L(t.a.pos,t.b.pos))),t.type==="length"){t.a.a.pos=g(t.a.a.pos),t.a.b.pos=g(t.a.b.pos),t.b.a.pos=g(t.b.a.pos),t.b.b.pos=g(t.b.b.pos);let s=new X(t.a.a.pos.distanceTo(t.a.b.pos));e.add(new $(t.a.a.pos,t.a.b.pos,s)),e.add(new $(t.b.a.pos,t.b.b.pos,s))}t.type==="minLength"&&(t.a.a.pos=g(t.a.a.pos),t.a.b.pos=g(t.a.b.pos),e.add(new V(t.a.a.pos,t.a.b.pos,t.b))),t.type==="angle"&&(t.a.a.pos=g(t.a.a.pos),t.a.b.pos=g(t.a.b.pos),t.b.a.pos=g(t.b.a.pos),t.b.b.pos=g(t.b.b.pos),e.add(new z(t.a.a.pos,t.a.b.pos,t.b.a.pos,t.b.b.pos,Math.PI*t.angle/180)))}function g(e){return e instanceof v?e:new v(e.x,e.y)}
//# sourceMappingURL=main.js.map
