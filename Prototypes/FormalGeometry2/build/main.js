var rs=Object.defineProperty;var ns=(s,t,e)=>t in s?rs(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var U=(s,t,e)=>(ns(s,typeof t!="symbol"?t+"":t,e),e);var tt={pencil:[],touches:{}};window.nativeEvent=(s,t)=>{Object.entries(t).forEach(([e,r])=>{r.forEach(n=>{n.type==="pencil"?tt.pencil.push({type:s,x:n.x,y:n.y}):(tt.touches[e]||(tt.touches[e]=[]),tt.touches[e].push({type:s,x:n.x,y:n.y,timestamp:n.timestamp}))})})};var se=null;function re(){se(tt),tt.pencil=[],tt.touches={},window.requestAnimationFrame(re)}var ne=s=>{se=s,window.requestAnimationFrame(re)};var ie=class{constructor(t,e){this.canvas=document.createElement("canvas"),t.appendChild(this.canvas);let r=window.devicePixelRatio,n=t.getBoundingClientRect();this.canvas.width=n.width*r,this.canvas.height=n.height*r,this.ctx=this.canvas.getContext("2d"),this.ctx.scale(r,r),this.callback=e,e(this.ctx)}render(){this.callback(this.ctx)}},oe=ie;var is=!0,ot=class{constructor(t){this.value=t}toString(){return`var(${this.value})`}},H=class{constructor(t,e,r){this.v=t,this.amount=e,this.constraint=r}toString(){return`${this.v} += ${this.amount} from ${this.constraint}`}curb(t){t.vars.has(this.v)&&(this.amount=0)}isSignificant(t){return Math.abs(this.amount)>t}apply(t){this.v.value+=this.amount*t}draw(t){}},w=class{constructor(t,e,r){this.x=t,this.y=e,r!=null&&(this.color=r)}toString(){return`(${this.x.toFixed(1)}, ${this.y.toFixed(1)})`}contains(t,e){let r=Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2);return Math.pow(e.pointRadius,2)>=r}onClick(t){console.log(""+this);for(let e of relax.things)e.involves!=null&&e.involves(this)&&console.log("* "+e)}plus(t){return new w(this.x+t.x,this.y+t.y)}minus(t){return new w(this.x-t.x,this.y-t.y)}magnitude(){return Math.sqrt(this.x*this.x+this.y*this.y)}distanceTo(t){return this.minus(t).magnitude()}scaledBy(t){return new w(this.x*t,this.y*t)}rotatedBy(t){let e=t*Math.PI/180,r=Math.cos(e),n=Math.sin(e);return new w(this.x*r-this.y*n,this.x*n+this.y*r)}rotatedAroundBy(t,e){return t.plus(this.minus(t).rotatedBy(e))}angleWithXAxis(){return Math.atan2(this.y,this.x)*180/Math.PI}angleWithYAxis(){return this.angleWithXAxis()-90}normalized(){return this.scaledBy(1/this.magnitude())}dot(t){return this.x*t.x+this.y*t.y}clone(){return new w(this.x,this.y)}draw(t){let e=t.ctxt.fillStyle;t.ctxt.fillStyle=this.isSelected?"yellow":this.color??"cornflowerblue",t.ctxt.beginPath(),t.ctxt.arc(t.toScreenX(this.x),t.toScreenY(this.y),t.pointRadius,0,2*Math.PI),t.ctxt.closePath(),t.ctxt.fill(),this.selectionIndices&&this.selectionIndices.length>0&&t.drawSelectionIndices(this),t.ctxt.fillStyle=e}},$=class{constructor(t,e,r){this.p=t,this.amount=e,this.constraint=r}toString(){return`${this.p} += ${this.amount} from ${this.constraint}`}curb(t){t.xs.has(this.p)&&(this.amount.x=0),t.ys.has(this.p)&&(this.amount.y=0)}isSignificant(t){return this.amount.magnitude()>t}apply(t){let e=this.amount.scaledBy(t);this.p.x+=e.x,this.p.y+=e.y}draw(t){let e=this.p,r=e.plus(this.amount),n=t.toScreenX(e.x),i=t.toScreenY(e.y),o=t.toScreenX(r.x),a=t.toScreenY(r.y);if(Math.sqrt(Math.pow(n-o,2)+Math.pow(i-a,2))<.5)return;let u=t.ctxt,h=u.strokeStyle;u.strokeStyle="rgba(255,0,0,0.5)",u.beginPath(),u.moveTo(n,i),u.lineTo(o,a);let c=t.pointRadius*.8,d=o-n,f=a-i,m=Math.atan2(f,d);u.lineTo(o-c*Math.cos(m-Math.PI/6),a-c*Math.sin(m-Math.PI/6)),u.moveTo(o,a),u.lineTo(o-c*Math.cos(m+Math.PI/6),a-c*Math.sin(m+Math.PI/6)),u.closePath(),u.stroke(),u.strokeStyle=h}},wt=class{constructor(t,e,r){this.p1=t,this.p2=e,r!=null&&(this.color=r)}toString(){return`Line(${this.p1}, ${this.p2})`}involves(t){return t===this.p1||t===this.p2}draw(t){let e=t.ctxt.lineWidth,r=t.ctxt.strokeStyle;t.ctxt.beginPath(),t.ctxt.moveTo(t.toScreenX(this.p1.x),t.toScreenY(this.p1.y)),t.ctxt.lineWidth=3,t.ctxt.strokeStyle=this.color??"rgba(0,0,0,0.15)",t.ctxt.lineTo(t.toScreenX(this.p2.x),t.toScreenY(this.p2.y)),t.ctxt.closePath(),t.ctxt.stroke(),t.ctxt.lineWidth=e,t.ctxt.strokeStyle=r}},_t=class{constructor(){U(this,"rho",.25);U(this,"epsilon",.001);U(this,"things",new Set);U(this,"points",new Set);U(this,"lines",new Set)}add(t){return this.things.add(t),t instanceof w?this.points.add(t):t instanceof wt&&this.lines.add(t),this}find(t){for(let e of this.things)if(t(e))return e;return null}findAll(t){let e=[];for(let r of this.things)t(r)&&e.push(r);return e}remove(t){return this.things.delete(t),t instanceof w?this.points.delete(t):t instanceof wt&&this.lines.delete(t),this}clear(){return this.things.clear(),this.points.clear(),this.lines.clear(),this}propagateKnowns(t){for(;;){let e=!1;for(let r of this.things)if(r.propagateKnowns!=null&&r.propagateKnowns(t)){e=!0;break}if(!e)break}}runOneIteration(){for(let n of this.things)n.beforeTick!=null&&n.beforeTick(this);let t={xs:new Set,ys:new Set,vars:new Set};is&&this.propagateKnowns(t);let e=[];for(let n of this.things){if(n.calculateDeltas==null)continue;let i=n.calculateDeltas(t);for(let o of i)o.curb(t);i.some(o=>o.isSignificant(this.epsilon))&&e.push(...i)}let r;if(e.length>0){for(let n of e)n.apply(this.rho);r=!0}else r=!1;for(let n of this.things)n.afterTick!=null&&(r=n.afterTick(this)||r);return r}iterateForUpToMillis(t,e,r){let n=0,i=Date.now();for(ct.nowSeconds=i/1e3;Date.now()-i<t;){e&&e(n+1);let o=this.runOneIteration(i);if(r&&r(n+1),o)n++;else break}return n}},ae=_t,ht=class{constructor(t,e){this.v=t,this.wanted=e}involves(t){return!1}propagateKnowns(t){return t.vars.has(this.v)?!1:(this.v.value=this.wanted,t.vars.add(this.v),!0)}calculateDeltas(t){return[new H(this.v,this.wanted-this.v.value,this)]}toString(){return`FixedVar(${this.v}, ${this.wanted})`}},At=class{constructor(...t){this.vs=t}involves(t){return this.vs.includes(t)}propagateKnowns(t){let e=this.vs.find(n=>t.vars.has(n));if(e==null)return!1;let r=!1;for(let n of this.vs)t.vars.has(n)||(n.value=e.value,t.vars.add(n),r=!0);return r}calculateDeltas(t){let e=os(...this.vs.map(r=>r.value));return this.vs.map(r=>new H(r,e-r.value,this))}toString(){return`VarEquals(${this.vs})`}},Pt=class{constructor(t,e){this.p=t,this.wanted=e}involves(t){return t===this.p}propagateKnowns(t){let e=!1;return t.xs.has(this.p)||(this.p.x=this.wanted.x,t.xs.add(this.p),e=!0),t.ys.has(this.p)||(this.p.y=this.wanted.y,t.ys.add(this.p),e=!0),e}calculateDeltas(t){return[new $(this.p,this.wanted.minus(this.p),this)]}toString(){return`FixedPoint(${this.p}, ${this.wanted})`}drawOver(t){let e=t.ctxt,r=e.fillStyle;e.fillStyle="black",e.beginPath(),e.arc(t.toScreenX(this.wanted.x),t.toScreenY(this.wanted.y),t.pointRadius*.4,0,2*Math.PI),e.closePath(),e.fill(),e.fillStyle=r}},Lt=class{constructor(t){this.ps=t}involves(t){return this.ps.includes(t)}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.ps.join(", ")})`}},Ot=class extends Lt{constructor(...t){super(t)}propagateKnowns(t){let e=this.ps.find(n=>t.ys.has(n))?.y;if(e==null)return!1;let r=!1;for(let n of this.ps)t.ys.has(n)||(n.y=e,t.ys.add(n),r=!0);return r}calculateDeltas(t){let e=this.ps.map(r=>r.y).reduce((r,n)=>r+n)/this.ps.length;return this.ps.map(r=>new $(r,new w(0,e-r.y),this))}drawUnder(t){if(!t.showConstraints)return;let e=t.ctxt,r=this.ps.map(o=>o.y).reduce((o,a)=>o+a)/this.ps.length,n=e.globalAlpha;e.globalAlpha=.125;let i=[5,10];e.setLineDash(i),e.beginPath(),e.moveTo(0,t.toScreenY(r)),e.lineTo(t.canvas.width,t.toScreenY(r)),e.closePath(),e.stroke(),e.globalAlpha=n,e.setLineDash([])}},Nt=class extends Lt{constructor(...t){super(t)}propagateKnowns(t){let e=this.ps.find(n=>t.xs.has(n))?.x;if(e==null)return!1;let r=!1;for(let n of this.ps)t.xs.has(n)||(n.x=e,t.xs.add(n),r=!0);return r}calculateDeltas(t){let e=this.ps.map(r=>r.x).reduce((r,n)=>r+n)/this.ps.length;return this.ps.map(r=>new $(r,new w(e-r.x,0),this))}drawUnder(t){if(!t.showConstraints)return;let e=t.ctxt,r=this.ps.map(i=>i.x).reduce((i,o)=>i+o)/this.ps.length,n=e.globalAlpha;e.globalAlpha=.125,e.setLineDash([5,10]),e.beginPath(),e.moveTo(t.toScreenX(r),0),e.lineTo(t.toScreenX(r),t.canvas.height),e.closePath(),e.stroke(),e.globalAlpha=n,e.setLineDash([])}},Rt=class{constructor(t,e){this.p1=t,this.p2=e}involves(t){return t===this.p1||t===this.p2}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.p1}, ${this.p2})`}};var et=class extends Rt{constructor(t,e,r){super(t,e);this.length=r}beforeTick(t){delete this.fixedLengthConstraint;for(let e of t.things)e instanceof ht&&e.v===this.length&&(this.fixedLengthConstraint=e)}propagateKnowns(t){return!t.vars.has(this.length)&&t.xs.has(this.p1)&&t.ys.has(this.p1)&&t.xs.has(this.p2)&&t.ys.has(this.p2)?(this.length.value=this.p1.distanceTo(this.p2),t.vars.add(this.length),!0):!1}calculateDeltas(t){let e=this.p2.minus(this.p1),n=(e.magnitude()-this.length.value)/3,i=e.normalized();return[new H(this.length,n,this),new $(this.p1,i.scaledBy(n),this),new $(this.p2,i.scaledBy(-n),this)]}toString(){return`Length(${this.p1}, ${this.p2}, ${this.length})`}contains(t,e){if(!e.showConstraints)return!1;let r=this.p1.x-10<t.x&&t.x<this.p2.x+10||this.p2.x-10<t.x&&t.x<this.p1.x+10,n=this.p1.y-10<t.y&&t.y<this.p2.y+10||this.p2.y-10<t.y&&t.y<this.p1.y+10;return r&&n}onClick(t){this.fixedLengthConstraint!=null?t.remove(this.fixedLengthConstraint):t.addThing(new ht(this.length,this.length.value))}drawOver(t){if(!t.showConstraints)return;let e=t.ctxt,r=e.lineWidth,n=e.strokeStyle,i=e.fillStyle,o=e.font,a=e.textAlign,u=e.textBaseline;e.lineWidth=1,e.strokeStyle=e.fillStyle="rgba(0,0,255,0.2)",e.beginPath();let h=Math.atan2(this.p2.y-this.p1.y,this.p2.x-this.p1.x),c=20,d=this.p1.x-c*Math.cos(h+Math.PI/2),f=this.p1.y-c*Math.sin(h+Math.PI/2),m=this.p2.x-c*Math.cos(h+Math.PI/2),y=this.p2.y-c*Math.sin(h+Math.PI/2),x=t.toScreenX((d+m)/2-c/2*Math.cos(h+Math.PI/2)),S=t.toScreenY((f+y)/2-c/2*Math.sin(h+Math.PI/2));e.moveTo(t.toScreenX(d+5*Math.cos(h+Math.PI/2)),t.toScreenY(f+5*Math.sin(h+Math.PI/2))),e.lineTo(t.toScreenX(d-5*Math.cos(h+Math.PI/2)),t.toScreenY(f-5*Math.sin(h+Math.PI/2))),e.moveTo(t.toScreenX(d),t.toScreenY(f)),e.lineTo(t.toScreenX(m),t.toScreenY(y)),e.moveTo(t.toScreenX(m+5*Math.cos(h+Math.PI/2)),t.toScreenY(y+5*Math.sin(h+Math.PI/2))),e.lineTo(t.toScreenX(m-5*Math.cos(h+Math.PI/2)),t.toScreenY(y-5*Math.sin(h+Math.PI/2))),e.closePath(),e.stroke(),e.textAlign="center",e.textBaseline="middle",e.font="14pt PT-sans",e.fillStyle=this.fixedLengthConstraint!=null?"rgba(0,0,255,0.4)":"rgba(255,0,0,0.4)",e.fillText(Math.round(this.length.value),x,S),e.lineWidth=r,e.strokeStyle=n,e.fillStyle=i,e.font=o,e.textAlign=a,e.textBaseline=u}},Et=class extends Rt{constructor(t,e,r){super(t,e);this.length=r}propagateKnowns(t){return!1}calculateDeltas(t){let e=this.p2.minus(this.p1),r=e.magnitude();if(r>=this.length)return[];let n=(r-this.length)/2,i=e.normalized();return[new $(this.p1,i.scaledBy(n),this),new $(this.p2,i.scaledBy(-n),this)]}toString(){return`MinLength(${this.p1}, ${this.p2}, ${this.length})`}};var le=class{constructor(t,e,r,n){this.p1=t,this.p2=e,this.p3=r,this.p4=n}involves(t){return t===this.p1||t===this.p2||t===this.p3||t===this.p4}propagateKnowns(t){throw new Error("subclass responsibility")}calculateDeltas(t){throw new Error("subclass responsibility")}toString(){return`${this.constructor.name}(${this.p1}, ${this.p2}, ${this.p3}, ${this.p4})`}},Ct=class extends le{constructor(t,e,r,n,i){super(t,e,r,n);this.theta=i}propagateKnowns(t){return!1}calculateDeltas(t){let e=this.p2.minus(this.p1),r=Math.atan2(e.y,e.x),n=this.p1.plus(this.p2).scaledBy(.5),i=this.p4.minus(this.p3),o=Math.atan2(i.y,i.x),a=this.p3.plus(this.p4).scaledBy(.5),u=(r-o+2*Math.PI)%(2*Math.PI),h=(this.theta-u)%(2*Math.PI);return[new $(this.p1,this.p1.rotatedAroundBy(n,h).minus(this.p1),this),new $(this.p2,this.p2.rotatedAroundBy(n,h).minus(this.p2),this),new $(this.p3,this.p3.rotatedAroundBy(a,-h).minus(this.p3),this),new $(this.p4,this.p4.rotatedAroundBy(a,-h).minus(this.p4),this)]}currTheta(){let t=this.p2.minus(this.p1),e=Math.atan2(t.y,t.x),r=this.p4.minus(this.p3),n=Math.atan2(r.y,r.x);return e-n}};var ct=class{constructor(t){this.v=t}propagateKnowns(t){return t.vars.has(this.v)?!1:(this.v.value=ct.nowSeconds,t.vars.add(this.v),!0)}calculateDeltas(t){let e=ct.nowSeconds-this.v.value;return[new H(this.v,e,this)]}};var Ft=class extends ot{constructor(t,e){super(0);U(this,"epsilon",.1);U(this,"tinyDelta",1e-6);U(this,"maxIterations",100);this.inputs=t,this.computeValueFn=e}toString(){return`SpreadsheetCell(${this.value}, ${this.computeValueFn.toString().substring(6)})`}involves(t){return this.inputs.xs?.includes(t)||this.inputs.ys?.includes(t)||this.inputs.vars?.includes(t)}propagateKnowns(t){return!t.vars.has(this)&&this.allKnown(this.inputs.xs,t.xs)&&this.allKnown(this.inputs.ys,t.ys)&&this.allKnown(this.inputs.vars,t.vars)?(this.value=this.computeValue(),t.vars.add(this),!0):!1}allKnown(t,e){return t==null||t.every(r=>e.has(r))}currentValueHasNoSolution(t){let e={vars:{has:n=>n===this||t.vars?.has(n)},xs:{has:n=>t.xs?.has(n)},ys:{has:n=>t.ys?.has(n)}};return this.relax(e)>this.epsilon}relax(t){let e=0,r;for(;r=this.calculateError(),!(e++>=this.maxIterations||r<=this.epsilon);){let n=0,i=(a,u,h)=>{if(a==null)return null;let c=[];for(let d of a){if(h&&h.has(d)){c.push(0);continue}let f=this.derivativeOfErrorWrt(d,u),y=-(r-f*d[u])/f,x=isFinite(y)?y-d[u]:0;x!==0&&n++,c.push(x)}return c},o={xs:i(this.inputs.xs,"x",t.xs),ys:i(this.inputs.ys,"y",t.ys),vars:i(this.inputs.vars,"value",t.vars),self:i([this],"value",t.vars)[0]};if(n===0){r=this.calculateError();break}o.xs?.forEach((a,u)=>this.inputs.xs[u].x+=a/n),o.ys?.forEach((a,u)=>this.inputs.ys[u].y+=a/n),o.vars?.forEach((a,u)=>this.inputs.vars[u].value+=a/n),this.value+=o.self/n}return r}calculateDeltas(t){let e=this.snapshotInputs(),r=this.value,n=()=>{this.restoreInputs(e),this.value=r},i=this.currentValueHasNoSolution(t);if(n(),i)return[];if(this.relax(t)>this.epsilon){if(t.vars?.has(this))return n(),[];{let h=this.computeValue();return n(),[new H(this,h-this.value,this)]}}let a={self:this.value,xs:this.inputs.xs?.map(h=>h.x),ys:this.inputs.ys?.map(h=>h.y),vars:this.inputs.vars?.map(h=>h.value)};n();let u=[new H(this,a.self-this.value,this)];return a.xs&&u.push(...a.xs.map((h,c)=>new $(this.inputs.xs[c],new w(h-this.inputs.xs[c].x,0),this))),a.ys&&u.push(...a.ys.map((h,c)=>new $(this.inputs.ys[c],new w(0,h-this.inputs.ys[c].y),this))),a.vars&&u.push(...a.vars.map((h,c)=>new H(this.inputs.vars[c],h-this.inputs.vars[c].value,this))),u}derivativeOfErrorWrt(t,e){let r=t[e],n=(o,a)=>{t[e]=o;let u=this.calculateError();t[e]=a;let h=this.calculateError();return t[e]=r,(h-u)/(a-o)},i=n(r-this.tinyDelta,r+this.tinyDelta);return Math.abs(i)<this.tinyDelta&&(i=n(r,r+this.tinyDelta)),Math.abs(i)<this.tinyDelta&&(i=n(r-this.tinyDelta,r)),i}calculateError(){return Math.abs(this.computeValue()-this.value)}computeValue(t){let e=this.computeValueFn();return t&&(this.value=e),e}snapshotInputs(){return{xs:this.inputs.xs?.map(t=>t.x),ys:this.inputs.ys?.map(t=>t.y),vars:this.inputs.vars?.map(t=>t.value)}}restoreInputs(t){this.inputs.xs?.forEach((e,r)=>{e.x=t.xs[r]}),this.inputs.ys?.forEach((e,r)=>{e.y=t.ys[r]}),this.inputs.vars?.forEach((e,r)=>e.value=t.vars[r])}};function os(...s){return s.reduce((t,e)=>t+e)/s.length}var hr=Math.PI*2,ue=s=>Number.EPSILON>Math.abs(s);var ce=(s,t)=>(p=1/t,Math.round(s*p)/p);var l=(s=0,t=0)=>new w(s,t),g=l;l.clone=s=>l(s.x,s.y);l.fromRectXY=s=>l(s.x,s.y);l.fromRectWH=s=>l(s.w,s.h);l.fromRectRB=s=>l(s.x+s.w,s.y+s.h);l.of=s=>l(s,s);l.random=(s=1)=>l.Smul(s,l.complement(l.Smul(2,l(Math.random(),Math.random()))));l.toA=s=>[s.x,s.y];l.polar=(s,t)=>{let e=s*Math.PI/180;return l(t*Math.cos(e),t*Math.sin(e))};l.x=Object.freeze(l(1));l.y=Object.freeze(l(0,1));l.zero=Object.freeze(l());l.map=(s,t)=>l(s(t.x),s(t.y));l.map2=(s,t,e)=>l(s(t.x,e.x),s(t.y,e.y));l.reduce=(s,t)=>s(t.x,t.y);l.cross=(s,t)=>s.x*t.y-s.y*t.x;l.project=(s,t)=>l.mulS(t,l.dot(s,t)/l.len2(t));l.reject=(s,t)=>l.sub(s,l.project(s,t));l.scalarProjection=(s,t,e)=>{let r=l.sub(s,t),n=l.normalize(l.sub(e,t)),i=l.mulS(n,l.dot(r,n));return l.add(t,i)};l.add=(s,t)=>l(s.x+t.x,s.y+t.y);l.div=(s,t)=>l(s.x/t.x,s.y/t.y);l.mul=(s,t)=>l(s.x*t.x,s.y*t.y);l.sub=(s,t)=>l(s.x-t.x,s.y-t.y);l.addS=(s,t)=>l.add(s,l.of(t));l.divS=(s,t)=>l.div(s,l.of(t));l.mulS=(s,t)=>l.mul(s,l.of(t));l.subS=(s,t)=>l.sub(s,l.of(t));l.Sadd=(s,t)=>l.add(l.of(s),t);l.Sdiv=(s,t)=>l.div(l.of(s),t);l.Smul=(s,t)=>l.mul(l.of(s),t);l.Ssub=(s,t)=>l.sub(l.of(s),t);l.dist=(s,t)=>l.len(l.sub(s,t));l.dist2=(s,t)=>l.len2(l.sub(s,t));l.dot=(s,t)=>s.x*t.x+s.y*t.y;l.equal=(s,t)=>ue(l.dist2(s,t));l.len2=s=>l.dot(s,s);l.len=s=>Math.sqrt(l.dot(s,s));l.ceil=s=>l.map(Math.ceil,s);l.floor=s=>l.map(Math.floor,s);l.round=s=>l.map(Math.round,s);l.roundTo=(s,t)=>l.map2(ce,s,l.of(t));l.complement=s=>l.Ssub(1,s);l.half=s=>l.divS(s,2);l.normalize=s=>l.divS(s,l.len(s));l.recip=s=>l.Sdiv(1,s);l.renormalize=(s,t,e,r,n)=>l.add(l.mul(l.div(l.sub(s,t),l.sub(e,t)),l.sub(n,r)),r);l.avg=(s,t)=>l.half(l.add(s,t));l.lerp=(s,t,e)=>l.add(s,l.Smul(e,l.sub(t,s)));l.max=(s,t)=>l.map2(Math.max,s,t);l.min=(s,t)=>l.map2(Math.min,s,t);l.abs=s=>l.map(Math.abs,s);l.invert=s=>l(-s.x,-s.y);l.invertX=s=>l(-s.x,s.y);l.invertY=s=>l(s.x,-s.y);l.rotate90CW=s=>l(s.y,-s.x);l.rotate90CCW=s=>l(-s.y,s.x);l.angle=s=>{var t=Math.atan2(s.y,s.x),e=t*180/Math.PI;return e<0&&(e+=360),e};l.angleBetween=(s,t)=>{let e=l.dot(s,t),r=l.len(s),n=l.len(t);return Math.acos(e/(r*n))*180/Math.PI};l.angleBetweenClockwise=(s,t)=>{let e=l.dot(s,t),r=l.cross(s,t),i=Math.atan2(e,r)*(180/Math.PI);return i<0&&(i=360+i),i};var st=(s,t)=>({a:s,b:t}),K=st;st.len=s=>g.dist(s.a,s.b);st.intersect=(s,t)=>{let{a:e,b:r}=s,{a:n,b:i}=t,o=r.x-e.x,a=r.y-e.y,u=i.x-n.x,h=i.y-n.y,c=o*h-a*u;if(c===0)return null;let d=e.x-n.x,f=e.y-n.y,m=(d*h-f*u)/c,y=(o*f-a*d)/c;if(m>=0&&m<=1&&y>=0&&y<=1){let x=e.x+m*o,S=e.y+m*a;return{x,y:S}}return null};st.intersectAnywhere=(s,t)=>{let{a:e,b:r}=s,{a:n,b:i}=t,o=r.x-e.x,a=r.y-e.y,u=i.x-n.x,h=i.y-n.y,c=o*h-a*u;if(c===0)return null;let d=e.x-n.x,f=e.y-n.y,m=(d*h-f*u)/c,y=(o*f-a*d)/c,x=e.x+m*o,S=e.y+m*a;return{x,y:S}};st.getYforX=(s,t)=>{let{a:e,b:r}=s,{x:n,y:i}=e,{x:o,y:a}=r;return(a-i)/(o-n)*(t-n)+i};st.getXforY=(s,t)=>{let{a:e,b:r}=s,{x:n,y:i}=e,{x:o,y:a}=r,u=(a-i)/(o-n);return(t-i)/u+n};st.distToPoint=(s,t)=>{let{a:e,b:r}=s,n=g.sub(r,e),i=g.sub(t,e),o=g.dot(i,n)/g.dot(n,n);if(o<=0)return g.len(i);if(o>=1)return g.dist(t,r);{let a=g.add(e,g.mulS(n,o));return g.dist(t,a)}};function B(s){let t=s||"";return function(){throw new Error("this method "+t+" is abstract! (it has no implementation in class "+this.constructor.name+")")}}function X(s,t){if(!s)throw new Error(t||"Assertion failed")}function Tt(s,t,e){let r;Object.defineProperty(s,t,{get(){return r||(r=e.call(this)),r}})}function as(s){return s&&Object.assign({},s)}function he(s,t){let e=[];for(;t-- >0;)e.push(s());return e}function pe(s,t){return new Array(t+1).join(s)}function vt(s,t){return he(()=>s,t)}function Dt(s){let t=[];for(let e=0;e<s.length;e++){let r=s[e];s.lastIndexOf(r)!==e&&t.indexOf(r)<0&&t.push(r)}return t}function de(s){let t=[];return s.forEach(e=>{t.indexOf(e)<0&&t.push(e)}),t}function rt(s){let t=s[0];return t===t.toUpperCase()}function fe(s){return!rt(s)}function me(s,t,e){let r=e||" ";return s.length<t?pe(r,t-s.length)+s:s}function nt(){this.strings=[]}nt.prototype.append=function(s){this.strings.push(s)};nt.prototype.contents=function(){return this.strings.join("")};var Mt=s=>String.fromCodePoint(parseInt(s,16));function ge(s){if(s.charAt(0)==="\\")switch(s.charAt(1)){case"b":return"\b";case"f":return"\f";case"n":return`
`;case"r":return"\r";case"t":return"	";case"v":return"\v";case"x":return Mt(s.slice(2,4));case"u":return s.charAt(2)==="{"?Mt(s.slice(3,-1)):Mt(s.slice(2,6));default:return s.charAt(1)}else return s}function kt(s){if(s==null)return String(s);let t=Object.prototype.toString.call(s);try{let e;return s.constructor&&s.constructor.name?e=s.constructor.name:t.indexOf("[object ")===0?e=t.slice(8,-1):e=typeof s,e+": "+JSON.stringify(String(s))}catch(e){return t}}var ls=Object.freeze({__proto__:null,abstract:B,assert:X,defineLazyProperty:Tt,clone:as,repeatFn:he,repeatStr:pe,repeat:vt,getDuplicates:Dt,copyWithoutDuplicates:de,isSyntactic:rt,isLexical:fe,padLeft:me,StringBuffer:nt,unescapeCodePoint:ge,unexpectedObjToString:kt}),us={Lu:/\p{Lu}/u,Ll:/\p{Ll}/u,Lt:/\p{Lt}/u,Lm:/\p{Lm}/u,Lo:/\p{Lo}/u,Nl:/\p{Nl}/u,Nd:/\p{Nd}/u,Mn:/\p{Mn}/u,Mc:/\p{Mc}/u,Pc:/\p{Pc}/u,Zs:/\p{Zs}/u,L:/\p{Letter}/u,Ltmo:/\p{Lt}|\p{Lm}|\p{Lo}/u},v=class{constructor(){if(this.constructor===v)throw new Error("PExpr cannot be instantiated -- it's abstract")}withSource(t){return t&&(this.source=t.trimmed()),this}},C=Object.create(v.prototype),F=Object.create(v.prototype),P=class extends v{constructor(t){super();this.obj=t}},O=class extends v{constructor(t,e){super();this.from=t,this.to=e,this.matchCodePoint=t.length>1||e.length>1}},N=class extends v{constructor(t){super();this.index=t}},_=class extends v{constructor(t){super();this.terms=t}},pt=class extends _{constructor(t,e,r){let n=t.rules[e].body;super([r,n]);this.superGrammar=t,this.name=e,this.body=r}},dt=class extends _{constructor(t,e,r,n){let i=t.rules[e].body;super([...r,i,...n]);this.superGrammar=t,this.ruleName=e,this.expansionPos=r.length}},A=class extends v{constructor(t){super();this.factors=t}},T=class extends v{constructor(t){super();this.expr=t}},Y=class extends T{},it=class extends T{},V=class extends T{};Y.prototype.operator="*";it.prototype.operator="+";V.prototype.operator="?";Y.prototype.minNumMatches=0;it.prototype.minNumMatches=1;V.prototype.minNumMatches=0;Y.prototype.maxNumMatches=Number.POSITIVE_INFINITY;it.prototype.maxNumMatches=Number.POSITIVE_INFINITY;V.prototype.maxNumMatches=1;var D=class extends v{constructor(t){super();this.expr=t}},M=class extends v{constructor(t){super();this.expr=t}},j=class extends v{constructor(t){super();this.expr=t}},I=class extends v{constructor(t,e=[]){super();this.ruleName=t,this.args=e}isSyntactic(){return rt(this.ruleName)}toMemoKey(){return this._memoKey||Object.defineProperty(this,"_memoKey",{value:this.toString()}),this._memoKey}},L=class extends v{constructor(t){super();this.category=t,this.pattern=us[t]}};function b(s,t){let e;return t?(e=new Error(t.getLineAndColumnMessage()+s),e.shortMessage=s,e.interval=t):e=new Error(s),e}function Bt(){return b("Interval sources don't match")}function cs(s){let t=new Error;return Object.defineProperty(t,"message",{enumerable:!0,get(){return s.message}}),Object.defineProperty(t,"shortMessage",{enumerable:!0,get(){return"Expected "+s.getExpectedText()}}),t.interval=s.getInterval(),t}function hs(s,t,e){let r=t?`Grammar ${s} is not declared in namespace '${t}'`:"Undeclared grammar "+s;return b(r,e)}function ps(s,t){return b("Grammar "+s.name+" is already declared in this namespace")}function ds(s){return b(`Grammar '${s.name}' does not support incremental parsing`)}function ye(s,t,e){return b("Rule "+s+" is not declared in grammar "+t,e)}function fs(s,t,e){return b("Cannot override rule "+s+" because it is not declared in "+t,e)}function ms(s,t,e){return b("Cannot extend rule "+s+" because it is not declared in "+t,e)}function ve(s,t,e,r){let n="Duplicate declaration for rule '"+s+"' in grammar '"+t+"'";return t!==e&&(n+=" (originally declared in '"+e+"')"),b(n,r)}function xe(s,t,e,r){return b("Wrong number of parameters for rule "+s+" (expected "+t+", got "+e+")",r)}function gs(s,t,e,r){return b("Wrong number of arguments for rule "+s+" (expected "+t+", got "+e+")",r)}function Ie(s,t,e){return b("Duplicate parameter names in rule "+s+": "+t.join(", "),e)}function ys(s,t){return b("Invalid parameter to rule "+s+": "+t+" has arity "+t.getArity()+", but parameter expressions must have arity 1",t.source)}var vs="NOTE: A _syntactic rule_ is a rule whose name begins with a capital letter. See https://ohmjs.org/d/svl for more details.";function xs(s,t){return b("Cannot apply syntactic rule "+s+" from here (inside a lexical context)",t.source)}function Is(s){let{ruleName:t}=s;return b(`applySyntactic is for syntactic rules, but '${t}' is a lexical rule. `+vs,s.source)}function Ss(s){return b("applySyntactic is not required here (in a syntactic context)",s.source)}function Se(s,t){return b("Incorrect argument type: expected "+s,t.source)}function bs(s){return b("'...' can appear at most once in a rule body",s.source)}function ws(s){let t=s._node;X(t&&t.isNonterminal()&&t.ctorName==="escapeChar_unicodeCodePoint");let e=s.children.slice(1,-1).map(n=>n.source),r=e[0].coverageWith(...e.slice(1));return b(`U+${r.contents} is not a valid Unicode code point`,r)}function be(s,t){let e=t.length>0?t[t.length-1].args:[],r=s.expr.substituteParams(e),n="Nullable expression "+r+" is not allowed inside '"+s.operator+"' (possible infinite loop)";if(t.length>0){let i=t.map(o=>new I(o.ruleName,o.args)).join(`
`);n+=`
Application stack (most recent application last):
`+i}return b(n,s.expr.source)}function we(s,t,e,r){return b("Rule "+s+" involves an alternation which has inconsistent arity (expected "+t+", got "+e+")",r.source)}function _s(s){let t=s.map(e=>e.message);return b(["Errors:"].concat(t).join(`
- `),s[0].interval)}function As(s,t,e,r){let n=r.slice(0,-1).map(u=>{let h="  "+u[0].name+" > "+u[1];return u.length===3?h+" for '"+u[2]+"'":h}).join(`
`);n+=`
  `+t+" > "+s;let i="";s==="_iter"&&(i=[`
NOTE: as of Ohm v16, there is no default action for iteration nodes — see `,"  https://ohmjs.org/d/dsa for details."].join(`
`));let o=[`Missing semantic action for '${s}' in ${e} '${t}'.${i}`,"Action stack (most recent call last):",n].join(`
`),a=b(o);return a.name="missingSemanticAction",a}function Ps(s){if(s.length===1)throw s[0];if(s.length>1)throw _s(s)}function Ls(s){let t=0;return s.map(r=>{let n=r.toString();return t=Math.max(t,n.length),n}).map(r=>me(r,t))}function _e(s,t,e){let r=s.length,n=s.slice(0,e),i=s.slice(e+t.length);return(n+t+i).substr(0,r)}function Os(...s){let t=this,{offset:e}=t,{repeatStr:r}=ls,n=new nt;n.append("Line "+t.lineNum+", col "+t.colNum+`:
`);let i=Ls([t.prevLine==null?0:t.lineNum-1,t.lineNum,t.nextLine==null?0:t.lineNum+1]),o=(c,d,f)=>{n.append(f+i[c]+" | "+d+`
`)};t.prevLine!=null&&o(0,t.prevLine,"  "),o(1,t.line,"> ");let a=t.line.length,u=r(" ",a+1);for(let c=0;c<s.length;++c){let d=s[c][0],f=s[c][1];X(d>=0&&d<=f,"range start must be >= 0 and <= end");let m=e-t.colNum+1;d=Math.max(0,d-m),f=Math.min(f-m,a),u=_e(u,r("~",f-d),d)}let h=2+i[1].length+3;return n.append(r(" ",h)),u=_e(u,"^",t.colNum-1),n.append(u.replace(/ +$/,"")+`
`),t.nextLine!=null&&o(2,t.nextLine,"  "),n.contents()}var jt=[];function Ae(s){jt.push(s)}function Ns(s){jt.forEach(t=>{t(s)}),jt=null}function Gt(s,t){let e=1,r=1,n=0,i=0,o=null,a=null,u=-1;for(;n<t;){let d=s.charAt(n++);d===`
`?(e++,r=1,u=i,i=n):d!=="\r"&&r++}let h=s.indexOf(`
`,i);if(h===-1)h=s.length;else{let d=s.indexOf(`
`,h+1);o=d===-1?s.slice(h):s.slice(h,d),o=o.replace(/^\r?\n/,"").replace(/\r$/,"")}u>=0&&(a=s.slice(u,i).replace(/\r?\n$/,""));let c=s.slice(i,h).replace(/\r$/,"");return{offset:t,lineNum:e,colNum:r,line:c,prevLine:a,nextLine:o,toString:Os}}function qt(s,t,...e){return Gt(s,t).toString(...e)}var Pe=(()=>{let s=0;return t=>""+t+s++})(),R=class{constructor(t,e,r){this.sourceString=t,this.startIdx=e,this.endIdx=r}get contents(){return this._contents===void 0&&(this._contents=this.sourceString.slice(this.startIdx,this.endIdx)),this._contents}get length(){return this.endIdx-this.startIdx}coverageWith(...t){return R.coverage(...t,this)}collapsedLeft(){return new R(this.sourceString,this.startIdx,this.startIdx)}collapsedRight(){return new R(this.sourceString,this.endIdx,this.endIdx)}getLineAndColumn(){return Gt(this.sourceString,this.startIdx)}getLineAndColumnMessage(){let t=[this.startIdx,this.endIdx];return qt(this.sourceString,this.startIdx,t)}minus(t){if(this.sourceString!==t.sourceString)throw Bt();return this.startIdx===t.startIdx&&this.endIdx===t.endIdx?[]:this.startIdx<t.startIdx&&t.endIdx<this.endIdx?[new R(this.sourceString,this.startIdx,t.startIdx),new R(this.sourceString,t.endIdx,this.endIdx)]:this.startIdx<t.endIdx&&t.endIdx<this.endIdx?[new R(this.sourceString,t.endIdx,this.endIdx)]:this.startIdx<t.startIdx&&t.startIdx<this.endIdx?[new R(this.sourceString,this.startIdx,t.startIdx)]:[this]}relativeTo(t){if(this.sourceString!==t.sourceString)throw Bt();return X(this.startIdx>=t.startIdx&&this.endIdx<=t.endIdx,"other interval does not cover this one"),new R(this.sourceString,this.startIdx-t.startIdx,this.endIdx-t.startIdx)}trimmed(){let{contents:t}=this,e=this.startIdx+t.match(/^\s*/)[0].length,r=this.endIdx-t.match(/\s*$/)[0].length;return new R(this.sourceString,e,r)}subInterval(t,e){let r=this.startIdx+t;return new R(this.sourceString,r,r+e)}};R.coverage=function(s,...t){let{startIdx:e,endIdx:r}=s;for(let n of t){if(n.sourceString!==s.sourceString)throw Bt();e=Math.min(e,n.startIdx),r=Math.max(r,n.endIdx)}return new R(s.sourceString,e,r)};var Rs=65535,ft=class{constructor(t){this.source=t,this.pos=0,this.examinedLength=0}atEnd(){let t=this.pos>=this.source.length;return this.examinedLength=Math.max(this.examinedLength,this.pos+1),t}next(){let t=this.source[this.pos++];return this.examinedLength=Math.max(this.examinedLength,this.pos),t}nextCharCode(){let t=this.next();return t&&t.charCodeAt(0)}nextCodePoint(){let t=this.source.slice(this.pos++).codePointAt(0);return t>Rs&&(this.pos+=1),this.examinedLength=Math.max(this.examinedLength,this.pos),t}matchString(t,e){let r;if(e){for(r=0;r<t.length;r++){let n=this.next(),i=t[r];if(n==null||n.toUpperCase()!==i.toUpperCase())return!1}return!0}for(r=0;r<t.length;r++)if(this.next()!==t[r])return!1;return!0}sourceSlice(t,e){return this.source.slice(t,e)}interval(t,e){return new R(this.source,t,e||this.pos)}},$t=class{constructor(t,e,r,n,i,o,a){this.matcher=t,this.input=e,this.startExpr=r,this._cst=n,this._cstOffset=i,this._rightmostFailurePosition=o,this._rightmostFailures=a,this.failed()&&(Tt(this,"message",function(){let u="Expected "+this.getExpectedText();return qt(this.input,this.getRightmostFailurePosition())+u}),Tt(this,"shortMessage",function(){let u="expected "+this.getExpectedText(),h=Gt(this.input,this.getRightmostFailurePosition());return"Line "+h.lineNum+", col "+h.colNum+": "+u}))}succeeded(){return!!this._cst}failed(){return!this.succeeded()}getRightmostFailurePosition(){return this._rightmostFailurePosition}getRightmostFailures(){if(!this._rightmostFailures){this.matcher.setInput(this.input);let t=this.matcher._match(this.startExpr,{tracing:!1,positionToRecordFailures:this.getRightmostFailurePosition()});this._rightmostFailures=t.getRightmostFailures()}return this._rightmostFailures}toString(){return this.succeeded()?"[match succeeded]":"[match failed at position "+this.getRightmostFailurePosition()+"]"}getExpectedText(){if(this.succeeded())throw new Error("cannot get expected text of a successful MatchResult");let t=new nt,e=this.getRightmostFailures();e=e.filter(r=>!r.isFluffy());for(let r=0;r<e.length;r++)r>0&&(r===e.length-1?t.append(e.length>2?", or ":" or "):t.append(", ")),t.append(e[r].toString());return t.contents()}getInterval(){let t=this.getRightmostFailurePosition();return new R(this.input,t,t)}},Le=class{constructor(){this.applicationMemoKeyStack=[],this.memo={},this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,this.currentLeftRecursion=void 0}isActive(t){return this.applicationMemoKeyStack.indexOf(t.toMemoKey())>=0}enter(t){this.applicationMemoKeyStack.push(t.toMemoKey())}exit(){this.applicationMemoKeyStack.pop()}startLeftRecursion(t,e){e.isLeftRecursion=!0,e.headApplication=t,e.nextLeftRecursion=this.currentLeftRecursion,this.currentLeftRecursion=e;let{applicationMemoKeyStack:r}=this,n=r.indexOf(t.toMemoKey())+1,i=r.slice(n);e.isInvolved=function(o){return i.indexOf(o)>=0},e.updateInvolvedApplicationMemoKeys=function(){for(let o=n;o<r.length;o++){let a=r[o];this.isInvolved(a)||i.push(a)}}}endLeftRecursion(){this.currentLeftRecursion=this.currentLeftRecursion.nextLeftRecursion}shouldUseMemoizedResult(t){if(!t.isLeftRecursion)return!0;let{applicationMemoKeyStack:e}=this;for(let r=0;r<e.length;r++){let n=e[r];if(t.isInvolved(n))return!1}return!0}memoize(t,e){return this.memo[t]=e,this.maxExaminedLength=Math.max(this.maxExaminedLength,e.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,e.rightmostFailureOffset),e}clearObsoleteEntries(t,e){if(t+this.maxExaminedLength<=e)return;let{memo:r}=this;this.maxExaminedLength=0,this.maxRightmostFailureOffset=-1,Object.keys(r).forEach(n=>{let i=r[n];t+i.examinedLength>e?delete r[n]:(this.maxExaminedLength=Math.max(this.maxExaminedLength,i.examinedLength),this.maxRightmostFailureOffset=Math.max(this.maxRightmostFailureOffset,i.rightmostFailureOffset))})}},Es="✗",Cs="✓",Fs="⋅",Ts="⇒",Ds="␉",Ms="␊",ks="␍",Kt={succeeded:1<<0,isRootNode:1<<1,isImplicitSpaces:1<<2,isMemoized:1<<3,isHeadOfLeftRecursion:1<<4,terminatesLR:1<<5};function Bs(s){return vt(" ",s).join("")}function js(s,t,e){let r=Oe(s.slice(t,t+e));return r.length<e?r+vt(" ",e-r.length).join(""):r}function Oe(s){return typeof s=="string"?s.replace(/ /g,Fs).replace(/\t/g,Ds).replace(/\n/g,Ms).replace(/\r/g,ks):String(s)}var W=class{constructor(t,e,r,n,i,o,a){this.input=t,this.pos=this.pos1=e,this.pos2=r,this.source=new R(t,e,r),this.expr=n,this.bindings=o,this.children=a||[],this.terminatingLREntry=null,this._flags=i?Kt.succeeded:0}get displayString(){return this.expr.toDisplayString()}clone(){return this.cloneWithExpr(this.expr)}cloneWithExpr(t){let e=new W(this.input,this.pos,this.pos2,t,this.succeeded,this.bindings,this.children);return e.isHeadOfLeftRecursion=this.isHeadOfLeftRecursion,e.isImplicitSpaces=this.isImplicitSpaces,e.isMemoized=this.isMemoized,e.isRootNode=this.isRootNode,e.terminatesLR=this.terminatesLR,e.terminatingLREntry=this.terminatingLREntry,e}recordLRTermination(t,e){this.terminatingLREntry=new W(this.input,this.pos,this.pos2,this.expr,!1,[e],[t]),this.terminatingLREntry.terminatesLR=!0}walk(t,e){let r=t;typeof r=="function"&&(r={enter:r});function n(i,o,a){let u=!0;r.enter&&r.enter.call(e,i,o,a)===W.prototype.SKIP&&(u=!1),u&&(i.children.forEach(h=>{n(h,i,a+1)}),r.exit&&r.exit.call(e,i,o,a))}this.isRootNode?this.children.forEach(i=>{n(i,null,0)}):n(this,null,0)}toString(){let t=new nt;return this.walk((e,r,n)=>{if(!e)return this.SKIP;if(e.expr.constructor.name!=="Alt"){if(t.append(js(e.input,e.pos,10)+Bs(n*2+1)),t.append((e.succeeded?Cs:Es)+" "+e.displayString),e.isHeadOfLeftRecursion&&t.append(" (LR)"),e.succeeded){let o=Oe(e.source.contents);t.append(" "+Ts+"  "),t.append(typeof o=="string"?'"'+o+'"':o)}t.append(`
`)}}),t.contents()}};W.prototype.SKIP={};Object.keys(Kt).forEach(s=>{let t=Kt[s];Object.defineProperty(W.prototype,s,{get(){return(this._flags&t)!=0},set(e){e?this._flags|=t:this._flags&=~t}})});v.prototype.allowsSkippingPrecedingSpace=B("allowsSkippingPrecedingSpace");C.allowsSkippingPrecedingSpace=F.allowsSkippingPrecedingSpace=I.prototype.allowsSkippingPrecedingSpace=P.prototype.allowsSkippingPrecedingSpace=O.prototype.allowsSkippingPrecedingSpace=L.prototype.allowsSkippingPrecedingSpace=function(){return!0};_.prototype.allowsSkippingPrecedingSpace=T.prototype.allowsSkippingPrecedingSpace=j.prototype.allowsSkippingPrecedingSpace=M.prototype.allowsSkippingPrecedingSpace=D.prototype.allowsSkippingPrecedingSpace=N.prototype.allowsSkippingPrecedingSpace=A.prototype.allowsSkippingPrecedingSpace=function(){return!1};var mt;Ae(s=>{mt=s});var xt;v.prototype.assertAllApplicationsAreValid=function(s,t){xt=0,this._assertAllApplicationsAreValid(s,t)};v.prototype._assertAllApplicationsAreValid=B("_assertAllApplicationsAreValid");C._assertAllApplicationsAreValid=F._assertAllApplicationsAreValid=P.prototype._assertAllApplicationsAreValid=O.prototype._assertAllApplicationsAreValid=N.prototype._assertAllApplicationsAreValid=L.prototype._assertAllApplicationsAreValid=function(s,t){};j.prototype._assertAllApplicationsAreValid=function(s,t){xt++,this.expr._assertAllApplicationsAreValid(s,t),xt--};_.prototype._assertAllApplicationsAreValid=function(s,t){for(let e=0;e<this.terms.length;e++)this.terms[e]._assertAllApplicationsAreValid(s,t)};A.prototype._assertAllApplicationsAreValid=function(s,t){for(let e=0;e<this.factors.length;e++)this.factors[e]._assertAllApplicationsAreValid(s,t)};T.prototype._assertAllApplicationsAreValid=D.prototype._assertAllApplicationsAreValid=M.prototype._assertAllApplicationsAreValid=function(s,t){this.expr._assertAllApplicationsAreValid(s,t)};I.prototype._assertAllApplicationsAreValid=function(s,t,e=!1){let r=t.rules[this.ruleName],n=rt(s)&&xt===0;if(!r)throw ye(this.ruleName,t.name,this.source);if(!e&&rt(this.ruleName)&&!n)throw xs(this.ruleName,this);let i=this.args.length,o=r.formals.length;if(i!==o)throw gs(this.ruleName,o,i,this.source);let a=mt&&r===mt.rules.applySyntactic;if(mt&&r===mt.rules.caseInsensitive&&!(this.args[0]instanceof P))throw Se('a Terminal (e.g. "abc")',this.args[0]);if(a){let h=this.args[0];if(!(h instanceof I))throw Se("a syntactic rule application",h);if(!rt(h.ruleName))throw Is(h);if(n)throw Ss(this)}this.args.forEach(h=>{if(h._assertAllApplicationsAreValid(s,t,a),h.getArity()!==1)throw ys(this.ruleName,h)})};v.prototype.assertChoicesHaveUniformArity=B("assertChoicesHaveUniformArity");C.assertChoicesHaveUniformArity=F.assertChoicesHaveUniformArity=P.prototype.assertChoicesHaveUniformArity=O.prototype.assertChoicesHaveUniformArity=N.prototype.assertChoicesHaveUniformArity=j.prototype.assertChoicesHaveUniformArity=L.prototype.assertChoicesHaveUniformArity=function(s){};_.prototype.assertChoicesHaveUniformArity=function(s){if(this.terms.length===0)return;let t=this.terms[0].getArity();for(let e=0;e<this.terms.length;e++){let r=this.terms[e];r.assertChoicesHaveUniformArity();let n=r.getArity();if(t!==n)throw we(s,t,n,r)}};pt.prototype.assertChoicesHaveUniformArity=function(s){let t=this.terms[0].getArity(),e=this.terms[1].getArity();if(t!==e)throw we(s,e,t,this.terms[0])};A.prototype.assertChoicesHaveUniformArity=function(s){for(let t=0;t<this.factors.length;t++)this.factors[t].assertChoicesHaveUniformArity(s)};T.prototype.assertChoicesHaveUniformArity=function(s){this.expr.assertChoicesHaveUniformArity(s)};D.prototype.assertChoicesHaveUniformArity=function(s){};M.prototype.assertChoicesHaveUniformArity=function(s){this.expr.assertChoicesHaveUniformArity(s)};I.prototype.assertChoicesHaveUniformArity=function(s){};v.prototype.assertIteratedExprsAreNotNullable=B("assertIteratedExprsAreNotNullable");C.assertIteratedExprsAreNotNullable=F.assertIteratedExprsAreNotNullable=P.prototype.assertIteratedExprsAreNotNullable=O.prototype.assertIteratedExprsAreNotNullable=N.prototype.assertIteratedExprsAreNotNullable=L.prototype.assertIteratedExprsAreNotNullable=function(s){};_.prototype.assertIteratedExprsAreNotNullable=function(s){for(let t=0;t<this.terms.length;t++)this.terms[t].assertIteratedExprsAreNotNullable(s)};A.prototype.assertIteratedExprsAreNotNullable=function(s){for(let t=0;t<this.factors.length;t++)this.factors[t].assertIteratedExprsAreNotNullable(s)};T.prototype.assertIteratedExprsAreNotNullable=function(s){if(this.expr.assertIteratedExprsAreNotNullable(s),this.expr.isNullable(s))throw be(this,[])};V.prototype.assertIteratedExprsAreNotNullable=D.prototype.assertIteratedExprsAreNotNullable=M.prototype.assertIteratedExprsAreNotNullable=j.prototype.assertIteratedExprsAreNotNullable=function(s){this.expr.assertIteratedExprsAreNotNullable(s)};I.prototype.assertIteratedExprsAreNotNullable=function(s){this.args.forEach(t=>{t.assertIteratedExprsAreNotNullable(s)})};var It=class{constructor(t){this.matchLength=t}get ctorName(){throw new Error("subclass responsibility")}numChildren(){return this.children?this.children.length:0}childAt(t){if(this.children)return this.children[t]}indexOfChild(t){return this.children.indexOf(t)}hasChildren(){return this.numChildren()>0}hasNoChildren(){return!this.hasChildren()}onlyChild(){if(this.numChildren()!==1)throw new Error("cannot get only child of a node of type "+this.ctorName+" (it has "+this.numChildren()+" children)");return this.firstChild()}firstChild(){if(this.hasNoChildren())throw new Error("cannot get first child of a "+this.ctorName+" node, which has no children");return this.childAt(0)}lastChild(){if(this.hasNoChildren())throw new Error("cannot get last child of a "+this.ctorName+" node, which has no children");return this.childAt(this.numChildren()-1)}childBefore(t){let e=this.indexOfChild(t);if(e<0)throw new Error("Node.childBefore() called w/ an argument that is not a child");if(e===0)throw new Error("cannot get child before first child");return this.childAt(e-1)}childAfter(t){let e=this.indexOfChild(t);if(e<0)throw new Error("Node.childAfter() called w/ an argument that is not a child");if(e===this.numChildren()-1)throw new Error("cannot get child after last child");return this.childAt(e+1)}isTerminal(){return!1}isNonterminal(){return!1}isIteration(){return!1}isOptional(){return!1}},J=class extends It{get ctorName(){return"_terminal"}isTerminal(){return!0}get primitiveValue(){throw new Error("The `primitiveValue` property was removed in Ohm v17.")}},Ne=class extends It{constructor(t,e,r,n){super(n);this.ruleName=t,this.children=e,this.childOffsets=r}get ctorName(){return this.ruleName}isNonterminal(){return!0}isLexical(){return fe(this.ctorName)}isSyntactic(){return rt(this.ctorName)}},zt=class extends It{constructor(t,e,r,n){super(r);this.children=t,this.childOffsets=e,this.optional=n}get ctorName(){return"_iter"}isIteration(){return!0}isOptional(){return this.optional}};v.prototype.eval=B("eval");C.eval=function(s){let{inputStream:t}=s,e=t.pos,r=t.nextCodePoint();return r!==void 0?(s.pushBinding(new J(String.fromCodePoint(r).length),e),!0):(s.processFailure(e,this),!1)};F.eval=function(s){let{inputStream:t}=s,e=t.pos;return t.atEnd()?(s.pushBinding(new J(0),e),!0):(s.processFailure(e,this),!1)};P.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos;return t.matchString(this.obj)?(s.pushBinding(new J(this.obj.length),e),!0):(s.processFailure(e,this),!1)};O.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos,r=this.matchCodePoint?t.nextCodePoint():t.nextCharCode();return r!==void 0&&this.from.codePointAt(0)<=r&&r<=this.to.codePointAt(0)?(s.pushBinding(new J(String.fromCodePoint(r).length),e),!0):(s.processFailure(e,this),!1)};N.prototype.eval=function(s){return s.eval(s.currentApplication().args[this.index])};j.prototype.eval=function(s){s.enterLexifiedContext();let t=s.eval(this.expr);return s.exitLexifiedContext(),t};_.prototype.eval=function(s){for(let t=0;t<this.terms.length;t++)if(s.eval(this.terms[t]))return!0;return!1};A.prototype.eval=function(s){for(let t=0;t<this.factors.length;t++){let e=this.factors[t];if(!s.eval(e))return!1}return!0};T.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos,r=this.getArity(),n=[],i=[];for(;n.length<r;)n.push([]),i.push([]);let o=0,a=e,u;for(;o<this.maxNumMatches&&s.eval(this.expr);){if(t.pos===a)throw be(this,s._applicationStack);a=t.pos,o++;let f=s._bindings.splice(s._bindings.length-r,r),m=s._bindingOffsets.splice(s._bindingOffsets.length-r,r);for(u=0;u<f.length;u++)n[u].push(f[u]),i[u].push(m[u])}if(o<this.minNumMatches)return!1;let h=s.posToOffset(e),c=0;if(o>0){let f=n[r-1],m=i[r-1],y=m[m.length-1]+f[f.length-1].matchLength;h=i[0][0],c=y-h}let d=this instanceof V;for(u=0;u<n.length;u++)s._bindings.push(new zt(n[u],i[u],c,d)),s._bindingOffsets.push(h);return!0};D.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos;s.pushFailuresInfo();let r=s.eval(this.expr);return s.popFailuresInfo(),r?(s.processFailure(e,this),!1):(t.pos=e,!0)};M.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos;return s.eval(this.expr)?(t.pos=e,!0):!1};I.prototype.eval=function(s){let t=s.currentApplication(),e=t?t.args:[],r=this.substituteParams(e),n=s.getCurrentPosInfo();if(n.isActive(r))return r.handleCycle(s);let i=r.toMemoKey(),o=n.memo[i];if(o&&n.shouldUseMemoizedResult(o)){if(s.hasNecessaryInfo(o))return s.useMemoizedResult(s.inputStream.pos,o);delete n.memo[i]}return r.reallyEval(s)};I.prototype.handleCycle=function(s){let t=s.getCurrentPosInfo(),{currentLeftRecursion:e}=t,r=this.toMemoKey(),n=t.memo[r];return e&&e.headApplication.toMemoKey()===r?n.updateInvolvedApplicationMemoKeys():n||(n=t.memoize(r,{matchLength:0,examinedLength:0,value:!1,rightmostFailureOffset:-1}),t.startLeftRecursion(this,n)),s.useMemoizedResult(s.inputStream.pos,n)};I.prototype.reallyEval=function(s){let{inputStream:t}=s,e=t.pos,r=s.getCurrentPosInfo(),n=s.grammar.rules[this.ruleName],{body:i}=n,{description:o}=n;s.enterApplication(r,this),o&&s.pushFailuresInfo();let a=t.examinedLength;t.examinedLength=0;let u=this.evalOnce(i,s),h=r.currentLeftRecursion,c=this.toMemoKey(),d=h&&h.headApplication.toMemoKey()===c,f;s.doNotMemoize?s.doNotMemoize=!1:d?(u=this.growSeedResult(i,s,e,h,u),r.endLeftRecursion(),f=h,f.examinedLength=t.examinedLength-e,f.rightmostFailureOffset=s._getRightmostFailureOffset(),r.memoize(c,f)):(!h||!h.isInvolved(c))&&(f=r.memoize(c,{matchLength:t.pos-e,examinedLength:t.examinedLength-e,value:u,failuresAtRightmostPosition:s.cloneRecordedFailures(),rightmostFailureOffset:s._getRightmostFailureOffset()}));let m=!!u;if(o&&(s.popFailuresInfo(),m||s.processFailure(e,this),f&&(f.failuresAtRightmostPosition=s.cloneRecordedFailures())),s.isTracing()&&f){let y=s.getTraceEntry(e,this,m,m?[u]:[]);d&&(X(y.terminatingLREntry!=null||!m),y.isHeadOfLeftRecursion=!0),f.traceEntry=y}return t.examinedLength=Math.max(t.examinedLength,a),s.exitApplication(r,u),m};I.prototype.evalOnce=function(s,t){let{inputStream:e}=t,r=e.pos;if(t.eval(s)){let n=s.getArity(),i=t._bindings.splice(t._bindings.length-n,n),o=t._bindingOffsets.splice(t._bindingOffsets.length-n,n),a=e.pos-r;return new Ne(this.ruleName,i,o,a)}else return!1};I.prototype.growSeedResult=function(s,t,e,r,n){if(!n)return!1;let{inputStream:i}=t;for(;;){if(r.matchLength=i.pos-e,r.value=n,r.failuresAtRightmostPosition=t.cloneRecordedFailures(),t.isTracing()){let o=t.trace[t.trace.length-1];r.traceEntry=new W(t.input,e,i.pos,this,!0,[n],[o.clone()])}if(i.pos=e,n=this.evalOnce(s,t),i.pos-e<=r.matchLength)break;t.isTracing()&&t.trace.splice(-2,1)}return t.isTracing()&&r.traceEntry.recordLRTermination(t.trace.pop(),n),i.pos=e+r.matchLength,r.value};L.prototype.eval=function(s){let{inputStream:t}=s,e=t.pos,r=t.next();return r&&this.pattern.test(r)?(s.pushBinding(new J(r.length),e),!0):(s.processFailure(e,this),!1)};v.prototype.getArity=B("getArity");C.getArity=F.getArity=P.prototype.getArity=O.prototype.getArity=N.prototype.getArity=I.prototype.getArity=L.prototype.getArity=function(){return 1};_.prototype.getArity=function(){return this.terms.length===0?0:this.terms[0].getArity()};A.prototype.getArity=function(){let s=0;for(let t=0;t<this.factors.length;t++)s+=this.factors[t].getArity();return s};T.prototype.getArity=function(){return this.expr.getArity()};D.prototype.getArity=function(){return 0};M.prototype.getArity=j.prototype.getArity=function(){return this.expr.getArity()};function z(s,t){let e={};if(s.source&&t){let r=s.source.relativeTo(t);e.sourceInterval=[r.startIdx,r.endIdx]}return e}v.prototype.outputRecipe=B("outputRecipe");C.outputRecipe=function(s,t){return["any",z(this,t)]};F.outputRecipe=function(s,t){return["end",z(this,t)]};P.prototype.outputRecipe=function(s,t){return["terminal",z(this,t),this.obj]};O.prototype.outputRecipe=function(s,t){return["range",z(this,t),this.from,this.to]};N.prototype.outputRecipe=function(s,t){return["param",z(this,t),this.index]};_.prototype.outputRecipe=function(s,t){return["alt",z(this,t)].concat(this.terms.map(e=>e.outputRecipe(s,t)))};pt.prototype.outputRecipe=function(s,t){return this.terms[0].outputRecipe(s,t)};dt.prototype.outputRecipe=function(s,t){let e=this.terms.slice(0,this.expansionPos),r=this.terms.slice(this.expansionPos+1);return["splice",z(this,t),e.map(n=>n.outputRecipe(s,t)),r.map(n=>n.outputRecipe(s,t))]};A.prototype.outputRecipe=function(s,t){return["seq",z(this,t)].concat(this.factors.map(e=>e.outputRecipe(s,t)))};Y.prototype.outputRecipe=it.prototype.outputRecipe=V.prototype.outputRecipe=D.prototype.outputRecipe=M.prototype.outputRecipe=j.prototype.outputRecipe=function(s,t){return[this.constructor.name.toLowerCase(),z(this,t),this.expr.outputRecipe(s,t)]};I.prototype.outputRecipe=function(s,t){return["app",z(this,t),this.ruleName,this.args.map(e=>e.outputRecipe(s,t))]};L.prototype.outputRecipe=function(s,t){return["unicodeChar",z(this,t),this.category]};v.prototype.introduceParams=B("introduceParams");C.introduceParams=F.introduceParams=P.prototype.introduceParams=O.prototype.introduceParams=N.prototype.introduceParams=L.prototype.introduceParams=function(s){return this};_.prototype.introduceParams=function(s){return this.terms.forEach((t,e,r)=>{r[e]=t.introduceParams(s)}),this};A.prototype.introduceParams=function(s){return this.factors.forEach((t,e,r)=>{r[e]=t.introduceParams(s)}),this};T.prototype.introduceParams=D.prototype.introduceParams=M.prototype.introduceParams=j.prototype.introduceParams=function(s){return this.expr=this.expr.introduceParams(s),this};I.prototype.introduceParams=function(s){let t=s.indexOf(this.ruleName);if(t>=0){if(this.args.length>0)throw new Error("Parameterized rules cannot be passed as arguments to another rule.");return new N(t).withSource(this.source)}else return this.args.forEach((e,r,n)=>{n[r]=e.introduceParams(s)}),this};v.prototype.isNullable=function(s){return this._isNullable(s,Object.create(null))};v.prototype._isNullable=B("_isNullable");C._isNullable=O.prototype._isNullable=N.prototype._isNullable=it.prototype._isNullable=L.prototype._isNullable=function(s,t){return!1};F._isNullable=function(s,t){return!0};P.prototype._isNullable=function(s,t){return typeof this.obj=="string"?this.obj==="":!1};_.prototype._isNullable=function(s,t){return this.terms.length===0||this.terms.some(e=>e._isNullable(s,t))};A.prototype._isNullable=function(s,t){return this.factors.every(e=>e._isNullable(s,t))};Y.prototype._isNullable=V.prototype._isNullable=D.prototype._isNullable=M.prototype._isNullable=function(s,t){return!0};j.prototype._isNullable=function(s,t){return this.expr._isNullable(s,t)};I.prototype._isNullable=function(s,t){let e=this.toMemoKey();if(!Object.prototype.hasOwnProperty.call(t,e)){let{body:r}=s.rules[this.ruleName],n=r.substituteParams(this.args);t[e]=!1,t[e]=n._isNullable(s,t)}return t[e]};v.prototype.substituteParams=B("substituteParams");C.substituteParams=F.substituteParams=P.prototype.substituteParams=O.prototype.substituteParams=L.prototype.substituteParams=function(s){return this};N.prototype.substituteParams=function(s){return s[this.index]};_.prototype.substituteParams=function(s){return new _(this.terms.map(t=>t.substituteParams(s)))};A.prototype.substituteParams=function(s){return new A(this.factors.map(t=>t.substituteParams(s)))};T.prototype.substituteParams=D.prototype.substituteParams=M.prototype.substituteParams=j.prototype.substituteParams=function(s){return new this.constructor(this.expr.substituteParams(s))};I.prototype.substituteParams=function(s){if(this.args.length===0)return this;{let t=this.args.map(e=>e.substituteParams(s));return new I(this.ruleName,t)}};function Re(s){return/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(s)}function Vt(s){let t=Object.create(null);s.forEach(e=>{t[e]=(t[e]||0)+1}),Object.keys(t).forEach(e=>{if(t[e]<=1)return;let r=1;s.forEach((n,i)=>{n===e&&(s[i]=n+"_"+r++)})})}v.prototype.toArgumentNameList=B("toArgumentNameList");C.toArgumentNameList=function(s,t){return["any"]};F.toArgumentNameList=function(s,t){return["end"]};P.prototype.toArgumentNameList=function(s,t){return typeof this.obj=="string"&&/^[_a-zA-Z0-9]+$/.test(this.obj)?["_"+this.obj]:["$"+s]};O.prototype.toArgumentNameList=function(s,t){let e=this.from+"_to_"+this.to;return Re(e)||(e="_"+e),Re(e)||(e="$"+s),[e]};_.prototype.toArgumentNameList=function(s,t){let e=this.terms.map(i=>i.toArgumentNameList(s,!0)),r=[],n=e[0].length;for(let i=0;i<n;i++){let o=[];for(let u=0;u<this.terms.length;u++)o.push(e[u][i]);let a=de(o);r.push(a.join("_or_"))}return t||Vt(r),r};A.prototype.toArgumentNameList=function(s,t){let e=[];return this.factors.forEach(r=>{let n=r.toArgumentNameList(s,!0);e=e.concat(n),s+=n.length}),t||Vt(e),e};T.prototype.toArgumentNameList=function(s,t){let e=this.expr.toArgumentNameList(s,t).map(r=>r[r.length-1]==="s"?r+"es":r+"s");return t||Vt(e),e};V.prototype.toArgumentNameList=function(s,t){return this.expr.toArgumentNameList(s,t).map(e=>"opt"+e[0].toUpperCase()+e.slice(1))};D.prototype.toArgumentNameList=function(s,t){return[]};M.prototype.toArgumentNameList=j.prototype.toArgumentNameList=function(s,t){return this.expr.toArgumentNameList(s,t)};I.prototype.toArgumentNameList=function(s,t){return[this.ruleName]};L.prototype.toArgumentNameList=function(s,t){return["$"+s]};N.prototype.toArgumentNameList=function(s,t){return["param"+this.index]};v.prototype.toDisplayString=B("toDisplayString");_.prototype.toDisplayString=A.prototype.toDisplayString=function(){return this.source?this.source.trimmed().contents:"["+this.constructor.name+"]"};C.toDisplayString=F.toDisplayString=T.prototype.toDisplayString=D.prototype.toDisplayString=M.prototype.toDisplayString=j.prototype.toDisplayString=P.prototype.toDisplayString=O.prototype.toDisplayString=N.prototype.toDisplayString=function(){return this.toString()};I.prototype.toDisplayString=function(){if(this.args.length>0){let s=this.args.map(t=>t.toDisplayString());return this.ruleName+"<"+s.join(",")+">"}else return this.ruleName};L.prototype.toDisplayString=function(){return"Unicode ["+this.category+"] character"};function Gs(s){return s==="description"||s==="string"||s==="code"}var G=class{constructor(t,e,r){if(!Gs(r))throw new Error("invalid Failure type: "+r);this.pexpr=t,this.text=e,this.type=r,this.fluffy=!1}getPExpr(){return this.pexpr}getText(){return this.text}getType(){return this.type}isDescription(){return this.type==="description"}isStringTerminal(){return this.type==="string"}isCode(){return this.type==="code"}isFluffy(){return this.fluffy}makeFluffy(){this.fluffy=!0}clearFluffy(){this.fluffy=!1}subsumes(t){return this.getText()===t.getText()&&this.type===t.type&&(!this.isFluffy()||this.isFluffy()&&t.isFluffy())}toString(){return this.type==="string"?JSON.stringify(this.getText()):this.getText()}clone(){let t=new G(this.pexpr,this.text,this.type);return this.isFluffy()&&t.makeFluffy(),t}toKey(){return this.toString()+"#"+this.type}};v.prototype.toFailure=B("toFailure");C.toFailure=function(s){return new G(this,"any object","description")};F.toFailure=function(s){return new G(this,"end of input","description")};P.prototype.toFailure=function(s){return new G(this,this.obj,"string")};O.prototype.toFailure=function(s){return new G(this,JSON.stringify(this.from)+".."+JSON.stringify(this.to),"code")};D.prototype.toFailure=function(s){let t=this.expr===C?"nothing":"not "+this.expr.toFailure(s);return new G(this,t,"description")};M.prototype.toFailure=function(s){return this.expr.toFailure(s)};I.prototype.toFailure=function(s){let{description:t}=s.rules[this.ruleName];return t||(t=(/^[aeiouAEIOU]/.test(this.ruleName)?"an":"a")+" "+this.ruleName),new G(this,t,"description")};L.prototype.toFailure=function(s){return new G(this,"a Unicode ["+this.category+"] character","description")};_.prototype.toFailure=function(s){let t=this.terms.map(r=>r.toFailure(s)),e="("+t.join(" or ")+")";return new G(this,e,"description")};A.prototype.toFailure=function(s){let t=this.factors.map(r=>r.toFailure(s)),e="("+t.join(" ")+")";return new G(this,e,"description")};T.prototype.toFailure=function(s){let t="("+this.expr.toFailure(s)+this.operator+")";return new G(this,t,"description")};v.prototype.toString=B("toString");C.toString=function(){return"any"};F.toString=function(){return"end"};P.prototype.toString=function(){return JSON.stringify(this.obj)};O.prototype.toString=function(){return JSON.stringify(this.from)+".."+JSON.stringify(this.to)};N.prototype.toString=function(){return"$"+this.index};j.prototype.toString=function(){return"#("+this.expr.toString()+")"};_.prototype.toString=function(){return this.terms.length===1?this.terms[0].toString():"("+this.terms.map(s=>s.toString()).join(" | ")+")"};A.prototype.toString=function(){return this.factors.length===1?this.factors[0].toString():"("+this.factors.map(s=>s.toString()).join(" ")+")"};T.prototype.toString=function(){return this.expr+this.operator};D.prototype.toString=function(){return"~"+this.expr};M.prototype.toString=function(){return"&"+this.expr};I.prototype.toString=function(){if(this.args.length>0){let s=this.args.map(t=>t.toString());return this.ruleName+"<"+s.join(",")+">"}else return this.ruleName};L.prototype.toString=function(){return"\\p{"+this.category+"}"};var St=class extends v{constructor(t){super();this.obj=t}_getString(t){let e=t.currentApplication().args[this.obj.index];return X(e instanceof P,"expected a Terminal expression"),e.obj}allowsSkippingPrecedingSpace(){return!0}eval(t){let{inputStream:e}=t,r=e.pos,n=this._getString(t);return e.matchString(n,!0)?(t.pushBinding(new J(n.length),r),!0):(t.processFailure(r,this),!1)}getArity(){return 1}substituteParams(t){return new St(this.obj.substituteParams(t))}toDisplayString(){return this.obj.toDisplayString()+" (case-insensitive)"}toFailure(t){return new G(this,this.obj.toFailure(t)+" (case-insensitive)","description")}_isNullable(t,e){return this.obj._isNullable(t,e)}};var Ee;Ae(s=>{Ee=s.rules.applySyntactic.body});var Ut=new I("spaces"),Ce=class{constructor(t,e,r){this.matcher=t,this.startExpr=e,this.grammar=t.grammar,this.input=t.getInput(),this.inputStream=new ft(this.input),this.memoTable=t._memoTable,this.userData=void 0,this.doNotMemoize=!1,this._bindings=[],this._bindingOffsets=[],this._applicationStack=[],this._posStack=[0],this.inLexifiedContextStack=[!1],this.rightmostFailurePosition=-1,this._rightmostFailurePositionStack=[],this._recordedFailuresStack=[],r!==void 0&&(this.positionToRecordFailures=r,this.recordedFailures=Object.create(null))}posToOffset(t){return t-this._posStack[this._posStack.length-1]}enterApplication(t,e){this._posStack.push(this.inputStream.pos),this._applicationStack.push(e),this.inLexifiedContextStack.push(!1),t.enter(e),this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this.rightmostFailurePosition=-1}exitApplication(t,e){let r=this._posStack.pop();this._applicationStack.pop(),this.inLexifiedContextStack.pop(),t.exit(),this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,this._rightmostFailurePositionStack.pop()),e&&this.pushBinding(e,r)}enterLexifiedContext(){this.inLexifiedContextStack.push(!0)}exitLexifiedContext(){this.inLexifiedContextStack.pop()}currentApplication(){return this._applicationStack[this._applicationStack.length-1]}inSyntacticContext(){let t=this.currentApplication();return t?t.isSyntactic()&&!this.inLexifiedContext():this.startExpr.factors[0].isSyntactic()}inLexifiedContext(){return this.inLexifiedContextStack[this.inLexifiedContextStack.length-1]}skipSpaces(){return this.pushFailuresInfo(),this.eval(Ut),this.popBinding(),this.popFailuresInfo(),this.inputStream.pos}skipSpacesIfInSyntacticContext(){return this.inSyntacticContext()?this.skipSpaces():this.inputStream.pos}maybeSkipSpacesBefore(t){return t.allowsSkippingPrecedingSpace()&&t!==Ut?this.skipSpacesIfInSyntacticContext():this.inputStream.pos}pushBinding(t,e){this._bindings.push(t),this._bindingOffsets.push(this.posToOffset(e))}popBinding(){this._bindings.pop(),this._bindingOffsets.pop()}numBindings(){return this._bindings.length}truncateBindings(t){for(;this._bindings.length>t;)this.popBinding()}getCurrentPosInfo(){return this.getPosInfo(this.inputStream.pos)}getPosInfo(t){let e=this.memoTable[t];return e||(e=this.memoTable[t]=new Le),e}processFailure(t,e){if(this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,t),this.recordedFailures&&t===this.positionToRecordFailures){let r=this.currentApplication();r&&(e=e.substituteParams(r.args)),this.recordFailure(e.toFailure(this.grammar),!1)}}recordFailure(t,e){let r=t.toKey();this.recordedFailures[r]?this.recordedFailures[r].isFluffy()&&!t.isFluffy()&&this.recordedFailures[r].clearFluffy():this.recordedFailures[r]=e?t.clone():t}recordFailures(t,e){Object.keys(t).forEach(r=>{this.recordFailure(t[r],e)})}cloneRecordedFailures(){if(!this.recordedFailures)return;let t=Object.create(null);return Object.keys(this.recordedFailures).forEach(e=>{t[e]=this.recordedFailures[e].clone()}),t}getRightmostFailurePosition(){return this.rightmostFailurePosition}_getRightmostFailureOffset(){return this.rightmostFailurePosition>=0?this.posToOffset(this.rightmostFailurePosition):-1}getMemoizedTraceEntry(t,e){let r=this.memoTable[t];if(r&&e instanceof I){let n=r.memo[e.toMemoKey()];if(n&&n.traceEntry){let i=n.traceEntry.cloneWithExpr(e);return i.isMemoized=!0,i}}return null}getTraceEntry(t,e,r,n){if(e instanceof I){let i=this.currentApplication(),o=i?i.args:[];e=e.substituteParams(o)}return this.getMemoizedTraceEntry(t,e)||new W(this.input,t,this.inputStream.pos,e,r,n,this.trace)}isTracing(){return!!this.trace}hasNecessaryInfo(t){return this.trace&&!t.traceEntry?!1:this.recordedFailures&&this.inputStream.pos+t.rightmostFailureOffset===this.positionToRecordFailures?!!t.failuresAtRightmostPosition:!0}useMemoizedResult(t,e){this.trace&&this.trace.push(e.traceEntry);let r=this.inputStream.pos+e.rightmostFailureOffset;return this.rightmostFailurePosition=Math.max(this.rightmostFailurePosition,r),this.recordedFailures&&this.positionToRecordFailures===r&&e.failuresAtRightmostPosition&&this.recordFailures(e.failuresAtRightmostPosition,!0),this.inputStream.examinedLength=Math.max(this.inputStream.examinedLength,e.examinedLength+t),e.value?(this.inputStream.pos+=e.matchLength,this.pushBinding(e.value,t),!0):!1}eval(t){let{inputStream:e}=this,r=this._bindings.length,n=this.userData,i;this.recordedFailures&&(i=this.recordedFailures,this.recordedFailures=Object.create(null));let o=e.pos,a=this.maybeSkipSpacesBefore(t),u;this.trace&&(u=this.trace,this.trace=[]);let h=t.eval(this);if(this.trace){let c=this._bindings.slice(r),d=this.getTraceEntry(a,t,h,c);d.isImplicitSpaces=t===Ut,d.isRootNode=t===this.startExpr,u.push(d),this.trace=u}return h?this.recordedFailures&&e.pos===this.positionToRecordFailures&&Object.keys(this.recordedFailures).forEach(c=>{this.recordedFailures[c].makeFluffy()}):(e.pos=o,this.truncateBindings(r),this.userData=n),this.recordedFailures&&this.recordFailures(i,!1),t===Ee&&this.skipSpaces(),h}getMatchResult(){this.grammar._setUpMatchState(this),this.eval(this.startExpr);let t;this.recordedFailures&&(t=Object.keys(this.recordedFailures).map(r=>this.recordedFailures[r]));let e=this._bindings[0];return e&&(e.grammar=this.grammar),new $t(this.matcher,this.input,this.startExpr,e,this._bindingOffsets[0],this.rightmostFailurePosition,t)}getTrace(){this.trace=[];let t=this.getMatchResult(),e=this.trace[this.trace.length-1];return e.result=t,e}pushFailuresInfo(){this._rightmostFailurePositionStack.push(this.rightmostFailurePosition),this._recordedFailuresStack.push(this.recordedFailures)}popFailuresInfo(){this.rightmostFailurePosition=this._rightmostFailurePositionStack.pop(),this.recordedFailures=this._recordedFailuresStack.pop()}},Fe=class{constructor(t){this.grammar=t,this._memoTable=[],this._input="",this._isMemoTableStale=!1}_resetMemoTable(){this._memoTable=[],this._isMemoTableStale=!1}getInput(){return this._input}setInput(t){return this._input!==t&&this.replaceInputRange(0,this._input.length,t),this}replaceInputRange(t,e,r){let n=this._input,i=this._memoTable;if(t<0||t>n.length||e<0||e>n.length||t>e)throw new Error("Invalid indices: "+t+" and "+e);this._input=n.slice(0,t)+r+n.slice(e),this._input!==n&&i.length>0&&(this._isMemoTableStale=!0);let o=i.slice(e);i.length=t;for(let a=0;a<r.length;a++)i.push(void 0);for(let a of o)i.push(a);for(let a=0;a<t;a++){let u=i[a];u&&u.clearObsoleteEntries(a,t)}return this}match(t,e={incremental:!0}){return this._match(this._getStartExpr(t),{incremental:e.incremental,tracing:!1})}trace(t,e={incremental:!0}){return this._match(this._getStartExpr(t),{incremental:e.incremental,tracing:!0})}_match(t,e={}){let r={tracing:!1,incremental:!0,positionToRecordFailures:void 0,...e};if(!r.incremental)this._resetMemoTable();else if(this._isMemoTableStale&&!this.grammar.supportsIncrementalParsing)throw ds(this.grammar);let n=new Ce(this,t,r.positionToRecordFailures);return r.tracing?n.getTrace():n.getMatchResult()}_getStartExpr(t){let e=t||this.grammar.defaultStartRule;if(!e)throw new Error("Missing start rule argument -- the grammar has no default start rule.");let r=this.grammar.parseApplication(e);return new A([r,F])}},gt=[],Wt=(s,t)=>Object.prototype.hasOwnProperty.call(s,t),Ht=class{constructor(t,e,r){this._node=t,this.source=e,this._baseInterval=r,t.isNonterminal()&&X(e===r),this._childWrappers=[]}_forgetMemoizedResultFor(t){delete this._node[this._semantics.attributeKeys[t]],this.children.forEach(e=>{e._forgetMemoizedResultFor(t)})}child(t){if(!(0<=t&&t<this._node.numChildren()))return;let e=this._childWrappers[t];if(!e){let r=this._node.childAt(t),n=this._node.childOffsets[t],i=this._baseInterval.subInterval(n,r.matchLength),o=r.isNonterminal()?i:this._baseInterval;e=this._childWrappers[t]=this._semantics.wrap(r,i,o)}return e}_children(){for(let t=0;t<this._node.numChildren();t++)this.child(t);return this._childWrappers}isIteration(){return this._node.isIteration()}isTerminal(){return this._node.isTerminal()}isNonterminal(){return this._node.isNonterminal()}isSyntactic(){return this.isNonterminal()&&this._node.isSyntactic()}isLexical(){return this.isNonterminal()&&this._node.isLexical()}isOptional(){return this._node.isOptional()}iteration(t){let e=t||[],r=e.map(o=>o._node),n=new zt(r,[],-1,!1),i=this._semantics.wrap(n,null,null);return i._childWrappers=e,i}get children(){return this._children()}get ctorName(){return this._node.ctorName}get numChildren(){return this._node.numChildren()}get sourceString(){return this.source.contents}},q=class{constructor(t,e){let r=this;if(this.grammar=t,this.checkedActionDicts=!1,this.Wrapper=class extends(e?e.Wrapper:Ht){constructor(n,i,o){super(n,i,o);r.checkActionDictsIfHaventAlready(),this._semantics=r}toString(){return"[semantics wrapper for "+r.grammar.name+"]"}},this.super=e,e){if(!(t.equals(this.super.grammar)||t._inheritsFrom(this.super.grammar)))throw new Error("Cannot extend a semantics for grammar '"+this.super.grammar.name+"' for use with grammar '"+t.name+"' (not a sub-grammar)");this.operations=Object.create(this.super.operations),this.attributes=Object.create(this.super.attributes),this.attributeKeys=Object.create(null);for(let n in this.attributes)Object.defineProperty(this.attributeKeys,n,{value:Pe(n)})}else this.operations=Object.create(null),this.attributes=Object.create(null),this.attributeKeys=Object.create(null)}toString(){return"[semantics for "+this.grammar.name+"]"}checkActionDictsIfHaventAlready(){this.checkedActionDicts||(this.checkActionDicts(),this.checkedActionDicts=!0)}checkActionDicts(){let t;for(t in this.operations)this.operations[t].checkActionDict(this.grammar);for(t in this.attributes)this.attributes[t].checkActionDict(this.grammar)}toRecipe(t){function e(n){return n.super!==q.BuiltInSemantics._getSemantics()}let r=`(function(g) {
`;if(e(this)){r+="  var semantics = "+this.super.toRecipe(!0)+"(g";let n=this.super.grammar,i=this.grammar;for(;i!==n;)r+=".superGrammar",i=i.superGrammar;r+=`);
`,r+="  return g.extendSemantics(semantics)"}else r+="  return g.createSemantics()";return["Operation","Attribute"].forEach(n=>{let i=this[n.toLowerCase()+"s"];Object.keys(i).forEach(o=>{let{actionDict:a,formals:u,builtInDefault:h}=i[o],c=o;u.length>0&&(c+="("+u.join(", ")+")");let d;e(this)&&this.super[n.toLowerCase()+"s"][o]?d="extend"+n:d="add"+n,r+=`
    .`+d+"("+JSON.stringify(c)+", {";let f=[];Object.keys(a).forEach(m=>{if(a[m]!==h){let y=a[m].toString().trim();y=y.replace(/^.*\(/,"function("),f.push(`
      `+JSON.stringify(m)+": "+y)}}),r+=f.join(",")+`
    })`})}),r+=`;
  })`,t||(r=`(function() {
  var grammar = this.fromRecipe(`+this.grammar.toRecipe()+`);
  var semantics = `+r+`(grammar);
  return semantics;
});
`),r}addOperationOrAttribute(t,e,r){let n=t+"s",i=Te(e,t),{name:o}=i,{formals:a}=i;this.assertNewName(o,t);let u=qs(t,o,d),h={_default:u};Object.keys(r).forEach(f=>{h[f]=r[f]});let c=t==="operation"?new at(o,a,h,u):new bt(o,h,u);c.checkActionDict(this.grammar),this[n][o]=c;function d(...f){let m=this._semantics[n][o];if(arguments.length!==m.formals.length)throw new Error("Invalid number of arguments passed to "+o+" "+t+" (expected "+m.formals.length+", got "+arguments.length+")");let y=Object.create(null);for(let[Q,ut]of Object.entries(f)){let ss=m.formals[Q];y[ss]=ut}let x=this.args;this.args=y;let S=m.execute(this._semantics,this);return this.args=x,S}t==="operation"?(this.Wrapper.prototype[o]=d,this.Wrapper.prototype[o].toString=function(){return"["+o+" operation]"}):(Object.defineProperty(this.Wrapper.prototype,o,{get:d,configurable:!0}),Object.defineProperty(this.attributeKeys,o,{value:Pe(o)}))}extendOperationOrAttribute(t,e,r){let n=t+"s";if(Te(e,"attribute"),!(this.super&&e in this.super[n]))throw new Error("Cannot extend "+t+" '"+e+"': did not inherit an "+t+" with that name");if(Wt(this[n],e))throw new Error("Cannot extend "+t+" '"+e+"' again");let i=this[n][e].formals,o=this[n][e].actionDict,a=Object.create(o);Object.keys(r).forEach(u=>{a[u]=r[u]}),this[n][e]=t==="operation"?new at(e,i,a):new bt(e,a),this[n][e].checkActionDict(this.grammar)}assertNewName(t,e){if(Wt(Ht.prototype,t))throw new Error("Cannot add "+e+" '"+t+"': that's a reserved name");if(t in this.operations)throw new Error("Cannot add "+e+" '"+t+"': an operation with that name already exists");if(t in this.attributes)throw new Error("Cannot add "+e+" '"+t+"': an attribute with that name already exists")}wrap(t,e,r){let n=r||e;return t instanceof this.Wrapper?t:new this.Wrapper(t,e,n)}};function Te(s,t){if(!q.prototypeGrammar)return X(s.indexOf("(")===-1),{name:s,formals:[]};let e=q.prototypeGrammar.match(s,t==="operation"?"OperationSignature":"AttributeSignature");if(e.failed())throw new Error(e.message);return q.prototypeGrammarSemantics(e).parse()}function qs(s,t,e){return function(...r){let i=(this._semantics.operations[t]||this._semantics.attributes[t]).formals.map(o=>this.args[o]);if(!this.isIteration()&&r.length===1)return e.apply(r[0],i);throw As(this.ctorName,t,s,gt)}}q.createSemantics=function(s,t){let e=new q(s,t!==void 0?t:q.BuiltInSemantics._getSemantics()),r=function(i){if(!(i instanceof $t))throw new TypeError("Semantics expected a MatchResult, but got "+kt(i));if(i.failed())throw new TypeError("cannot apply Semantics to "+i.toString());let o=i._cst;if(o.grammar!==s)throw new Error("Cannot use a MatchResult from grammar '"+o.grammar.name+"' with a semantics for '"+s.name+"'");let a=new ft(i.input);return e.wrap(o,a.interval(i._cstOffset,i.input.length))};return r.addOperation=function(n,i){return e.addOperationOrAttribute("operation",n,i),r},r.extendOperation=function(n,i){return e.extendOperationOrAttribute("operation",n,i),r},r.addAttribute=function(n,i){return e.addOperationOrAttribute("attribute",n,i),r},r.extendAttribute=function(n,i){return e.extendOperationOrAttribute("attribute",n,i),r},r._getActionDict=function(n){let i=e.operations[n]||e.attributes[n];if(!i)throw new Error('"'+n+'" is not a valid operation or attribute name in this semantics for "'+s.name+'"');return i.actionDict},r._remove=function(n){let i;return n in e.operations?(i=e.operations[n],delete e.operations[n]):n in e.attributes&&(i=e.attributes[n],delete e.attributes[n]),delete e.Wrapper.prototype[n],i},r.getOperationNames=function(){return Object.keys(e.operations)},r.getAttributeNames=function(){return Object.keys(e.attributes)},r.getGrammar=function(){return e.grammar},r.toRecipe=function(n){return e.toRecipe(n)},r.toString=e.toString.bind(e),r._getSemantics=function(){return e},r};var at=class{constructor(t,e,r,n){this.name=t,this.formals=e,this.actionDict=r,this.builtInDefault=n}checkActionDict(t){t._checkTopDownActionDict(this.typeName,this.name,this.actionDict)}execute(t,e){try{let{ctorName:r}=e._node,n=this.actionDict[r];return n?(gt.push([this,r]),n.apply(e,e._children())):e.isNonterminal()&&(n=this.actionDict._nonterminal,n)?(gt.push([this,"_nonterminal",r]),n.apply(e,e._children())):(gt.push([this,"default action",r]),this.actionDict._default.apply(e,e._children()))}finally{gt.pop()}}};at.prototype.typeName="operation";var bt=class extends at{constructor(t,e,r){super(t,[],e,r)}execute(t,e){let r=e._node,n=t.attributeKeys[this.name];return Wt(r,n)||(r[n]=at.prototype.execute.call(this,t,e)),r[n]}};bt.prototype.typeName="attribute";var De=["_iter","_terminal","_nonterminal","_default"];function Me(s){return Object.keys(s.rules).sort().map(t=>s.rules[t])}var $s=s=>s.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),ke,Be,k=class{constructor(t,e,r,n){if(this.name=t,this.superGrammar=e,this.rules=r,n){if(!(n in r))throw new Error("Invalid start rule: '"+n+"' is not a rule in grammar '"+t+"'");this.defaultStartRule=n}this._matchStateInitializer=void 0,this.supportsIncrementalParsing=!0}matcher(){return new Fe(this)}isBuiltIn(){return this===k.ProtoBuiltInRules||this===k.BuiltInRules}equals(t){if(this===t)return!0;if(t==null||this.name!==t.name||this.defaultStartRule!==t.defaultStartRule||!(this.superGrammar===t.superGrammar||this.superGrammar.equals(t.superGrammar)))return!1;let e=Me(this),r=Me(t);return e.length===r.length&&e.every((n,i)=>n.description===r[i].description&&n.formals.join(",")===r[i].formals.join(",")&&n.body.toString()===r[i].body.toString())}match(t,e){let r=this.matcher();return r.replaceInputRange(0,0,t),r.match(e)}trace(t,e){let r=this.matcher();return r.replaceInputRange(0,0,t),r.trace(e)}createSemantics(){return q.createSemantics(this)}extendSemantics(t){return q.createSemantics(this,t._getSemantics())}_checkTopDownActionDict(t,e,r){let n=[];for(let i in r){let o=r[i];if(!De.includes(i)&&!(i in this.rules)){n.push(`'${i}' is not a valid semantic action for '${this.name}'`);continue}if(typeof o!="function"){n.push(`'${i}' must be a function in an action dictionary for '${this.name}'`);continue}let u=o.length,h=this._topDownActionArity(i);if(u!==h){let c;i==="_iter"||i==="_nonterminal"?c=`it should use a rest parameter, e.g. \`${i}(...children) {}\`. NOTE: this is new in Ohm v16 — see https://ohmjs.org/d/ati for details.`:c=`expected ${h}, got ${u}`,n.push(`Semantic action '${i}' has the wrong arity: ${c}`)}}if(n.length>0){let i=n.map(a=>"- "+a),o=new Error([`Found errors in the action dictionary of the '${e}' ${t}:`,...i].join(`
`));throw o.problems=n,o}}_topDownActionArity(t){return De.includes(t)?0:this.rules[t].body.getArity()}_inheritsFrom(t){let e=this.superGrammar;for(;e;){if(e.equals(t,!0))return!0;e=e.superGrammar}return!1}toRecipe(t=void 0){let e={};this.source&&(e.source=this.source.contents);let r=null;this.defaultStartRule&&(r=this.defaultStartRule);let n={};Object.keys(this.rules).forEach(a=>{let u=this.rules[a],{body:h}=u,c=!this.superGrammar||!this.superGrammar.rules[a],d;c?d="define":d=h instanceof pt?"extend":"override";let f={};if(u.source&&this.source){let x=u.source.relativeTo(this.source);f.sourceInterval=[x.startIdx,x.endIdx]}let m=c?u.description:null,y=h.outputRecipe(u.formals,this.source);n[a]=[d,f,m,u.formals,y]});let i="null";t?i=t:this.superGrammar&&!this.superGrammar.isBuiltIn()&&(i=this.superGrammar.toRecipe());let o=[...["grammar",e,this.name].map(JSON.stringify),i,...[r,n].map(JSON.stringify)];return $s(`[${o.join(",")}]`)}toOperationActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}toAttributeActionDictionaryTemplate(){return this._toOperationOrAttributeActionDictionaryTemplate()}_toOperationOrAttributeActionDictionaryTemplate(){let t=new nt;t.append("{");let e=!0;for(let r in this.rules){let{body:n}=this.rules[r];e?e=!1:t.append(","),t.append(`
`),t.append("  "),this.addSemanticActionTemplate(r,n,t)}return t.append(`
}`),t.contents()}addSemanticActionTemplate(t,e,r){r.append(t),r.append(": function(");let n=this._topDownActionArity(t);r.append(vt("_",n).join(", ")),r.append(`) {
`),r.append("  }")}parseApplication(t){let e;if(t.indexOf("<")===-1)e=new I(t);else{let n=ke.match(t,"Base_application");e=Be(n,{})}if(!(e.ruleName in this.rules))throw ye(e.ruleName,this.name);let{formals:r}=this.rules[e.ruleName];if(r.length!==e.args.length){let{source:n}=this.rules[e.ruleName];throw xe(e.ruleName,r.length,e.args.length,n)}return e}_setUpMatchState(t){this._matchStateInitializer&&this._matchStateInitializer(t)}};k.ProtoBuiltInRules=new k("ProtoBuiltInRules",void 0,{any:{body:C,formals:[],description:"any character",primitive:!0},end:{body:F,formals:[],description:"end of input",primitive:!0},caseInsensitive:{body:new St(new N(0)),formals:["str"],primitive:!0},lower:{body:new L("Ll"),formals:[],description:"a lowercase letter",primitive:!0},upper:{body:new L("Lu"),formals:[],description:"an uppercase letter",primitive:!0},unicodeLtmo:{body:new L("Ltmo"),formals:[],description:"a Unicode character in Lt, Lm, or Lo",primitive:!0},spaces:{body:new Y(new I("space")),formals:[]},space:{body:new O("\0"," "),formals:[],description:"a space"}});k.initApplicationParser=function(s,t){ke=s,Be=t};var Xt=class{constructor(t){this.name=t}sourceInterval(t,e){return this.source.subInterval(t,e-t)}ensureSuperGrammar(){return this.superGrammar||this.withSuperGrammar(this.name==="BuiltInRules"?k.ProtoBuiltInRules:k.BuiltInRules),this.superGrammar}ensureSuperGrammarRuleForOverriding(t,e){let r=this.ensureSuperGrammar().rules[t];if(!r)throw fs(t,this.superGrammar.name,e);return r}installOverriddenOrExtendedRule(t,e,r,n){let i=Dt(e);if(i.length>0)throw Ie(t,i,n);let o=this.ensureSuperGrammar().rules[t],a=o.formals,u=a?a.length:0;if(e.length!==u)throw xe(t,u,e.length,n);return this.install(t,e,r,o.description,n)}install(t,e,r,n,i,o=!1){return this.rules[t]={body:r.introduceParams(e),formals:e,description:n,source:i,primitive:o},this}withSuperGrammar(t){if(this.superGrammar)throw new Error("the super grammar of a GrammarDecl cannot be set more than once");return this.superGrammar=t,this.rules=Object.create(t.rules),t.isBuiltIn()||(this.defaultStartRule=t.defaultStartRule),this}withDefaultStartRule(t){return this.defaultStartRule=t,this}withSource(t){return this.source=new ft(t).interval(0,t.length),this}build(){let t=new k(this.name,this.ensureSuperGrammar(),this.rules,this.defaultStartRule);t._matchStateInitializer=t.superGrammar._matchStateInitializer,t.supportsIncrementalParsing=t.superGrammar.supportsIncrementalParsing;let e=[],r=!1;return Object.keys(t.rules).forEach(n=>{let{body:i}=t.rules[n];try{i.assertChoicesHaveUniformArity(n)}catch(o){e.push(o)}try{i.assertAllApplicationsAreValid(n,t)}catch(o){e.push(o),r=!0}}),r||Object.keys(t.rules).forEach(n=>{let{body:i}=t.rules[n];try{i.assertIteratedExprsAreNotNullable(t,[])}catch(o){e.push(o)}}),e.length>0&&Ps(e),this.source&&(t.source=this.source),t}define(t,e,r,n,i,o){if(this.ensureSuperGrammar(),this.superGrammar.rules[t])throw ve(t,this.name,this.superGrammar.name,i);if(this.rules[t])throw ve(t,this.name,this.name,i);let a=Dt(e);if(a.length>0)throw Ie(t,a,i);return this.install(t,e,r,n,i,o)}override(t,e,r,n,i){return this.ensureSuperGrammarRuleForOverriding(t,i),this.installOverriddenOrExtendedRule(t,e,r,i),this}extend(t,e,r,n,i){if(!this.ensureSuperGrammar().rules[t])throw ms(t,this.superGrammar.name,i);let a=new pt(this.superGrammar,t,r);return a.source=r.source,this.installOverriddenOrExtendedRule(t,e,a,i),this}},yt=class{constructor(){this.currentDecl=null,this.currentRuleName=null}newGrammar(t){return new Xt(t)}grammar(t,e,r,n,i){let o=new Xt(e);return r&&o.withSuperGrammar(r instanceof k?r:this.fromRecipe(r)),n&&o.withDefaultStartRule(n),t&&t.source&&o.withSource(t.source),this.currentDecl=o,Object.keys(i).forEach(a=>{this.currentRuleName=a;let u=i[a],h=u[0],c=u[1],d=u[2],f=u[3],m=this.fromRecipe(u[4]),y;o.source&&c&&c.sourceInterval&&(y=o.source.subInterval(c.sourceInterval[0],c.sourceInterval[1]-c.sourceInterval[0])),o[h](a,f,m,d,y)}),this.currentRuleName=this.currentDecl=null,o.build()}terminal(t){return new P(t)}range(t,e){return new O(t,e)}param(t){return new N(t)}alt(...t){let e=[];for(let r of t)r instanceof v||(r=this.fromRecipe(r)),r instanceof _?e=e.concat(r.terms):e.push(r);return e.length===1?e[0]:new _(e)}seq(...t){let e=[];for(let r of t)r instanceof v||(r=this.fromRecipe(r)),r instanceof A?e=e.concat(r.factors):e.push(r);return e.length===1?e[0]:new A(e)}star(t){return t instanceof v||(t=this.fromRecipe(t)),new Y(t)}plus(t){return t instanceof v||(t=this.fromRecipe(t)),new it(t)}opt(t){return t instanceof v||(t=this.fromRecipe(t)),new V(t)}not(t){return t instanceof v||(t=this.fromRecipe(t)),new D(t)}lookahead(t){return t instanceof v||(t=this.fromRecipe(t)),new M(t)}lex(t){return t instanceof v||(t=this.fromRecipe(t)),new j(t)}app(t,e){return e&&e.length>0&&(e=e.map(function(r){return r instanceof v?r:this.fromRecipe(r)},this)),new I(t,e)}splice(t,e){return new dt(this.currentDecl.superGrammar,this.currentRuleName,t.map(r=>this.fromRecipe(r)),e.map(r=>this.fromRecipe(r)))}fromRecipe(t){let e=t[0]==="grammar"?t.slice(1):t.slice(2),r=this[t[0]](...e),n=t[1];return n&&n.sourceInterval&&this.currentDecl&&r.withSource(this.currentDecl.sourceInterval(...n.sourceInterval)),r}};function Yt(s){return typeof s=="function"?s.call(new yt):(typeof s=="string"&&(s=JSON.parse(s)),new yt().fromRecipe(s))}var Jt=Yt(["grammar",{source:`BuiltInRules {

  alnum  (an alpha-numeric character)
    = letter
    | digit

  letter  (a letter)
    = lower
    | upper
    | unicodeLtmo

  digit  (a digit)
    = "0".."9"

  hexDigit  (a hexadecimal digit)
    = digit
    | "a".."f"
    | "A".."F"

  ListOf<elem, sep>
    = NonemptyListOf<elem, sep>
    | EmptyListOf<elem, sep>

  NonemptyListOf<elem, sep>
    = elem (sep elem)*

  EmptyListOf<elem, sep>
    = /* nothing */

  listOf<elem, sep>
    = nonemptyListOf<elem, sep>
    | emptyListOf<elem, sep>

  nonemptyListOf<elem, sep>
    = elem (sep elem)*

  emptyListOf<elem, sep>
    = /* nothing */

  // Allows a syntactic rule application within a lexical context.
  applySyntactic<app> = app
}`},"BuiltInRules",null,null,{alnum:["define",{sourceInterval:[18,78]},"an alpha-numeric character",[],["alt",{sourceInterval:[60,78]},["app",{sourceInterval:[60,66]},"letter",[]],["app",{sourceInterval:[73,78]},"digit",[]]]],letter:["define",{sourceInterval:[82,142]},"a letter",[],["alt",{sourceInterval:[107,142]},["app",{sourceInterval:[107,112]},"lower",[]],["app",{sourceInterval:[119,124]},"upper",[]],["app",{sourceInterval:[131,142]},"unicodeLtmo",[]]]],digit:["define",{sourceInterval:[146,177]},"a digit",[],["range",{sourceInterval:[169,177]},"0","9"]],hexDigit:["define",{sourceInterval:[181,254]},"a hexadecimal digit",[],["alt",{sourceInterval:[219,254]},["app",{sourceInterval:[219,224]},"digit",[]],["range",{sourceInterval:[231,239]},"a","f"],["range",{sourceInterval:[246,254]},"A","F"]]],ListOf:["define",{sourceInterval:[258,336]},null,["elem","sep"],["alt",{sourceInterval:[282,336]},["app",{sourceInterval:[282,307]},"NonemptyListOf",[["param",{sourceInterval:[297,301]},0],["param",{sourceInterval:[303,306]},1]]],["app",{sourceInterval:[314,336]},"EmptyListOf",[["param",{sourceInterval:[326,330]},0],["param",{sourceInterval:[332,335]},1]]]]],NonemptyListOf:["define",{sourceInterval:[340,388]},null,["elem","sep"],["seq",{sourceInterval:[372,388]},["param",{sourceInterval:[372,376]},0],["star",{sourceInterval:[377,388]},["seq",{sourceInterval:[378,386]},["param",{sourceInterval:[378,381]},1],["param",{sourceInterval:[382,386]},0]]]]],EmptyListOf:["define",{sourceInterval:[392,434]},null,["elem","sep"],["seq",{sourceInterval:[438,438]}]],listOf:["define",{sourceInterval:[438,516]},null,["elem","sep"],["alt",{sourceInterval:[462,516]},["app",{sourceInterval:[462,487]},"nonemptyListOf",[["param",{sourceInterval:[477,481]},0],["param",{sourceInterval:[483,486]},1]]],["app",{sourceInterval:[494,516]},"emptyListOf",[["param",{sourceInterval:[506,510]},0],["param",{sourceInterval:[512,515]},1]]]]],nonemptyListOf:["define",{sourceInterval:[520,568]},null,["elem","sep"],["seq",{sourceInterval:[552,568]},["param",{sourceInterval:[552,556]},0],["star",{sourceInterval:[557,568]},["seq",{sourceInterval:[558,566]},["param",{sourceInterval:[558,561]},1],["param",{sourceInterval:[562,566]},0]]]]],emptyListOf:["define",{sourceInterval:[572,682]},null,["elem","sep"],["seq",{sourceInterval:[685,685]}]],applySyntactic:["define",{sourceInterval:[685,710]},null,["app"],["param",{sourceInterval:[707,710]},0]]}]);k.BuiltInRules=Jt;Ns(k.BuiltInRules);var Zt=Yt(["grammar",{source:`Ohm {

  Grammars
    = Grammar*

  Grammar
    = ident SuperGrammar? "{" Rule* "}"

  SuperGrammar
    = "<:" ident

  Rule
    = ident Formals? ruleDescr? "="  RuleBody  -- define
    | ident Formals?            ":=" OverrideRuleBody  -- override
    | ident Formals?            "+=" RuleBody  -- extend

  RuleBody
    = "|"? NonemptyListOf<TopLevelTerm, "|">

  TopLevelTerm
    = Seq caseName  -- inline
    | Seq

  OverrideRuleBody
    = "|"? NonemptyListOf<OverrideTopLevelTerm, "|">

  OverrideTopLevelTerm
    = "..."  -- superSplice
    | TopLevelTerm

  Formals
    = "<" ListOf<ident, ","> ">"

  Params
    = "<" ListOf<Seq, ","> ">"

  Alt
    = NonemptyListOf<Seq, "|">

  Seq
    = Iter*

  Iter
    = Pred "*"  -- star
    | Pred "+"  -- plus
    | Pred "?"  -- opt
    | Pred

  Pred
    = "~" Lex  -- not
    | "&" Lex  -- lookahead
    | Lex

  Lex
    = "#" Base  -- lex
    | Base

  Base
    = ident Params? ~(ruleDescr? "=" | ":=" | "+=")  -- application
    | oneCharTerminal ".." oneCharTerminal           -- range
    | terminal                                       -- terminal
    | "(" Alt ")"                                    -- paren

  ruleDescr  (a rule description)
    = "(" ruleDescrText ")"

  ruleDescrText
    = (~")" any)*

  caseName
    = "--" (~"\\n" space)* name (~"\\n" space)* ("\\n" | &"}")

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

  ident  (an identifier)
    = name

  terminal
    = "\\"" terminalChar* "\\""

  oneCharTerminal
    = "\\"" terminalChar "\\""

  terminalChar
    = escapeChar
      | ~"\\\\" ~"\\"" ~"\\n" "\\u{0}".."\\u{10FFFF}"

  escapeChar  (an escape sequence)
    = "\\\\\\\\"                                     -- backslash
    | "\\\\\\""                                     -- doubleQuote
    | "\\\\\\'"                                     -- singleQuote
    | "\\\\b"                                      -- backspace
    | "\\\\n"                                      -- lineFeed
    | "\\\\r"                                      -- carriageReturn
    | "\\\\t"                                      -- tab
    | "\\\\u{" hexDigit hexDigit? hexDigit?
             hexDigit? hexDigit? hexDigit? "}"   -- unicodeCodePoint
    | "\\\\u" hexDigit hexDigit hexDigit hexDigit  -- unicodeEscape
    | "\\\\x" hexDigit hexDigit                    -- hexEscape

  space
   += comment

  comment
    = "//" (~"\\n" any)* &("\\n" | end)  -- singleLine
    | "/*" (~"*/" any)* "*/"  -- multiLine

  tokens = token*

  token = caseName | comment | ident | operator | punctuation | terminal | any

  operator = "<:" | "=" | ":=" | "+=" | "*" | "+" | "?" | "~" | "&"

  punctuation = "<" | ">" | "," | "--"
}`},"Ohm",null,"Grammars",{Grammars:["define",{sourceInterval:[9,32]},null,[],["star",{sourceInterval:[24,32]},["app",{sourceInterval:[24,31]},"Grammar",[]]]],Grammar:["define",{sourceInterval:[36,83]},null,[],["seq",{sourceInterval:[50,83]},["app",{sourceInterval:[50,55]},"ident",[]],["opt",{sourceInterval:[56,69]},["app",{sourceInterval:[56,68]},"SuperGrammar",[]]],["terminal",{sourceInterval:[70,73]},"{"],["star",{sourceInterval:[74,79]},["app",{sourceInterval:[74,78]},"Rule",[]]],["terminal",{sourceInterval:[80,83]},"}"]]],SuperGrammar:["define",{sourceInterval:[87,116]},null,[],["seq",{sourceInterval:[106,116]},["terminal",{sourceInterval:[106,110]},"<:"],["app",{sourceInterval:[111,116]},"ident",[]]]],Rule_define:["define",{sourceInterval:[131,181]},null,[],["seq",{sourceInterval:[131,170]},["app",{sourceInterval:[131,136]},"ident",[]],["opt",{sourceInterval:[137,145]},["app",{sourceInterval:[137,144]},"Formals",[]]],["opt",{sourceInterval:[146,156]},["app",{sourceInterval:[146,155]},"ruleDescr",[]]],["terminal",{sourceInterval:[157,160]},"="],["app",{sourceInterval:[162,170]},"RuleBody",[]]]],Rule_override:["define",{sourceInterval:[188,248]},null,[],["seq",{sourceInterval:[188,235]},["app",{sourceInterval:[188,193]},"ident",[]],["opt",{sourceInterval:[194,202]},["app",{sourceInterval:[194,201]},"Formals",[]]],["terminal",{sourceInterval:[214,218]},":="],["app",{sourceInterval:[219,235]},"OverrideRuleBody",[]]]],Rule_extend:["define",{sourceInterval:[255,305]},null,[],["seq",{sourceInterval:[255,294]},["app",{sourceInterval:[255,260]},"ident",[]],["opt",{sourceInterval:[261,269]},["app",{sourceInterval:[261,268]},"Formals",[]]],["terminal",{sourceInterval:[281,285]},"+="],["app",{sourceInterval:[286,294]},"RuleBody",[]]]],Rule:["define",{sourceInterval:[120,305]},null,[],["alt",{sourceInterval:[131,305]},["app",{sourceInterval:[131,170]},"Rule_define",[]],["app",{sourceInterval:[188,235]},"Rule_override",[]],["app",{sourceInterval:[255,294]},"Rule_extend",[]]]],RuleBody:["define",{sourceInterval:[309,362]},null,[],["seq",{sourceInterval:[324,362]},["opt",{sourceInterval:[324,328]},["terminal",{sourceInterval:[324,327]},"|"]],["app",{sourceInterval:[329,362]},"NonemptyListOf",[["app",{sourceInterval:[344,356]},"TopLevelTerm",[]],["terminal",{sourceInterval:[358,361]},"|"]]]]],TopLevelTerm_inline:["define",{sourceInterval:[385,408]},null,[],["seq",{sourceInterval:[385,397]},["app",{sourceInterval:[385,388]},"Seq",[]],["app",{sourceInterval:[389,397]},"caseName",[]]]],TopLevelTerm:["define",{sourceInterval:[366,418]},null,[],["alt",{sourceInterval:[385,418]},["app",{sourceInterval:[385,397]},"TopLevelTerm_inline",[]],["app",{sourceInterval:[415,418]},"Seq",[]]]],OverrideRuleBody:["define",{sourceInterval:[422,491]},null,[],["seq",{sourceInterval:[445,491]},["opt",{sourceInterval:[445,449]},["terminal",{sourceInterval:[445,448]},"|"]],["app",{sourceInterval:[450,491]},"NonemptyListOf",[["app",{sourceInterval:[465,485]},"OverrideTopLevelTerm",[]],["terminal",{sourceInterval:[487,490]},"|"]]]]],OverrideTopLevelTerm_superSplice:["define",{sourceInterval:[522,543]},null,[],["terminal",{sourceInterval:[522,527]},"..."]],OverrideTopLevelTerm:["define",{sourceInterval:[495,562]},null,[],["alt",{sourceInterval:[522,562]},["app",{sourceInterval:[522,527]},"OverrideTopLevelTerm_superSplice",[]],["app",{sourceInterval:[550,562]},"TopLevelTerm",[]]]],Formals:["define",{sourceInterval:[566,606]},null,[],["seq",{sourceInterval:[580,606]},["terminal",{sourceInterval:[580,583]},"<"],["app",{sourceInterval:[584,602]},"ListOf",[["app",{sourceInterval:[591,596]},"ident",[]],["terminal",{sourceInterval:[598,601]},","]]],["terminal",{sourceInterval:[603,606]},">"]]],Params:["define",{sourceInterval:[610,647]},null,[],["seq",{sourceInterval:[623,647]},["terminal",{sourceInterval:[623,626]},"<"],["app",{sourceInterval:[627,643]},"ListOf",[["app",{sourceInterval:[634,637]},"Seq",[]],["terminal",{sourceInterval:[639,642]},","]]],["terminal",{sourceInterval:[644,647]},">"]]],Alt:["define",{sourceInterval:[651,685]},null,[],["app",{sourceInterval:[661,685]},"NonemptyListOf",[["app",{sourceInterval:[676,679]},"Seq",[]],["terminal",{sourceInterval:[681,684]},"|"]]]],Seq:["define",{sourceInterval:[689,704]},null,[],["star",{sourceInterval:[699,704]},["app",{sourceInterval:[699,703]},"Iter",[]]]],Iter_star:["define",{sourceInterval:[719,736]},null,[],["seq",{sourceInterval:[719,727]},["app",{sourceInterval:[719,723]},"Pred",[]],["terminal",{sourceInterval:[724,727]},"*"]]],Iter_plus:["define",{sourceInterval:[743,760]},null,[],["seq",{sourceInterval:[743,751]},["app",{sourceInterval:[743,747]},"Pred",[]],["terminal",{sourceInterval:[748,751]},"+"]]],Iter_opt:["define",{sourceInterval:[767,783]},null,[],["seq",{sourceInterval:[767,775]},["app",{sourceInterval:[767,771]},"Pred",[]],["terminal",{sourceInterval:[772,775]},"?"]]],Iter:["define",{sourceInterval:[708,794]},null,[],["alt",{sourceInterval:[719,794]},["app",{sourceInterval:[719,727]},"Iter_star",[]],["app",{sourceInterval:[743,751]},"Iter_plus",[]],["app",{sourceInterval:[767,775]},"Iter_opt",[]],["app",{sourceInterval:[790,794]},"Pred",[]]]],Pred_not:["define",{sourceInterval:[809,824]},null,[],["seq",{sourceInterval:[809,816]},["terminal",{sourceInterval:[809,812]},"~"],["app",{sourceInterval:[813,816]},"Lex",[]]]],Pred_lookahead:["define",{sourceInterval:[831,852]},null,[],["seq",{sourceInterval:[831,838]},["terminal",{sourceInterval:[831,834]},"&"],["app",{sourceInterval:[835,838]},"Lex",[]]]],Pred:["define",{sourceInterval:[798,862]},null,[],["alt",{sourceInterval:[809,862]},["app",{sourceInterval:[809,816]},"Pred_not",[]],["app",{sourceInterval:[831,838]},"Pred_lookahead",[]],["app",{sourceInterval:[859,862]},"Lex",[]]]],Lex_lex:["define",{sourceInterval:[876,892]},null,[],["seq",{sourceInterval:[876,884]},["terminal",{sourceInterval:[876,879]},"#"],["app",{sourceInterval:[880,884]},"Base",[]]]],Lex:["define",{sourceInterval:[866,903]},null,[],["alt",{sourceInterval:[876,903]},["app",{sourceInterval:[876,884]},"Lex_lex",[]],["app",{sourceInterval:[899,903]},"Base",[]]]],Base_application:["define",{sourceInterval:[918,979]},null,[],["seq",{sourceInterval:[918,963]},["app",{sourceInterval:[918,923]},"ident",[]],["opt",{sourceInterval:[924,931]},["app",{sourceInterval:[924,930]},"Params",[]]],["not",{sourceInterval:[932,963]},["alt",{sourceInterval:[934,962]},["seq",{sourceInterval:[934,948]},["opt",{sourceInterval:[934,944]},["app",{sourceInterval:[934,943]},"ruleDescr",[]]],["terminal",{sourceInterval:[945,948]},"="]],["terminal",{sourceInterval:[951,955]},":="],["terminal",{sourceInterval:[958,962]},"+="]]]]],Base_range:["define",{sourceInterval:[986,1041]},null,[],["seq",{sourceInterval:[986,1022]},["app",{sourceInterval:[986,1001]},"oneCharTerminal",[]],["terminal",{sourceInterval:[1002,1006]},".."],["app",{sourceInterval:[1007,1022]},"oneCharTerminal",[]]]],Base_terminal:["define",{sourceInterval:[1048,1106]},null,[],["app",{sourceInterval:[1048,1056]},"terminal",[]]],Base_paren:["define",{sourceInterval:[1113,1168]},null,[],["seq",{sourceInterval:[1113,1124]},["terminal",{sourceInterval:[1113,1116]},"("],["app",{sourceInterval:[1117,1120]},"Alt",[]],["terminal",{sourceInterval:[1121,1124]},")"]]],Base:["define",{sourceInterval:[907,1168]},null,[],["alt",{sourceInterval:[918,1168]},["app",{sourceInterval:[918,963]},"Base_application",[]],["app",{sourceInterval:[986,1022]},"Base_range",[]],["app",{sourceInterval:[1048,1056]},"Base_terminal",[]],["app",{sourceInterval:[1113,1124]},"Base_paren",[]]]],ruleDescr:["define",{sourceInterval:[1172,1231]},"a rule description",[],["seq",{sourceInterval:[1210,1231]},["terminal",{sourceInterval:[1210,1213]},"("],["app",{sourceInterval:[1214,1227]},"ruleDescrText",[]],["terminal",{sourceInterval:[1228,1231]},")"]]],ruleDescrText:["define",{sourceInterval:[1235,1266]},null,[],["star",{sourceInterval:[1255,1266]},["seq",{sourceInterval:[1256,1264]},["not",{sourceInterval:[1256,1260]},["terminal",{sourceInterval:[1257,1260]},")"]],["app",{sourceInterval:[1261,1264]},"any",[]]]]],caseName:["define",{sourceInterval:[1270,1338]},null,[],["seq",{sourceInterval:[1285,1338]},["terminal",{sourceInterval:[1285,1289]},"--"],["star",{sourceInterval:[1290,1304]},["seq",{sourceInterval:[1291,1302]},["not",{sourceInterval:[1291,1296]},["terminal",{sourceInterval:[1292,1296]},`
`]],["app",{sourceInterval:[1297,1302]},"space",[]]]],["app",{sourceInterval:[1305,1309]},"name",[]],["star",{sourceInterval:[1310,1324]},["seq",{sourceInterval:[1311,1322]},["not",{sourceInterval:[1311,1316]},["terminal",{sourceInterval:[1312,1316]},`
`]],["app",{sourceInterval:[1317,1322]},"space",[]]]],["alt",{sourceInterval:[1326,1337]},["terminal",{sourceInterval:[1326,1330]},`
`],["lookahead",{sourceInterval:[1333,1337]},["terminal",{sourceInterval:[1334,1337]},"}"]]]]],name:["define",{sourceInterval:[1342,1382]},"a name",[],["seq",{sourceInterval:[1363,1382]},["app",{sourceInterval:[1363,1372]},"nameFirst",[]],["star",{sourceInterval:[1373,1382]},["app",{sourceInterval:[1373,1381]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[1386,1418]},null,[],["alt",{sourceInterval:[1402,1418]},["terminal",{sourceInterval:[1402,1405]},"_"],["app",{sourceInterval:[1412,1418]},"letter",[]]]],nameRest:["define",{sourceInterval:[1422,1452]},null,[],["alt",{sourceInterval:[1437,1452]},["terminal",{sourceInterval:[1437,1440]},"_"],["app",{sourceInterval:[1447,1452]},"alnum",[]]]],ident:["define",{sourceInterval:[1456,1489]},"an identifier",[],["app",{sourceInterval:[1485,1489]},"name",[]]],terminal:["define",{sourceInterval:[1493,1531]},null,[],["seq",{sourceInterval:[1508,1531]},["terminal",{sourceInterval:[1508,1512]},'"'],["star",{sourceInterval:[1513,1526]},["app",{sourceInterval:[1513,1525]},"terminalChar",[]]],["terminal",{sourceInterval:[1527,1531]},'"']]],oneCharTerminal:["define",{sourceInterval:[1535,1579]},null,[],["seq",{sourceInterval:[1557,1579]},["terminal",{sourceInterval:[1557,1561]},'"'],["app",{sourceInterval:[1562,1574]},"terminalChar",[]],["terminal",{sourceInterval:[1575,1579]},'"']]],terminalChar:["define",{sourceInterval:[1583,1660]},null,[],["alt",{sourceInterval:[1602,1660]},["app",{sourceInterval:[1602,1612]},"escapeChar",[]],["seq",{sourceInterval:[1621,1660]},["not",{sourceInterval:[1621,1626]},["terminal",{sourceInterval:[1622,1626]},"\\"]],["not",{sourceInterval:[1627,1632]},["terminal",{sourceInterval:[1628,1632]},'"']],["not",{sourceInterval:[1633,1638]},["terminal",{sourceInterval:[1634,1638]},`
`]],["range",{sourceInterval:[1639,1660]},"\0","􏿿"]]]],escapeChar_backslash:["define",{sourceInterval:[1703,1758]},null,[],["terminal",{sourceInterval:[1703,1709]},"\\\\"]],escapeChar_doubleQuote:["define",{sourceInterval:[1765,1822]},null,[],["terminal",{sourceInterval:[1765,1771]},'\\"']],escapeChar_singleQuote:["define",{sourceInterval:[1829,1886]},null,[],["terminal",{sourceInterval:[1829,1835]},"\\'"]],escapeChar_backspace:["define",{sourceInterval:[1893,1948]},null,[],["terminal",{sourceInterval:[1893,1898]},"\\b"]],escapeChar_lineFeed:["define",{sourceInterval:[1955,2009]},null,[],["terminal",{sourceInterval:[1955,1960]},"\\n"]],escapeChar_carriageReturn:["define",{sourceInterval:[2016,2076]},null,[],["terminal",{sourceInterval:[2016,2021]},"\\r"]],escapeChar_tab:["define",{sourceInterval:[2083,2132]},null,[],["terminal",{sourceInterval:[2083,2088]},"\\t"]],escapeChar_unicodeCodePoint:["define",{sourceInterval:[2139,2243]},null,[],["seq",{sourceInterval:[2139,2221]},["terminal",{sourceInterval:[2139,2145]},"\\u{"],["app",{sourceInterval:[2146,2154]},"hexDigit",[]],["opt",{sourceInterval:[2155,2164]},["app",{sourceInterval:[2155,2163]},"hexDigit",[]]],["opt",{sourceInterval:[2165,2174]},["app",{sourceInterval:[2165,2173]},"hexDigit",[]]],["opt",{sourceInterval:[2188,2197]},["app",{sourceInterval:[2188,2196]},"hexDigit",[]]],["opt",{sourceInterval:[2198,2207]},["app",{sourceInterval:[2198,2206]},"hexDigit",[]]],["opt",{sourceInterval:[2208,2217]},["app",{sourceInterval:[2208,2216]},"hexDigit",[]]],["terminal",{sourceInterval:[2218,2221]},"}"]]],escapeChar_unicodeEscape:["define",{sourceInterval:[2250,2309]},null,[],["seq",{sourceInterval:[2250,2291]},["terminal",{sourceInterval:[2250,2255]},"\\u"],["app",{sourceInterval:[2256,2264]},"hexDigit",[]],["app",{sourceInterval:[2265,2273]},"hexDigit",[]],["app",{sourceInterval:[2274,2282]},"hexDigit",[]],["app",{sourceInterval:[2283,2291]},"hexDigit",[]]]],escapeChar_hexEscape:["define",{sourceInterval:[2316,2371]},null,[],["seq",{sourceInterval:[2316,2339]},["terminal",{sourceInterval:[2316,2321]},"\\x"],["app",{sourceInterval:[2322,2330]},"hexDigit",[]],["app",{sourceInterval:[2331,2339]},"hexDigit",[]]]],escapeChar:["define",{sourceInterval:[1664,2371]},"an escape sequence",[],["alt",{sourceInterval:[1703,2371]},["app",{sourceInterval:[1703,1709]},"escapeChar_backslash",[]],["app",{sourceInterval:[1765,1771]},"escapeChar_doubleQuote",[]],["app",{sourceInterval:[1829,1835]},"escapeChar_singleQuote",[]],["app",{sourceInterval:[1893,1898]},"escapeChar_backspace",[]],["app",{sourceInterval:[1955,1960]},"escapeChar_lineFeed",[]],["app",{sourceInterval:[2016,2021]},"escapeChar_carriageReturn",[]],["app",{sourceInterval:[2083,2088]},"escapeChar_tab",[]],["app",{sourceInterval:[2139,2221]},"escapeChar_unicodeCodePoint",[]],["app",{sourceInterval:[2250,2291]},"escapeChar_unicodeEscape",[]],["app",{sourceInterval:[2316,2339]},"escapeChar_hexEscape",[]]]],space:["extend",{sourceInterval:[2375,2394]},null,[],["app",{sourceInterval:[2387,2394]},"comment",[]]],comment_singleLine:["define",{sourceInterval:[2412,2458]},null,[],["seq",{sourceInterval:[2412,2443]},["terminal",{sourceInterval:[2412,2416]},"//"],["star",{sourceInterval:[2417,2429]},["seq",{sourceInterval:[2418,2427]},["not",{sourceInterval:[2418,2423]},["terminal",{sourceInterval:[2419,2423]},`
`]],["app",{sourceInterval:[2424,2427]},"any",[]]]],["lookahead",{sourceInterval:[2430,2443]},["alt",{sourceInterval:[2432,2442]},["terminal",{sourceInterval:[2432,2436]},`
`],["app",{sourceInterval:[2439,2442]},"end",[]]]]]],comment_multiLine:["define",{sourceInterval:[2465,2501]},null,[],["seq",{sourceInterval:[2465,2487]},["terminal",{sourceInterval:[2465,2469]},"/*"],["star",{sourceInterval:[2470,2482]},["seq",{sourceInterval:[2471,2480]},["not",{sourceInterval:[2471,2476]},["terminal",{sourceInterval:[2472,2476]},"*/"]],["app",{sourceInterval:[2477,2480]},"any",[]]]],["terminal",{sourceInterval:[2483,2487]},"*/"]]],comment:["define",{sourceInterval:[2398,2501]},null,[],["alt",{sourceInterval:[2412,2501]},["app",{sourceInterval:[2412,2443]},"comment_singleLine",[]],["app",{sourceInterval:[2465,2487]},"comment_multiLine",[]]]],tokens:["define",{sourceInterval:[2505,2520]},null,[],["star",{sourceInterval:[2514,2520]},["app",{sourceInterval:[2514,2519]},"token",[]]]],token:["define",{sourceInterval:[2524,2600]},null,[],["alt",{sourceInterval:[2532,2600]},["app",{sourceInterval:[2532,2540]},"caseName",[]],["app",{sourceInterval:[2543,2550]},"comment",[]],["app",{sourceInterval:[2553,2558]},"ident",[]],["app",{sourceInterval:[2561,2569]},"operator",[]],["app",{sourceInterval:[2572,2583]},"punctuation",[]],["app",{sourceInterval:[2586,2594]},"terminal",[]],["app",{sourceInterval:[2597,2600]},"any",[]]]],operator:["define",{sourceInterval:[2604,2669]},null,[],["alt",{sourceInterval:[2615,2669]},["terminal",{sourceInterval:[2615,2619]},"<:"],["terminal",{sourceInterval:[2622,2625]},"="],["terminal",{sourceInterval:[2628,2632]},":="],["terminal",{sourceInterval:[2635,2639]},"+="],["terminal",{sourceInterval:[2642,2645]},"*"],["terminal",{sourceInterval:[2648,2651]},"+"],["terminal",{sourceInterval:[2654,2657]},"?"],["terminal",{sourceInterval:[2660,2663]},"~"],["terminal",{sourceInterval:[2666,2669]},"&"]]],punctuation:["define",{sourceInterval:[2673,2709]},null,[],["alt",{sourceInterval:[2687,2709]},["terminal",{sourceInterval:[2687,2690]},"<"],["terminal",{sourceInterval:[2693,2696]},">"],["terminal",{sourceInterval:[2699,2702]},","],["terminal",{sourceInterval:[2705,2709]},"--"]]]}]),Qt=Object.create(v.prototype);function je(s,t){for(let e in s)if(e===t)return!0;return!1}function Ge(s,t,e){let r=new yt,n,i,o,a=!1;return(e||Zt).createSemantics().addOperation("visit",{Grammars(c){return c.children.map(d=>d.visit())},Grammar(c,d,f,m,y){let x=c.visit();n=r.newGrammar(x),d.child(0)&&d.child(0).visit(),m.children.map(Q=>Q.visit());let S=n.build();if(S.source=this.source.trimmed(),je(t,x))throw ps(S);return t[x]=S,S},SuperGrammar(c,d){let f=d.visit();if(f==="null")n.withSuperGrammar(null);else{if(!t||!je(t,f))throw hs(f,t,d.source);n.withSuperGrammar(t[f])}},Rule_define(c,d,f,m,y){i=c.visit(),o=d.children.map(ut=>ut.visit())[0]||[],!n.defaultStartRule&&n.ensureSuperGrammar()!==k.ProtoBuiltInRules&&n.withDefaultStartRule(i);let x=y.visit(),S=f.children.map(ut=>ut.visit())[0],Q=this.source.trimmed();return n.define(i,o,x,S,Q)},Rule_override(c,d,f,m){i=c.visit(),o=d.children.map(S=>S.visit())[0]||[];let y=this.source.trimmed();n.ensureSuperGrammarRuleForOverriding(i,y),a=!0;let x=m.visit();return a=!1,n.override(i,o,x,null,y)},Rule_extend(c,d,f,m){i=c.visit(),o=d.children.map(S=>S.visit())[0]||[];let y=m.visit(),x=this.source.trimmed();return n.extend(i,o,y,null,x)},RuleBody(c,d){return r.alt(...d.visit()).withSource(this.source)},OverrideRuleBody(c,d){let f=d.visit(),m=f.indexOf(Qt);if(m>=0){let y=f.slice(0,m),x=f.slice(m+1);return x.forEach(S=>{if(S===Qt)throw bs(S)}),new dt(n.superGrammar,i,y,x).withSource(this.source)}else return r.alt(...f).withSource(this.source)},Formals(c,d,f){return d.visit()},Params(c,d,f){return d.visit()},Alt(c){return r.alt(...c.visit()).withSource(this.source)},TopLevelTerm_inline(c,d){let f=i+"_"+d.visit(),m=c.visit(),y=this.source.trimmed(),x=!(n.superGrammar&&n.superGrammar.rules[f]);a&&!x?n.override(f,o,m,null,y):n.define(f,o,m,null,y);let S=o.map(Q=>r.app(Q));return r.app(f,S).withSource(m.source)},OverrideTopLevelTerm_superSplice(c){return Qt},Seq(c){return r.seq(...c.children.map(d=>d.visit())).withSource(this.source)},Iter_star(c,d){return r.star(c.visit()).withSource(this.source)},Iter_plus(c,d){return r.plus(c.visit()).withSource(this.source)},Iter_opt(c,d){return r.opt(c.visit()).withSource(this.source)},Pred_not(c,d){return r.not(d.visit()).withSource(this.source)},Pred_lookahead(c,d){return r.lookahead(d.visit()).withSource(this.source)},Lex_lex(c,d){return r.lex(d.visit()).withSource(this.source)},Base_application(c,d){let f=d.children.map(m=>m.visit())[0]||[];return r.app(c.visit(),f).withSource(this.source)},Base_range(c,d,f){return r.range(c.visit(),f.visit()).withSource(this.source)},Base_terminal(c){return r.terminal(c.visit()).withSource(this.source)},Base_paren(c,d,f){return d.visit()},ruleDescr(c,d,f){return d.visit()},ruleDescrText(c){return this.sourceString.trim()},caseName(c,d,f,m,y){return f.visit()},name(c,d){return this.sourceString},nameFirst(c){},nameRest(c){},terminal(c,d,f){return d.children.map(m=>m.visit()).join("")},oneCharTerminal(c,d,f){return d.visit()},escapeChar(c){try{return ge(this.sourceString)}catch(d){throw d instanceof RangeError&&d.message.startsWith("Invalid code point ")?ws(c):d}},NonemptyListOf(c,d,f){return[c.visit()].concat(f.children.map(m=>m.visit()))},EmptyListOf(){return[]},_terminal(){return this.sourceString}})(s).visit()}var Ks=Yt(["grammar",{source:`OperationsAndAttributes {

  AttributeSignature =
    name

  OperationSignature =
    name Formals?

  Formals
    = "(" ListOf<name, ","> ")"

  name  (a name)
    = nameFirst nameRest*

  nameFirst
    = "_"
    | letter

  nameRest
    = "_"
    | alnum

}`},"OperationsAndAttributes",null,"AttributeSignature",{AttributeSignature:["define",{sourceInterval:[29,58]},null,[],["app",{sourceInterval:[54,58]},"name",[]]],OperationSignature:["define",{sourceInterval:[62,100]},null,[],["seq",{sourceInterval:[87,100]},["app",{sourceInterval:[87,91]},"name",[]],["opt",{sourceInterval:[92,100]},["app",{sourceInterval:[92,99]},"Formals",[]]]]],Formals:["define",{sourceInterval:[104,143]},null,[],["seq",{sourceInterval:[118,143]},["terminal",{sourceInterval:[118,121]},"("],["app",{sourceInterval:[122,139]},"ListOf",[["app",{sourceInterval:[129,133]},"name",[]],["terminal",{sourceInterval:[135,138]},","]]],["terminal",{sourceInterval:[140,143]},")"]]],name:["define",{sourceInterval:[147,187]},"a name",[],["seq",{sourceInterval:[168,187]},["app",{sourceInterval:[168,177]},"nameFirst",[]],["star",{sourceInterval:[178,187]},["app",{sourceInterval:[178,186]},"nameRest",[]]]]],nameFirst:["define",{sourceInterval:[191,223]},null,[],["alt",{sourceInterval:[207,223]},["terminal",{sourceInterval:[207,210]},"_"],["app",{sourceInterval:[217,223]},"letter",[]]]],nameRest:["define",{sourceInterval:[227,257]},null,[],["alt",{sourceInterval:[242,257]},["terminal",{sourceInterval:[242,245]},"_"],["app",{sourceInterval:[252,257]},"alnum",[]]]]}]);zs(k.BuiltInRules);Vs(Ks);function zs(s){let t={empty(){return this.iteration()},nonEmpty(e,r,n){return this.iteration([e].concat(n.children))}};q.BuiltInSemantics=q.createSemantics(s,null).addOperation("asIteration",{emptyListOf:t.empty,nonemptyListOf:t.nonEmpty,EmptyListOf:t.empty,NonemptyListOf:t.nonEmpty})}function Vs(s){q.prototypeGrammarSemantics=s.createSemantics().addOperation("parse",{AttributeSignature(t){return{name:t.parse(),formals:[]}},OperationSignature(t,e){return{name:t.parse(),formals:e.children.map(r=>r.parse())[0]||[]}},Formals(t,e,r){return e.asIteration().children.map(n=>n.parse())},name(t,e){return this.sourceString}}),q.prototypeGrammar=s}function Us(s){let t=0,e=[0],r=()=>e[e.length-1],n={},i=/( *).*(?:$|\r?\n|\r)/g,o;for(;(o=i.exec(s))!=null;){let[a,u]=o;if(a.length===0)break;let h=u.length,c=r(),d=t+h;if(h>c)e.push(h),n[d]=1;else if(h<c){let f=e.length;for(;r()!==h;)e.pop();n[d]=-1*(f-e.length)}t+=a.length}return e.length>1&&(n[t]=1-e.length),n}var qe="an indented block",$e="a dedent",Ke=1114111+1,ze=class extends ft{constructor(t){super(t.input);this.state=t}_indentationAt(t){return this.state.userData[t]||0}atEnd(){return super.atEnd()&&this._indentationAt(this.pos)===0}next(){if(this._indentationAt(this.pos)!==0){this.examinedLength=Math.max(this.examinedLength,this.pos);return}return super.next()}nextCharCode(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),Ke):super.nextCharCode()}nextCodePoint(){return this._indentationAt(this.pos)!==0?(this.examinedLength=Math.max(this.examinedLength,this.pos),Ke):super.nextCodePoint()}},te=class extends v{constructor(t=!0){super();this.isIndent=t}allowsSkippingPrecedingSpace(){return!0}eval(t){let{inputStream:e}=t,r=t.userData;t.doNotMemoize=!0;let n=e.pos,i=this.isIndent?1:-1;return(r[n]||0)*i>0?(t.userData=Object.create(r),t.userData[n]-=i,t.pushBinding(new J(0),n),!0):(t.processFailure(n,this),!1)}getArity(){return 1}_assertAllApplicationsAreValid(t,e){}_isNullable(t,e){return!1}assertChoicesHaveUniformArity(t){}assertIteratedExprsAreNotNullable(t){}introduceParams(t){return this}substituteParams(t){return this}toString(){return this.isIndent?"indent":"dedent"}toDisplayString(){return this.toString()}toFailure(t){let e=this.isIndent?qe:$e;return new G(this,e,"description")}},Ws=new I("indent"),Hs=new I("dedent"),Xs=new dt(Jt,"any",[Ws,Hs],[]),Ys=new yt().newGrammar("IndentationSensitive").withSuperGrammar(Jt).define("indent",[],new te(!0),qe,void 0,!0).define("dedent",[],new te(!1),$e,void 0,!0).extend("any",[],Xs,"any character",void 0).build();Object.assign(Ys,{_matchStateInitializer(s){s.userData=Us(s.input),s.inputStream=new ze(s)},supportsIncrementalParsing:!1});k.initApplicationParser(Zt,Ge);var Js=s=>!!s.constructor&&typeof s.constructor.isBuffer=="function"&&s.constructor.isBuffer(s);function Zs(s,t){let e=Zt.match(s,"Grammars");if(e.failed())throw cs(e);return Ge(e,t)}function Ve(s,t){let e=Qs(s,t),r=Object.keys(e);if(r.length===0)throw new Error("Missing grammar definition");if(r.length>1){let i=e[r[1]].source;throw new Error(qt(i.sourceString,i.startIdx)+"Found more than one grammar definition -- use ohm.grammars() instead.")}return e[r[0]]}function Qs(s,t){let e=Object.create(t||{});if(typeof s!="string")if(Js(s))s=s.toString();else throw new TypeError("Expected string as first argument, got "+kt(s));return Zs(s,e),e}var Ue=Ve(String.raw`
  Constraints {
    Label = Expr   -- expr
          | ident  -- ident
          | number -- number

    Expr = number ident -- times

    number = digit+ "'" (digit+ "\"")? -- feetAndInches
           | digit+ "\""               -- justInches
           | digit+ ("." digit+)?      -- wholeAndFrac
           | "." digit+                -- onlyFrac

    ident = letter alnum*
  }
`),tr=Ue.createSemantics().addOperation("parse",{Label_expr(s){return{type:"lengthFormula",...s.parse(),label:this.sourceString}},Label_ident(s){return{type:"lengthLabel",name:s.parse()}},Label_number(s){return{type:"lengthConstant",value:s.parse()}},Expr_times(s,t){let e=s.parse(),r=t.parse();return{fn:n=>e*n[r].value,depNames:[r]}},number_feetAndInches(s,t,e,r){let n=parseInt(s.sourceString);return e.numChildren==1&&(n+=parseInt(e.sourceString)/12),n*100},number_justInches(s,t){return parseInt(s.sourceString)*100/12},number_wholeAndFrac(s,t,e){return parseFloat(this.sourceString)},number_onlyFrac(s,t){return parseFloat(this.sourceString)},ident(s,t){return this.sourceString}});function We(s){try{let t=Ue.match(s);return tr(t).parse()}catch(t){return null}}window.parse=We;var He=We;var Xe=0,ee=class{constructor(t){this.id=Xe++,this.pos=t}render(t){t.beginPath(),t.ellipse(this.pos.x,this.pos.y,3,3,0,0,Math.PI*2),t.fill()}};function er(s){let t=document.createElement("input");return t.setAttribute("type","text"),t.contentEditable=!0,t.onchange=()=>{t.value=t.value.toLowerCase(),t.blur()},t.setPos=(e,r)=>{let n=t.getBoundingClientRect();t.style.setProperty("left",`${e-n.width/2}px`),t.style.setProperty("top",`${r-n.height/2}px`)},t.line=s,document.body.appendChild(t),t}var Ye=class{constructor(t,e){this.id=Xe++,this.a=t,this.b=e,this.input=er(this),this.updateInputPos()}render(t,e){t.lineWidth=1,t.strokeStyle=e?"#F81ED5":"#000000",t.beginPath(),t.moveTo(this.a.pos.x,this.a.pos.y),t.lineTo(this.b.pos.x,this.b.pos.y),t.stroke(),this.updateInputPos()}updateInputPos(){this.input.setPos((this.a.pos.x+this.b.pos.x)/2,(this.a.pos.y+this.b.pos.y)/2)}},Je=class{constructor(t){this.a=t,this.b=g.clone(t),this.last_b=g.clone(t),this.velocity=0,this.h_snap,this.v_snap,this.ref_line,this.angle_snap,this.angle_offset,this.len_snap,this.point_snap}update(t,e,r){this.b=t;let n=g.dist(this.last_b,this.b);this.last_b=g.clone(this.b),this.velocity=.05*n+(1-.05)*this.velocity,this.h_snap=!1,this.v_snap=!1,Math.abs(this.a.x-this.b.x)<10&&(this.b.x=this.a.x,this.v_snap=!0),Math.abs(this.a.y-this.b.y)<10&&(this.b.y=this.a.y,this.h_snap=!0);let i=[];this.velocity<1.5&&(e.forEach(a=>{let u=K.getXforY(this,a.pos.y),h=K.getYforX(this,a.pos.x);i.push({type:"horizontal",x:u,y:a.pos.y,snap:a},{type:"vertical",x:a.pos.x,y:h,snap:a})}),this.point_snap=!1,i.forEach(a=>{g.dist(t,a)<10&&(this.b.x=a.x,this.b.y=a.y,this.point_snap=a)}));let o=e.find(a=>g.dist(a.pos,t)<10);if(o&&(this.b=o.pos,this.point_snap={type:"coincident",snap:o}),this.len_snap=!1,this.angle_snap=!1,this.angle_offset=null,r){this.ref_line=r;let a=K.len(K(r.a.pos,r.b.pos)),u=K.len(K(this.a,this.b));Math.abs(a-u)<10&&(this.b=g.add(this.a,g.mulS(g.normalize(g.sub(this.b,this.a)),a)),this.len_snap=!0,u=a);let h=g.sub(this.a,this.b),c=g.sub(r.a.pos,r.b.pos),d=g.angle(h),f=g.angle(c),m=(d-f+360)%360,y=(Math.round(m/90)*90+360)%360;if(Math.abs(m-y)<10){let x=f+y;this.b=g.add(this.a,g.polar(180+x,u)),this.angle_snap=!0,this.angle_offset=y}}}render(t){if(t.lineWidth=1,t.strokeStyle=this.len_snap?"#F81ED5":"#000000",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(this.b.x,this.b.y),t.stroke(),this.h_snap||this.v_snap||this.angle_snap){let e=g.add(this.b,g.mulS(g.sub(this.a,this.b),100)),r=g.add(this.a,g.mulS(g.sub(this.b,this.a),100));t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(r.x,r.y),t.stroke()}if(this.point_snap){let e=g.add(this.b,g.mulS(g.sub(this.point_snap.snap.pos,this.b),100)),r=g.add(this.point_snap.snap.pos,g.mulS(g.sub(this.b,this.point_snap.snap.pos),100));t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(e.x,e.y),t.lineTo(r.x,r.y),t.stroke()}if(this.ref_line){let e=K.len(K(this.ref_line.a.pos,this.ref_line.b.pos)),r=g.normalize(g.sub(this.b,this.a)),n=g.add(this.a,g.mulS(r,1e4)),i=g.mulS(r,e);t.lineWidth=.25,t.strokeStyle="#F81ED5",t.beginPath(),t.moveTo(this.a.x,this.a.y),t.lineTo(n.x,n.y),t.stroke();for(let o=0;o<10;o+=.25){let a=o%1==0?6:3,u=g.mulS(g.rotate90CCW(r),a),h=g.add(this.a,g.mulS(i,o)),c=g.add(h,u),d=g.sub(h,u);t.beginPath(),t.moveTo(c.x,c.y),t.lineTo(d.x,d.y),t.stroke()}}}},Ze=class{constructor(){this.mode="draw",this.wet_stroke=null,this.ref_line=null,this.points=[],this.lines=[],this.snapConstraints=[],this.scribbleConstraints=[]}find_point_near(t){return this.points.find(e=>g.dist(e.pos,t)<10)}find_stroke_near(t){return this.lines.find(e=>K.distToPoint(K(e.a.pos,e.b.pos),t)<20)}begin_stroke(t){let e=this.find_point_near(t);e&&(t=e.pos),this.wet_stroke=new Je(t)}update_stroke(t){this.wet_stroke&&this.wet_stroke.update(t,this.points,this.ref_line)}end_stroke(t){let e=this.find_point_near(this.wet_stroke.a);e||(e=new ee(this.wet_stroke.a)),this.points.push(e);let r=this.find_point_near(this.wet_stroke.b);r||(r=new ee(this.wet_stroke.b)),this.points.push(r);let n=new Ye(e,r);this.lines.push(n),this.snapConstraints.push({type:"minLength",a:n,b:50});let i=this.wet_stroke;i.v_snap&&this.snapConstraints.push({type:"vertical",a:e,b:r}),i.h_snap&&this.snapConstraints.push({type:"horizontal",a:e,b:r}),i.point_snap&&i.point_snap.type!="coincident"&&this.snapConstraints.push({type:i.point_snap.type,a:r,b:i.point_snap.snap}),i.len_snap&&this.snapConstraints.push({type:"length",a:n,b:i.ref_line}),i.angle_snap&&!i.v_snap&&!i.h_snap&&this.snapConstraints.push({type:"angle",a:n,b:i.ref_line,angle:i.angle_offset}),console.log(this.snapConstraints),this.wet_stroke=null}update(t){t.pencil.forEach(e=>{let r=new w(e.x,e.y);if(this.mode==="draw")e.type==="began"?this.begin_stroke(r):e.type==="moved"?this.update_stroke(r):e.type==="ended"&&this.end_stroke(r);else if(this.mode.startsWith("move")){if(e.type==="began"&&(this.dragging=this.find_point_near(r),this.dragging)){let n=new Set([this.dragging]);for(;;){let o=n.size;for(let a of n)for(let u of this.lines)u.a===a?n.add(u.b):u.b===a&&n.add(u.a);if(n.size===o)break}let i=-Infinity;for(let o of n){let a=g.dist(this.dragging.pos,o.pos);a>i&&(i=a,this.fixedPoint=o)}}e.type==="moved"&&this.dragging&&(this.dragging.pos.x=r.x,this.dragging.pos.y=r.y),e.type==="ended"&&(this.dragging=!1,this.fixedPoint=null)}}),Object.entries(t.touches).forEach(([e,r])=>{r.forEach(n=>{let i=new w(n.x,n.y);if(n.type==="began"){let o=this.find_stroke_near(i);this.ref_line===o?this.ref_line=null:(this.ref_line=o,this.finger_down_time=n.timestamp),this.ref_line_id=e,g.dist(new w(40,40),i)<20&&this.toggleModes()}n.type=="ended"&&n.timestamp-this.finger_down_time>1&&(this.ref_line=null)})})}toggleModes(){if(this.mode==="draw")this.mode="move";else if(this.mode==="move")this.mode="move-v2";else if(this.mode==="move-v2"){this.mode="scribble";for(let t of document.body.getElementsByTagName("input"))t.placeholder="...";window.webkit.messageHandlers.messages.postMessage("mgr off")}else{this.scribbleConstraints=[];for(let t of document.body.getElementsByTagName("input")){t.placeholder="",t.blur();let e=He(t.value);e!=null?(e.input=t,this.scribbleConstraints.push(e)):console.log("failed to parse:",t.value)}console.log(this.scribbleConstraints),this.mode="draw",window.webkit.messageHandlers.messages.postMessage("mgr on")}return document.body.className=this.mode,this.mode}render(t){this.lines.forEach(e=>{e.render(t,e===this.ref_line)}),this.points.forEach(e=>{e.render(t)}),this.wet_stroke&&this.wet_stroke.render(t),t.beginPath(),t.ellipse(40,40,20,20,0,0,Math.PI*2),this.mode==="draw"?t.fill():t.stroke(),t.fillText(this.mode,70,40)}},Qe=Ze;var E=new Qe;window.draw=E;var ts=new oe(document.body,s=>{s.clearRect(0,0,window.innerWidth,window.innerHeight),E.render(s)});ts.canvas.addEventListener("touchstart",s=>{E.mode==="scribble"&&s.pageX<=50&&s.pageY<=50&&E.toggleModes()});ne(s=>{E.update(s),sr(),ts.render()});var lt=new ae;window.r=lt;function sr(){let s=rr(lt);for(let t of E.snapConstraints)nr(lt,t);E.snapConstraints=[],ir(lt),lt.iterateForUpToMillis(15),s.forEach(t=>lt.remove(t))}function rr(s){if(!E.mode.startsWith("move")||!E.dragging)return[];let t=[];function e(r){let n=r.pos,i=new Pt(n,new w(n.x,n.y));s.add(i),t.push(i)}return e(E.dragging),E.mode==="move-v2"&&e(E.fixedPoint),t}function nr(s,t){if(t.type==="vertical")s.add(new Nt(t.a.pos,t.b.pos));else if(t.type==="horizontal")s.add(new Ot(t.a.pos,t.b.pos));else if(t.type==="length"){let e=new ot(t.a.a.pos.distanceTo(t.a.b.pos));s.add(new et(t.a.a.pos,t.a.b.pos,e)),s.add(new et(t.b.a.pos,t.b.b.pos,e))}else if(t.type==="minLength")s.add(new Et(t.a.a.pos,t.a.b.pos,t.b));else if(t.type==="angle")s.add(new Ct(t.a.a.pos,t.a.b.pos,t.b.a.pos,t.b.b.pos,Math.PI*t.angle/180));else throw new Error("unsupported snap constraint "+t.type)}var es=[],Z=[];function ir(s){if(E.scribbleConstraints===es)return;console.log("scribble constraints changed!"),Z.forEach(e=>s.remove(e)),Z=[];let t={};E.scribbleConstraints.filter(e=>e.type==="lengthLabel").forEach(e=>{let r=e.input.line,n=new ot(r.a.pos.distanceTo(r.b.pos));n.line=r,Z.push(new et(r.a.pos,r.b.pos,n)),t[e.name]==null&&(t[e.name]=[]),t[e.name].push(n)});for(let e of Object.values(t))e.length>1&&Z.push(new At(...e));E.scribbleConstraints.filter(e=>e.type==="lengthConstant").forEach(e=>{let r=e.input.line,n=new ot(e.value);Z.push(new ht(n,e.value),new et(r.a.pos,r.b.pos,n))}),E.scribbleConstraints.filter(e=>e.type==="lengthFormula").forEach(e=>{let r=e.input.line;if(e.depNames.length!==1)throw new Error("todo");let n=e.depNames[0],i=t[n];if(i==null)return;let o=[r.a,r.b];i.map(c=>c.line).forEach(c=>o.push(c.a,c.b));let u={};u[n]=i[0];let h=new Ft({xs:o,ys:o,vars:i},()=>e.fn(u));Z.push(h),Z.push(new et(r.a.pos,r.b.pos,h))}),es=E.scribbleConstraints,Z.forEach(e=>s.add(e))}
//# sourceMappingURL=main.js.map
